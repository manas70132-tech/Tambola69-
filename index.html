<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Tambola 69 - User</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196f3">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(error => console.log('Service Worker registration failed:', error));
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; color:#222; text-align:center; }
        header { padding:20px; font-size:3em; font-weight:900; color:#ff5722; text-shadow:2px 2px 3px #000; }
        h2 { font-size:2em; color:#2196f3; margin:10px 0; text-shadow:1px 1px 2px #555; }
        .live-number{font-size:32px; color:green; font-weight:800; margin:10px;}
        .viewer-count{font-size:18px; margin:5px;}
        .prize-box{max-width:680px;margin:10px auto;padding:15px;border-radius:12px;background:linear-gradient(135deg,#2b86c5,#784ba0,#ff3cac);color:#fff;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.3);text-align:left;}
        .prize-box span{display:block;margin:4px 0;font-size:16px;}
        .user-ticket{max-width:680px;margin:10px auto;display:none;}
        .ticket-shell{border:3px solid #111;border-radius:12px;display:inline-block;padding:10px;position:relative;background:#fff;}
        .ticket-serial{position:absolute;top:-16px;left:50%;transform:translateX(-50%);background:#fff;padding:4px 8px;border-radius:999px;border:1px solid #111;font-weight:800;}
        .ticket{display:grid;grid-template-columns:repeat(9,1fr);gap:6px;}
        .ticket-cell{padding:10px;border-radius:6px;font-weight:700;cursor:pointer;user-select:none;border:1px solid #333;position:relative;transition:0.2s;background:#fff;}
        .ticket-cell.empty{background:transparent;border-style:dashed;cursor:default;color:transparent;}
        .ticket-cell.ticked::after{content:"✓";position:absolute;top:2px;right:2px;background:green;color:#fff;padding:1px 3px;border-radius:50%;font-weight:900;font-size:10px;pointer-events:none;box-shadow:0 0 2px rgba(0,0,0,0.4);}
        .ticket-cell.buggy{box-shadow:inset 0 0 0 3px rgba(255,0,0,0.12); background:linear-gradient(90deg, rgba(255,200,200,0.4), rgba(255,230,230,0.2));}
        .claim-buttons{margin:10px;}
        .claim-button{background:green;color:#fff;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;margin:4px;font-weight:700;}
        .claimed-box, .winners-box, .next-game-box, .play-friends-box, .history-box{max-width:500px;margin:8px auto;padding:12px;border-radius:12px;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
        .claimed-line{color:red;font-weight:700;}
        .book-ticket, .join-game-button{background:#ff6600;color:#fff;padding:10px 20px;border:none;border-radius:8px;margin:10px;cursor:pointer;font-weight:700;}
        .book-ticket:hover, .join-game-button:hover{background:#e55b00;}
        .next-game-box h3, .play-friends-box h3, .claimed-box h3, .winners-box h3, .history-box h3{margin-bottom:8px;}
        .next-game-info, .friends-info{display:flex;justify-content:space-around;font-weight:700;flex-wrap:wrap;gap:8px;}
        .board{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;max-width:600px;margin:10px auto;}
        .board-cell{padding:8px;border-radius:6px;font-weight:700;background:#ddd;transition:0.3s;}
        .board-cell.black{background:#000;color:#fff;}
        .board-cell.highlight{background:orange !important;}
        .menu{position:fixed;top:12px;right:12px;z-index:9999;}
        .hamburger{width:42px;height:34px;border-radius:10px;border:2px solid #111;background:#fff;display:flex;flex-direction:column;justify-content:space-around;padding:6px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);}
        .hamburger span{height:3px;border-radius:2px;background:#111;}
        .menu-panel{position:fixed;top:56px;right:12px;width:320px;background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;box-shadow:0 8px 16px rgba(0,0,0,0.15);display:none;text-align:left;}
        .menu-panel.show{display:block;}
        .menu-panel h4{margin:4px 0 8px;font-size:18px;}
        .menu-row{margin:8px 0;padding:8px;border:1px dashed #ccc;border-radius:10px;}
        .menu-row strong{font-size:16px;}
        .menu-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
        .menu-btn{background:#111;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700;}
        .menu-btn.secondary{background:#444;}
        .menu-note{font-size:12px;color:#555;margin-top:6px;}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff;color:#000;font-weight:700;font-size:12px;margin-left:6px;}
        .muted{opacity:0.85;font-weight:600;}
        .row{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center;}
        input[type="text"], input[type="tel"], input[type="email"], input[type="number"]{ padding:8px 10px;border:1px solid #ccc;border-radius:8px;min-width:180px;}
        .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:10000;}
        .modal{background:#fff; width:92%; max-width:420px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.3); padding:16px; text-align:left;}
        .modal h3{margin:0 0 8px;}
        .modal label{font-size:14px;font-weight:700;display:block;margin-top:8px;}
        .modal input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-top:6px;}
        .modal .row{display:flex;gap:8px;margin-top:10px;}
        .modal .btn{background:#ff6600;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;}
        .modal .btn.secondary{background:#555;}
        .modal .note{font-size:12px;color:#666;margin-top:6px;}
        .waiting-wrapper{max-width:720px;margin:18px auto;position:relative;}
        .waiting-box{
            background: linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
            border-radius:16px;
            padding:18px 18px 36px 18px;
            box-shadow: 0 12px 30px rgba(20,30,60,0.12);
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(6px) saturate(120%);
            -webkit-backdrop-filter: blur(6px) saturate(120%);
            text-align:center;
            position:relative;
        }
        .waiting-title{font-size:20px;font-weight:900;color:#222;margin:0;}
        .waiting-desc{margin-top:6px;color:#444;font-weight:700;}
        .waiting-latest{margin-top:12px;font-size:28px;font-weight:900;color:#1b5e20;}
        .waiting-live-pill{
            position:absolute;
            left:14px;
            bottom:12px;
            background:linear-gradient(90deg,#0d47a1,#1976d2);
            color:#fff;
            padding:8px 12px;
            border-radius:10px;
            font-weight:900;
            box-shadow:0 6px 18px rgba(25,118,210,0.18);
            display:flex;
            gap:8px;
            align-items:center;
        }
        .waiting-live-pill .dot{width:10px;height:10px;border-radius:50%;background:#00e676;box-shadow:0 0 6px rgba(0,230,118,0.6)}
        @media(max-width:700px){
            .waiting-wrapper{padding:0 12px;}
            .waiting-latest{font-size:20px;}
        }
        .winner-x { color:#ffeb3b; font-weight:900; margin-right:6px; }
        .winner-row { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            gap:8px; 
            padding:6px 0; 
            border-bottom: 1px dashed rgba(255,255,255,0.3);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .winner-row:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .winner-row:last-child { border-bottom: none; }
        .winner-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .winner-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #fff;
        }
        .horiz-prizes {
            max-width: 680px;
            margin: 10px auto;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, #1b5e20, #388e3c, #4caf50);
            color: #fff;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .horiz-prizes h3 {
            margin: 0 0 10px;
        }
        .prize-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        .prize-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .prize-item .prize-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .prize-item .prize-amount {
            font-size: 16px;
            font-weight: 900;
            color: #ffeb3b;
        }
        .view-all-button {
            margin-top: 15px;
            padding: 8px 15px;
            background: #ffc107;
            color: #111;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .game-details-box {
            background-color: #212121;
            color: white;
            padding: 15px;
            margin: 10px auto;
            max-width: 680px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            text-align: left;
        }
        .game-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .game-info-item {
            background-color: #424242;
            padding: 8px;
            border-radius: 6px;
        }
        .claimed-button-text {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            text-decoration: line-through;
            margin-right: 4px;
        }
        .tambola-board-container {
            max-width: 500px;
            margin: 10px auto;
            padding: 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, #1b5e20, #388e3c, #4caf50);
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .tambola-board-container h3 {
            text-align: center;
            margin-bottom: 10px;
        }
        .tambola-board-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 6px;
        }
        .tambola-board-cell {
            padding: 12px 0;
            font-weight: 900;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .tambola-board-cell.drawn {
            background: #000;
            color: #fff;
            border-color: #000;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
        /* --- Updated Animation CSS --- */
        .animation-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            color: #ecf0f1;
            z-index: 9999;
        }
        .animation-ticket {
            width: 90vw;
            max-width: 600px;
            height: 400px;
            background: linear-gradient(135deg, #ffffff, #e0e7ff);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            padding: 20px;
            box-sizing: border-box;
            border: 3px solid #ffd700;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            transform: perspective(1000px) rotateY(0deg);
            opacity: 0;
        }
        .animation-header {
            width: 100%;
            text-align: center;
            color: #1e3a8a;
            font-size: 2em;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .spinner-container {
            position: relative;
            z-index: 10;
            width: 140px;
            height: 140px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 8px solid transparent;
            border-top-color: #ff6b6b;
            border-bottom-color: #4ecdc4;
            animation: spin 1.5s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner-number {
            position: absolute;
            font-size: 2.5em;
            font-weight: 900;
            color: #ff6b6b;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .final-number-spot {
            width: 160px;
            height: 160px;
            border: 4px dashed #ffd700;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
        }
        .final-number {
            font-size: 5em;
            color: #2ecc71;
            font-weight: 900;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(20px) scale(0.5);
        }
        .animation-login-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px;
            padding: 30px;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            opacity: 0;
            display: none;
        }
        .animation-login-box h2 {
            margin-bottom: 25px;
            color: #ecf0f1;
            font-size: 1.8em;
            font-weight: 700;
        }
        .animation-login-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .animation-login-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255,255,255,0.4);
        }
        .google-btn { background-color: #db4437; color: white; }
        .facebook-btn { background-color: #4267B2; color: white; }
        .animation-login-button img { width: 24px; height: 24px; margin-right: 12px; }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ffd700;
            opacity: 0;
        }
        @media (max-width: 500px) {
            .animation-ticket { height: 320px; }
            .animation-header { font-size: 1.5em; }
            .spinner-container { width: 100px; height: 100px; }
            .spinner { width: 80px; height: 80px; border-width: 6px; }
            .spinner-number { font-size: 1.8em; }
            .final-number-spot { width: 120px; height: 120px; }
            .final-number { font-size: 3.5em; }
            .animation-login-box { width: 90%; padding: 20px; }
        }
        .main-game-container {
            display: none;
        }
        .game-over-message {
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
        }
        .slider-container {
            max-width: 720px;
            margin: 0 auto 10px auto;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .slider {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .slide {
            min-width: 100%;
            box-sizing: border-box;
            height: 180px;
            position: relative;
        }
        .slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .slide-text {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .slider-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .dot {
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }
        .dot.active {
            background: #ff5722;
        }
        .profile-upload-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 6px;
            margin-bottom: 15px;
        }
        .profile-upload-row .btn {
            flex-grow: 1;
            padding: 10px 12px;
        }
        .modal input[type="file"] {
            padding: 0;
            border: none;
            width: auto;
        }
    </style>
</head>
<body>

<div class="animation-container" id="animationContainer">
    <div class="animation-ticket" id="animationTicket">
        <div class="animation-header">Welcome to Tambola</div>
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-number">0</div>
        </div>
        <div class="final-number-spot">
            <div class="final-number">69</div>
        </div>
        <div class="footer">Thank you for participating!</div>
    </div>
    <div class="animation-login-box" id="animationLoginBox">
        <h2>Login to Continue</h2>
        <button class="animation-login-button google-btn">
            <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google">
            Sign in with Google
        </button>
        <button class="animation-login-button facebook-btn">
            <img src="https://img.icons8.com/color/48/000000/facebook-new.png" alt="Facebook">
            Sign in with Facebook
        </button>
    </div>
</div>

<div class="main-game-container" id="mainGameContainer">
    <button id="musicBtn" style="position:fixed; top:12px; left:12px; font-size:22px; z-index:10000; background:#fff; color:#111; border:2px solid #111; border-radius:10px; padding:6px 10px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.15);">🎵</button>
    <audio id="liveMusic" autoplay loop></audio>

    <header>Tambola 69</header>

    <div class="slider-container" id="imageSlider">
        <div class="slider" id="sliderTrack">
            <div class="slide">
                <img src="https://via.placeholder.com/720x180/333333/ffffff?text=Loading+Offers..." alt="Loading Slide">
                <div class="slide-text">Loading latest offers...</div>
            </div>
        </div>
        <div class="slider-dots" id="sliderDots"></div>
    </div>
    <h2>Step Into The Excitement!</h2>
    <h4>“We hope luck is always on your side!” 🎉</h4>

    <div class="menu">
        <div class="hamburger" id="menuToggle" aria-label="Options"><span></span><span></span><span></span></div>
    </div>
    <div class="menu-panel" id="menuPanel">
        <h4>Options</h4>
        <div class="menu-row">
            <strong>🏆 Your Winnings: ₹<span id="myWinnings">0</span></strong>
            <div class="menu-note">If you haven't won yet, this shows ₹0.</div>
        </div>
        <div class="menu-row">
            <strong>💸 Cash Withdrawal</strong>
            <div class="menu-actions">
                <button class="menu-btn" id="withdrawBtn">Withdraw Now</button>
                <button class="menu-btn secondary" id="sendUPIBtn">Send UPI/Phone</button>
            </div>
            <div class="menu-note">Enter amount and your UPI or phone. We’ll receive your request instantly.</div>
        </div>
        <div class="menu-row">
            <strong>📣 Share App</strong>
            <div class="menu-actions">
                <button class="menu-btn" id="shareNative">Share</button>
                <button class="menu-btn secondary" id="shareWhatsApp">WhatsApp</button>
                <button class="menu-btn secondary" id="shareFacebook">Facebook</button>
                <button class="menu-btn secondary" id="shareInstagram">Instagram</button>
            </div>
            <div class="menu-note">Invite friends via your favourite app.</div>
        </div>
        <div class="menu-row">
            <strong>👤 User Profile</strong>
            <div class="menu-actions">
                <button class="menu-btn" id="viewProfileBtn">View Profile</button>
            </div>
            <div class="menu-note">See your User ID, Name, Contact & Email.</div>
        </div>
        <div class="menu-row">
            <strong>⚙️ Auto Options</strong>
            <div class="menu-actions">
                <label style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="autoTickToggle" /> Auto-Tick
                </label>
                <label style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="autoClaimToggle" /> Auto-Claim
                </label>
            </div>
            <div class="menu-note">Auto-Tick marks numbers on your ticket as they are drawn. Auto-Claim will submit valid claims automatically.</div>
        </div>
        <div class="menu-row">
            <strong>📜 My History</strong>
            <div class="menu-actions">
                <button class="menu-btn" id="viewHistoryBtn">Game & Payment</button>
            </div>
            <div class="menu-note">View your past game and withdrawal history.</div>
        </div>
        <div class="menu-row">
            <strong>ℹ️ Information</strong>
            <div class="menu-actions">
                <button class="menu-btn" onclick="showStaticPage('about')">About Us</button>
                <button class="menu-btn secondary" onclick="showStaticPage('terms')">Terms & Conditions</button>
                <button class="menu-btn secondary" onclick="showStaticPage('privacy')">Privacy Policy</button>
            </div>
            <div class="menu-note">Read about the app, its terms, and privacy policies.</div>
        </div>
    </div>

    <div class="prize-box">
        <h2> Mega contest </h2>
        <span>Prize list :-</span>
        <span>* Early Five Prize: ₹ 1000</span>
        <span>* Ticket Corner Prize: ₹ 1000</span>
        <span>* Each Line Prize: ₹ 1000</span>
        <span>* Full House Prize: ₹ 5000</span>
        <span># Try Your Luck !</span>
    </div>

    <div class="claimed-box" id="watchLiveBox" style="max-width:600px;margin:10px auto;padding:12px;border-radius:12px;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.1); background: #222;">
        <h3 style="margin-bottom:8px;">🎥 Watch Live Video (Team Video)</h3>
        <div style="text-align:center;">
            <button id="watchLiveBtn" style="padding:10px 20px; font-size:16px; background:#ff4444; color:#fff; border:none; border-radius:8px; cursor:pointer;">
                ▶️ Watch Live
            </button>
            <div id="liveVideoBox" style="margin-top:15px; display:none;">
                <iframe id="liveFrame" width="100%" height="300" src="" title="Tambola 69 Live" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>
        <div style="margin-top:8px; font-size:12px; opacity:0.9;">Tip: Tap "Watch Live" to start the stream inside the app. (Video Classification: Live Draw)</div>
    </div>

    <div class="waiting-wrapper">
        <div class="waiting-box" id="waitingBox">
            <div class="waiting-title" id="waitingTitle">Waiting for Draw...</div>
            <div class="waiting-desc" id="waitingDesc">No active room • Global draw idle</div>
            <div class="waiting-latest" id="latestNumber">—</div>
            <div class="waiting-live-pill" id="waitingLive">
                <div class="dot" id="liveDot"></div>
                <div id="waitingLiveText">Live Users: 0</div>
            </div>
        </div>
    </div>

    <div class="next-game-box" id="nextGameBoxTop">
        <h3>Game Starts In ⏳</h3>
        <div class="next-game-info">
            <div><span id="nextCountdownTop">00:00:00</span><br>Timer</div>
            <div><span id="ticketsLeftTop">0</span><br>Tickets Left</div>
            <div><span id="prizePercentageTop">0%</span><br>Prize %</div>
            <div><span id="TotalSpotTop">100</span><br>Total Spot</div>
        </div>
        <button class="book-ticket" id="buyTicketBtnTop">Buy ₹ 100 💳</button>
    </div>

    <div class="user-ticket" id="userTicketContainer">
        <div class="ticket-shell" id="ticketShell">
            <div id="ticketSerial" class="ticket-serial">#000</div>
            <div id="ticket" class="ticket"></div>
            <div id="gameOverMessage" class="game-over-message" style="display:none;">GAME OVER</div>
        </div>
    </div>

    <div class="claimed-box" id="claimBox">
        <h3>Claim Your Prize 🎁</h3>
        <div class="claim-buttons">
            <button class="claim-button" data-prize="Early Five">Early Five ₹1000</button>
            <button class="claim-button" data-prize="Top Line">Top Line ₹1000</button>
            <button class="claim-button" data-prize="Middle Line">Middle Line ₹1000</button>
            <button class="claim-button" data-prize="Bottom Line">Bottom Line ₹1000</button>
            <button class="claim-button" data-prize="Ticket Corner">Ticket Corner 1000</button>
            <button class="claim-button" data-prize="Full House">Full House ₹5000</button>
        </div>
    </div>
    <div class="tambola-board-container">
        <h3>Tambola Board</h3>
        <div class="tambola-board-grid" id="tambola-board"></div>
    </div>

    <div class="history-box" id="historyBox">
        <h3>Drawn Numbers History</h3>
        <div id="history">None</div>
    </div>

    <div class="next-game-box" id="nextGameBoxBottom">
        <h3>Next Game Starts In ⏳</h3>
        <div class="next-game-info">
            <div><span id="nextCountdownBottom">00:00:00</span><br>Timer</div>
            <div><span id="ticketsLeftBottom">0</span><br>Tickets Left</div>
            <div><span id="prizePercentageBottom">0%</span><br>Prize %</div>
            <div><span id="TotalSpotBottum">100</span><br>Total Spot</div>
        </div>
        <button class="book-ticket" id="buyTicketBtnBottom">Buy ₹ 100 💳</button>
    </div>

    <div class="play-friends-box" id="playFriendsBox">
        <h3>Play With Friends 🎮 <span class="pill" id="roomStatusPill">No Room</span></h3>
        <div class="friends-info">
            <span id="friendsPrizePercentage">Prize %: 0</span>
        </div>
        <div class="row" style="margin-top:8px;">
            <button class="book-ticket" id="createRoomBtn">Create Room</button>
            <button class="join-game-button" id="joinRoomBtn">Join Room</button>
            <input type="text" id="joinRoomIdInput" placeholder="Enter Room ID" />
        </div>
        <div id="priceSelection" style="display:none; margin-top:10px;">
            <label>Select Ticket Price:</label>
            <select id="priceSelect">
                <option value="20">₹20</option>
                <option value="50">₹50</option>
                <option value="100">₹100</option>
                <option value="500">₹500</option>
            </select>
            <button class="book-ticket" id="confirmPriceBtn">Confirm</button>
        </div>
        <span id="roomPriceInfo" class="muted" style="display:none; margin-top:6px;">Ticket Price: ₹<span id="roomPrice">0</span></span>
        <div id="roomInfo" style="margin-top:10px;color:#fff;"></div>
        <div class="row" style="margin-top:10px;">
            <button class="book-ticket" id="roomBuyTicketBtn" style="display:none;">Buy Ticket ₹ 100</button>
            <button class="join-game-button" id="startRoomGameBtn" style="display:none;" disabled>Start Game</button>
        </div>
        <div id="playersList" class="muted" style="margin-top:10px;"></div>
    </div>

    <div class="winners-box" id="winnersBox">
        <h3>Top Winners 🏆</h3>
        <div id="winnerList">Loading winners...</div>
        <button class="view-all-button" onclick="showAllWinners()">View All Winners</button>
    </div>

    <div class="game-details-box" id="userGamesContainer">
        <h3>My Booked Tickets</h3>
        <button id="viewTicketsBtn" class="view-all-button" style="margin-top:8px;">View All Booked Tickets</button>
        <div id="userGamesList" class="game-info-grid" style="display:none; margin-top: 15px;">
            No booked tickets yet.
        </div>
    </div>
</div>
<div class="modal-backdrop" id="withdrawModal" style="display:none;">
    <div class="modal">
        <h3>Request Withdrawal</h3>
        <label>Amount (₹)</label>
        <input id="withdrawAmount" type="number" placeholder="Enter amount" />
        <label>UPI ID or Phone</label>
        <input id="withdrawDest" type="text" placeholder="example@upi or +91XXXXXXXXXX" />
        <div class="row" style="justify-content:flex-end;">
            <button class="btn secondary" id="cancelWithdrawBtn">Cancel</button>
            <button class="btn" id="submitWithdrawBtn">Submit Request</button>
        </div>
        <div class="note">Withdrawal requests will be recorded and admin will be notified (email/SMS) via your server/cloud-function.</div>
    </div>
</div>

<div class="modal-backdrop" id="loginModal">
    <div class="modal">
        <h3>Login with Phone OTP</h3>
        <label>Phone Number (include +91)</label>
        <input id="phoneInput" type="tel" placeholder="+91XXXXXXXXXX" />
        <div id="recaptcha-container" style="margin-top:10px;"></div>
        <div class="row">
            <button class="btn" id="sendOtpBtn">Send OTP</button>
            <button class="btn secondary" id="closeLoginBtn" type="button">Close</button>
        </div>
        <label>Enter OTP</label>
        <input id="otpInput" type="text" placeholder="6-digit code" />
        <button class="btn" id="verifyOtpBtn" style="margin-top:8px;">Verify OTP</button>
        <div id="detailsStep" style="display:none; margin-top:10px;">
            <h3 style="margin-top:12px;">Your Details</h3>
            <label>Name</label>
            <input id="nameInput" type="text" placeholder="Your name" />
            <label>Email</label>
            <input id="emailInput" type="email" placeholder="you@example.com" />
            <button class="btn" id="saveDetailsBtn" style="margin-top:8px;">Save</button>
        </div>
        <div class="note">Note: OTP works on HTTPS or localhost.</div>
    </div>
</div>

<div class="modal-backdrop" id="profileModal" style="display:none;">
    <div class="modal">
        <div id="profileForm" style="display:block;">
            <h3>Create/Update Profile</h3>
            <label>Profile Image (Optional)</label>
            <div class="profile-upload-row">
                <input type="file" id="profileImageUpload" accept="image/*"/>
                <button class="btn" id="uploadProfileImageBtn" type="button" style="background:#2196f3;">
                    Upload ⬆️
                </button>
            </div>
            <label>Name</label>
            <input id="profileNameInput" type="text" placeholder="Your name" />
            <label>Phone Number</label>
            <input id="profileContactInput" type="tel" placeholder="+91XXXXXXXXXX" />
            <label>Email</label>
            <input id="profileEmailInput" type="email" placeholder="you@example.com" />
            <div class="row" style="justify-content:flex-end;">
                <button class="btn secondary" id="closeProfileBtn">Cancel</button>
                <button class="btn" id="saveProfileBtn">Save Profile</button>
            </div>
        </div>
        <div id="profileView" style="display:none;">
            <h3>Your Profile</h3>
            <div style="text-align:center; margin-bottom:12px;">
                <img id="profileImagePreview" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid #ccc;">
            </div>
            <p><strong>Name:</strong> <span id="viewName"></span></p>
            <p><strong>Phone:</strong> <span id="viewPhone"></span></p>
            <p><strong>Email:</strong> <span id="viewEmail"></span></p>
            <div class="row" style="justify-content:flex-end;">
                <button class="btn secondary" id="closeViewProfileBtn">Close</button>
                <button class="btn" id="editProfileBtn">Edit</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="staticPageModal" style="display:none;">
    <div class="modal">
        <div class="row" style="justify-content:space-between; align-items:center;">
            <h3 id="staticPageTitle"></h3>
            <button class="btn secondary" onclick="document.getElementById('staticPageModal').style.display='none';">Close</button>
        </div>
        <div id="staticPageContent" style="margin-top:12px; font-size:14px; color:#444;"></div>
    </div>
</div>
<div class="modal-backdrop" id="winnerProfileModal" style="display:none;">
    <div class="modal">
        <div class="row" style="justify-content:space-between; align-items:center;">
            <h3 id="winnerProfileTitle">Winner's Profile</h3>
            <button class="btn secondary" onclick="document.getElementById('winnerProfileModal').style.display='none';">Close</button>
        </div>
        <div style="text-align:center; margin-bottom:12px;">
            <img id="winnerProfileImage" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid #ccc;">
        </div>
        <p><strong>Name:</strong> <span id="winnerProfileName"></span></p>
        <h4 style="margin-top:15px;">Played Games History</h4>
        <div id="winnerGamesList" style="max-height: 200px; overflow-y: auto;">
            No games played yet.
        </div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<script>
    // Enhanced Animation Function
    function startEnhancedAnimation() {
        const animationContainer = document.getElementById('animationContainer');
        const animationTicket = document.getElementById('animationTicket');
        const spinner = document.querySelector('.spinner');
        const spinnerNumber = document.querySelector('.spinner-number');
        const finalNumber = document.querySelector('.final-number');
        const animationLoginBox = document.getElementById('animationLoginBox');
        const mainGameContainer = document.getElementById('mainGameContainer');

        // Animation Timeline
        const tl = gsap.timeline({
            onComplete: () => {
                // Show login box after animation completes
                gsap.to(animationTicket, { opacity: 0, duration: 0.5 });
                gsap.to(animationLoginBox, {
                    opacity: 1,
                    display: 'block',
                    duration: 0.5,
                    delay: 0.5,
                    ease: 'power2.out'
                });
            }
        });

        // Ticket Entrance Animation
        tl.fromTo(animationTicket, 
            { opacity: 0, scale: 0.5, rotateY: -90, y: 100 },
            { opacity: 1, scale: 1, rotateY: 0, y: 0, duration: 1, ease: 'elastic.out(1, 0.5)' }
        );

        // Header Animation
        tl.from('.animation-header', {
            y: -50,
            opacity: 0,
            duration: 0.8,
            ease: 'power3.out'
        }, '-=0.5');

        // Spinner Animation
        tl.to(spinner, {
            rotation: 720,
            duration: 2,
            ease: 'power2.inOut'
        }, '-=0.5');

        // Spinner Number Counting Animation
        let number = { value: 0 };
        tl.to(number, {
            value: 69,
            duration: 2,
            onUpdate: () => {
                spinnerNumber.textContent = Math.floor(number.value);
            },
            ease: 'power2.inOut'
        }, '-=2');

        // Final Number Spot Animation
        tl.from('.final-number-spot', {
            scale: 0.8,
            opacity: 0,
            duration: 0.8,
            ease: 'back.out(1.7)'
        }, '-=1.5');

        // Final Number Reveal with Bounce
        tl.to('.final-number', {
            opacity: 1,
            y: 0,
            scale: 1,
            duration: 1,
            ease: 'bounce.out'
        }, '-=0.5');

        // Confetti Animation
        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#2ecc71'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * 100}vh`;
                animationContainer.appendChild(confetti);

                gsap.to(confetti, {
                    y: '+=100',
                    x: () => (Math.random() - 0.5) * 200,
                    rotation: () => Math.random() * 360,
                    opacity: 1,
                    duration: 2 + Math.random(),
                    ease: 'power1.out',
                    onComplete: () => confetti.remove()
                });
            }
        }

        // Trigger confetti when final number is revealed
        tl.call(createConfetti, null, '-=0.5');

        // Footer Animation
        tl.from('.footer', {
            y: 50,
            opacity: 0,
            duration: 0.8,
            ease: 'power3.out'
        }, '-=1');

        // Optional: Transition to main game after login (assuming login is handled elsewhere)
        // For demo, let's assume clicking a login button triggers this
        animationLoginBox.querySelectorAll('.animation-login-button').forEach(button => {
            button.addEventListener('click', () => {
                gsap.to(animationContainer, {
                    opacity: 0,
                    duration: 0.5,
                    onComplete: () => {
                        animationContainer.style.display = 'none';
                        mainGameContainer.style.display = 'block';
                        gsap.from(mainGameContainer, {
                            opacity: 0,
                            y: 50,
                            duration: 0.8,
                            ease: 'power2.out'
                        });
                    }
                });
            });
        });
    }

    // This function will render the slider using data from Firebase
    function renderSlider(slidesData, slideIntervalMs) {
        const sliderTrack = document.getElementById('sliderTrack');
        const sliderDotsContainer = document.getElementById('sliderDots');
        if (!sliderTrack || !sliderDotsContainer) return;

        // Clear existing content and auto-slide timer if it exists
        sliderTrack.innerHTML = '';
        sliderDotsContainer.innerHTML = '';
        
        const totalSlides = slidesData.length;
        let currentIndex = 0;
        let autoSlideTimer;

        if (totalSlides === 0) {
            sliderTrack.innerHTML = '<div class="slide" style="min-width:100%; height:180px; display:flex; justify-content:center; align-items:center; background:#eee;">No offers right now!</div>';
            return;
        }

        // 1. Render Slides and Dots
        slidesData.forEach((slide, index) => {
            const slideEl = document.createElement('div');
            slideEl.classList.add('slide');
            
            // Build the core content (image inside a link if linkUrl exists)
            const contentHtml = slide.linkUrl ? 
                `<a href="${slide.linkUrl}" target="_blank" style="display:block; width:100%; height:100%;">
                    <img src="${slide.src}" alt="${slide.title || 'Slide Image'}" ${slide.width ? `width="${slide.width}"` : ''} ${slide.height ? `height="${slide.height}"` : ''}>
                </a>` :
                `<img src="${slide.src}" alt="${slide.title || 'Slide Image'}" ${slide.width ? `width="${slide.width}"` : ''} ${slide.height ? `height="${slide.height}"` : ''}>`;

            slideEl.innerHTML = contentHtml;
            
            // Add overlay text/button if present
            if(slide.title) {
                const textOverlay = document.createElement('div');
                textOverlay.classList.add('slide-text');
                textOverlay.textContent = slide.title;
                slideEl.appendChild(textOverlay);
            }
            if(slide.buttonText && slide.buttonUrl) {
                const buttonOverlay = document.createElement('a');
                buttonOverlay.href = slide.buttonUrl;
                buttonOverlay.target = '_blank';
                buttonOverlay.style.cssText = "position:absolute; top:10px; right:10px; padding:6px 10px; background:#ff6600; color:#fff; border-radius:6px; font-weight:700; z-index:5; text-decoration:none; pointer-events:auto;";
                buttonOverlay.textContent = slide.buttonText;
                slideEl.appendChild(buttonOverlay);
            }

            sliderTrack.appendChild(slideEl);

            // Create Dot Element
            const dot = document.createElement('div');
            dot.classList.add('dot');
            if (index === 0) dot.classList.add('active');
            dot.addEventListener('click', () => moveToSlide(index));
            sliderDotsContainer.appendChild(dot);
        });

        // 2. Sliding Logic
        function updateSlider() {
            const offset = -currentIndex * 100;
            sliderTrack.style.transform = `translateX(${offset}%)`;
            updateDots();
        }

        function updateDots() {
            document.querySelectorAll('#sliderDots .dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === currentIndex);
            });
        }

        function moveToSlide(index) {
            if (index >= 0 && index < totalSlides) {
                currentIndex = index;
                updateSlider();
            }
        }

        // 3. Auto Slide Logic
        function startAutoSlide() {
            clearInterval(autoSlideTimer);
            if (totalSlides > 1 && slideIntervalMs && slideIntervalMs > 0) {
                autoSlideTimer = setInterval(() => {
                    currentIndex = (currentIndex + 1) % totalSlides;
                    updateSlider();
                }, slideIntervalMs);
            }
        }
        
        // Initial render and start
        updateSlider();
        startAutoSlide();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Start the enhanced animation
        startEnhancedAnimation();

        // Firebase Slider Logic
        const sliderRef = firebase.database().ref('slider'); 
        
        // Listen for real-time updates from the Admin Panel
        sliderRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const slidesData = Array.isArray(data.slides) ? data.slides.filter(s => s && s.src) : [];
            const isPlaying = data.isPlaying !== false; 
            const speedMs = data.speedMs || 5000;
            
            if (isPlaying) {
                renderSlider(slidesData, speedMs);
            } else {
                renderSlider(slidesData, 0); 
            }
        });
    });
</script>


<script>
    /* ====================================================== */
    /* 🔥🔥🔥 PASTE YOUR FIREBASE CONFIG HERE 🔥🔥🔥        */
    /* ====================================================== */
    
    const firebaseConfig = {
     apiKey: "AIzaSyAphHTM4faH7_FVXdnootp4NipZd3vtEck",
     authDomain: "tambola69-9dc8f.firebaseapp.com",
     databaseURL: "https://tambola69-9dc8f-default-rtdb.firebaseio.com",
     projectId: "tambola69-9dc8f",
     storageBucket: "tambola69-9dc8f.firebasestorage.app",
     messagingSenderId: "413290158586",
     appId: "1:413290158586:web:c4c6d6d224c96a7487ec43",
     measurementId: "G-TM68JPXH18"
    };
    
    if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase connection successful!");
    } else {
    console.log("Firebase app already running.");
    }
    
    const db = firebase.database();
    const storage = firebase.storage();
    const storageRef = storage.ref();

    /* ================= Elements ================= */
    const tambolaBoardEl = document.getElementById('tambola-board');
    const ticketEl = document.getElementById('ticket');
    const ticketSerialEl = document.getElementById('ticketSerial');
    const historyEl = document.getElementById('history');
    const winnerListEl = document.getElementById('winnerList');
    const userTicketContainer = document.getElementById('userTicketContainer');
    const ticketShellEl = document.getElementById('ticketShell');
    const gameOverMessageEl = document.getElementById('gameOverMessage');

    const waitingTitle = document.getElementById('waitingTitle');
    const waitingDesc = document.getElementById('waitingDesc');
    const latestNumber = document.getElementById('latestNumber');
    const waitingLiveText = document.getElementById('waitingLiveText');
    const liveDot = document.getElementById('liveDot');

    const buyTicketBtnTop = document.getElementById('buyTicketBtnTop');
    const buyTicketBtnBottom = document.getElementById('buyTicketBtnBottom');
    const menuToggle = document.getElementById('menuToggle');
    const menuPanel = document.getElementById('menuPanel');
    const viewProfileBtn = document.getElementById('viewProfileBtn');
    const viewHistoryBtn = document.getElementById('viewHistoryBtn');
    const viewTicketsBtn = document.getElementById('viewTicketsBtn'); // नया बटन

    const withdrawBtn = document.getElementById('withdrawBtn');
    const withdrawModal = document.getElementById('withdrawModal');
    const cancelWithdrawBtn = document.getElementById('cancelWithdrawBtn');
    const submitWithdrawBtn = document.getElementById('submitWithdrawBtn');
    const withdrawAmount = document.getElementById('withdrawAmount');
    const withdrawDest = document.getElementById('withdrawDest');

    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const joinRoomIdInput = document.getElementById('joinRoomIdInput');
    const roomBuyTicketBtn = document.getElementById('roomBuyTicketBtn');
    const startRoomGameBtn = document.getElementById('startRoomGameBtn');
    const roomInfoEl = document.getElementById('roomInfo');
    const playersListEl = document.getElementById('playersList');
    const roomStatusPill = document.getElementById('roomStatusPill');

    const watchLiveBtn = document.getElementById('watchLiveBtn');
    const liveVideoBox = document.getElementById('liveVideoBox');
    const liveFrame = document.getElementById('liveFrame');

    const autoTickToggle = document.getElementById('autoTickToggle');
    const autoClaimToggle = document.getElementById('autoClaimToggle');

    const musicRef = db.ref("music");
    const player = document.getElementById("liveMusic");
    const musicBtn = document.getElementById("musicBtn");
    const currentGameRef = db.ref('currentGame');
    const nextGameRef = db.ref('nextGame');
    const videoRef = db.ref('video');
    const userGamesRef = db.ref('userTickets');
    const claimsRef=db.ref('claims');
    const winnersRef=db.ref('winners');
    const gamePrizesRef = db.ref('gamePrizes'); // Central prize list

    // Add these new element references
    const profileModal = document.getElementById('profileModal');
    const profileForm = document.getElementById('profileForm');
    const profileView = document.getElementById('profileView');
    const closeProfileBtn = document.getElementById('closeProfileBtn');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const profileNameInput = document.getElementById('profileNameInput');
    const profileContactInput = document.getElementById('profileContactInput');
    const profileEmailInput = document.getElementById('profileEmailInput');
    const profileImageUpload = document.getElementById('profileImageUpload');
    const profileImagePreview = document.getElementById('profileImagePreview');
    const viewNameEl = document.getElementById('viewName');
    const viewPhoneEl = document.getElementById('viewPhone');
    const viewEmailEl = document.getElementById('viewEmail');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const closeViewProfileBtn = document.getElementById('closeViewProfileBtn');

    // --- ADDED ---
    const winnerProfileModal = document.getElementById('winnerProfileModal');
    const winnerProfileImage = document.getElementById('winnerProfileImage');
    const winnerProfileName = document.getElementById('winnerProfileName');
    const winnerGamesList = document.getElementById('winnerGamesList');
    // --- END ADDED ---


    // Attach click listeners to all claim buttons
    document.querySelectorAll('.claim-button').forEach(button => {
        button.addEventListener('click', () => {
            const prizeName = button.getAttribute('data-prize');
            if (prizeName) {
                claimPrize(prizeName);
            }
        });
    });

    /* ================= Decorative random box colors ================= */
    const boxes = [
      document.getElementById('claimBox'), document.getElementById('historyBox'), document.getElementById('winnersBox'),
      document.getElementById('nextGameBoxTop'), document.getElementById('nextGameBoxBottom'), document.getElementById('playFriendsBox')
    ];
    boxes.forEach(el=>{
      if(!el) return;
      const h=Math.floor(Math.random()*360);
      const s=60+Math.random()*20;
      const l=45+Math.random()*15;
      el.style.background=`hsl(${h},${s}%,${l}%)`;
    });

    /* ================= Identity / Profile ================= */
    let userId = null;
    let myName = null;
    let myContact = null;
    let myEmail = null;
    let myImageUrl = "https://via.placeholder.com/100";
    let currentTicketSerial = null;
    let currentTicketGameId = null;

    const LS_UID='tambola_user_v2', LS_NAME='tambola_name_v2', LS_CONTACT='tambola_contact_v2', LS_EMAIL='tambola_email_v2', LS_IMAGE='tambola_image_v2';
    const LS_AUTOTICK='tambola_auto_tick_v2', LS_AUTOCLAIM='tambola_auto_claim_v2';
    const LS_TICKET_TICKS_PREFIX = 'tambola_ticket_ticks_v2_';

    function setLocalProfile(id,name,phone,email,image){
      if(id) localStorage.setItem(LS_UID,id);
      if(name) localStorage.setItem(LS_NAME,name);
      if(phone) localStorage.setItem(LS_CONTACT,phone);
      if(email) localStorage.setItem(LS_EMAIL,email);
      if(image) localStorage.setItem(LS_IMAGE,image);
    }
    function loadProfileFromLocal(){
      userId = localStorage.getItem(LS_UID);
      myName = localStorage.getItem(LS_NAME);
      myContact = localStorage.getItem(LS_CONTACT);
      myEmail = localStorage.getItem(LS_EMAIL);
      myImageUrl = localStorage.getItem(LS_IMAGE) || "https://via.placeholder.com/100";
      profileImagePreview.src = myImageUrl;
    }
    function ensureGuest(){
      if(!localStorage.getItem(LS_UID)){
        const gen='u_'+Math.random().toString(36).slice(2,9);
        setLocalProfile(gen,'Guest',null,null,"https://via.placeholder.com/100");
      }
      loadProfileFromLocal();
    }
    autoTickToggle.checked = localStorage.getItem(LS_AUTOTICK) === '1';
    autoClaimToggle.checked = localStorage.getItem(LS_AUTOCLAIM) === '1';
    autoTickToggle.addEventListener('change', ()=> localStorage.setItem(LS_AUTOTICK, autoTickToggle.checked ? '1':'0'));
    autoClaimToggle.addEventListener('change', ()=> localStorage.setItem(LS_AUTOCLAIM, autoClaimToggle.checked ? '1':'0'));

    /* OTP Modal */
    const loginModal = document.getElementById('loginModal');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const closeLoginBtn = document.getElementById('closeLoginBtn');
    const detailsStep = document.getElementById('detailsStep');
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const phoneInput = document.getElementById('phoneInput');
    const otpInput = document.getElementById('otpInput');
    let recaptchaVerifier=null, confirmationResult=null;
    function showLoginModal(){ loginModal.style.display='flex'; ensureRecaptcha(); }
    function hideLoginModal(){ loginModal.style.display='none'; }
    closeLoginBtn.addEventListener('click', hideLoginModal);

    function applyAuthUser(u){
      if(!u) return;
      userId = u.uid;
      myContact = u.phoneNumber || myContact;
      setLocalProfile(userId, myName, myContact, myEmail, myImageUrl);
      loadUserTicket();
    }

    /* ================= Board ================= */
    for(let i=1;i<=90;i++){
      const cell=document.createElement('div');
      cell.className='tambola-board-cell';
      cell.id='b_'+i;
      cell.textContent=i;
      tambolaBoardEl.appendChild(cell);
    }

    /* ================= Ticket generator ================= */
    function generateTicketMatrix(){
      const cols=[], chosen=[];
      for(let c=0;c<9;c++){
        const min=c===0?1:c*10;
        const max=c===8?90:c*10+9;
        const pool=[]; for(let n=min;n<=max;n++) pool.push(n);
        cols.push(pool);
      }
      while(chosen.length<15){
        const c=Math.floor(Math.random()*9);
        if(chosen.filter(x=>x.col===c).length>=3) continue;
        const pool=cols[c];
        const val=pool[Math.floor(Math.random()*pool.length)];
        if(!chosen.some(x=>x.num===val)) chosen.push({col:c,num:val});
      }
      const byCol=Array.from({length:9},()=>[]);
      chosen.forEach(x=>byCol[x.col].push(x.num));
      byCol.forEach(a=>a.sort((a,b)=>a-b));
      const grid=Array.from({length:3},()=>Array(9).fill(null));
      const rowCounts=[0,0,0];
      for(let c=0;c<9;c++){
        if(byCol[c].length===3){ for(let r=0;r<3;r++){ grid[r][c]=byCol[c][r]; rowCounts[r]++; } }
      }
      for(let c=0;c<9;c++){
        if(byCol[c].length===2){
          const rows=[0,1,2].sort((a,b)=>rowCounts[a]-rowCounts[b]).slice(0,2);
          grid[rows[0]][c]=byCol[c][0]; grid[rows[1]][c]=byCol[c][1];
          rowCounts[rows[0]]++; rowCounts[rows[1]]++;
        }
      }
      for(let c=0;c<9;c++){
        if(byCol[c].length===1){
          const r=[0,1,2].sort((a,b)=>rowCounts[a]-rowCounts[b])[0];
          grid[r][c]=byCol[c][0]; rowCounts[r]++;
        }
      }
      return grid;
    }
    let currentGrid=null;
    function renderTicket(grid, serialText){
      const g = grid || currentGrid;
      if(!g) return;
      userTicketContainer.style.display='block';
      ticketEl.innerHTML='';
      if(serialText) ticketSerialEl.textContent = serialText;
      // Load ticks from local storage for the current game ID
      const ticks=JSON.parse(localStorage.getItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId) ||'[]');
      for(let r=0;r<3;r++){
        for(let c=0;c<9;c++){
          const val=g[r][c];
          const cell=document.createElement('div');
          if(!val){cell.className='ticket-cell empty'; cell.innerHTML='&nbsp;';}
          else{
            cell.className='ticket-cell';
            cell.textContent=val;
            if(ticks.includes(val)) cell.classList.add('ticked');
          }
          cell.addEventListener('click',()=>{
            if(!val) return;
            // IMPORTANT: Get ticks based on currentTicketGameId
            const ticksNow = JSON.parse(localStorage.getItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId)||'[]');
            if(cell.classList.contains('ticked')){
              cell.classList.remove('ticked');
              const idx=ticksNow.indexOf(val);
              if(idx>-1) ticksNow.splice(idx,1);
            } else {
              cell.classList.add('ticked'); ticksNow.push(val);
            }
            localStorage.setItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId, JSON.stringify(ticksNow));
          });
          ticketEl.appendChild(cell);
        }
      }
    }
    function markTicketBuggy(reason){
      const cells = ticketEl.querySelectorAll('.ticket-cell.ticked');
      cells.forEach(c=> c.classList.add('buggy'));
      const uid = localStorage.getItem(LS_UID) || userId || ('guest_'+Math.random().toString(36).slice(2,6));
      db.ref('buggyClaims').push({ userId:uid, name: localStorage.getItem(LS_NAME)||myName||'Guest', time: firebase.database.ServerValue.TIMESTAMP, reason });
      setTimeout(()=>{ cells.forEach(c=> c.classList.remove('buggy')); },6000);
    }
    function ticketNumbersFlat(grid){
      return grid.flat().filter(Boolean);
    }

    function saveTicketToDB(ticketData, gameId) {
        if (!userId) {
            alert("Please log in to book a ticket.");
            return;
        }
        const userTicketRef = userGamesRef.child(userId).child(gameId);
        userTicketRef.set(ticketData).then(() => {
            console.log("Ticket saved to DB successfully.");
        }).catch(error => {
            console.error("Error saving ticket to DB:", error);
            alert("Failed to save ticket. Please try again.");
        });
    }

    function loadUserTicket() {
      if (!userId) return;
      userGamesRef.child(userId).once('value', snapshot => {
        const allTickets = snapshot.val();
        const listEl = document.getElementById('userGamesList');
        listEl.innerHTML = '';
        if (allTickets) {
          listEl.innerHTML = renderUserGamesList(allTickets);
        } else {
          listEl.innerHTML = 'No booked tickets yet.';
        }
      });
    }

    function renderUserGamesList(tickets) {
        let html = '';
        Object.keys(tickets).forEach(gameId => {
            const ticketData = tickets[gameId];
            const statusColor = ticketData.status && ticketData.status.startsWith('claimed') ? 'style="color:#00ff00;"' : 'style="color:#ffeb3b;"';
            html += `
                <div class="game-info-item">
                    <div style="font-weight: bold;">Game: ${ticketData.gameName}</div>
                    <div>Ticket ID: ${ticketData.serial}</div>
                    <div ${statusColor}>Status: ${ticketData.status ? ticketData.status.toUpperCase() : 'BOOKED'}</div>
                    <div><button class="view-all-button" style="margin: 0; background:#388e3c; color:#fff;" onclick="showSpecificTicket('${gameId}')">View Ticket</button></div>
                </div>
            `;
        });
        return html;
    }
    
    /**
     * FIX 1: Updated Prize Amounts - 2nd Full House removed.
     */
    const PRIZE_AMOUNTS = {
      'Early Five':1000, 'Top Line':1000, 'Middle Line':1000, 'Bottom Line':1000,
      'Full House':5000, 'Ticket Corner':1000 // '2nd Full House' removed as requested
    };
    
    /**
     * FIX 1: New function to get applicable prizes for a game type
     * Friend Games (non-global) ONLY allow Full House.
     * Main Game (global) allows all prizes in PRIZE_AMOUNTS.
     */
    function getApplicablePrizes(gameId) {
        if (gameId && !gameId.startsWith('global-')) { // Room/Friend Game
            // Only Full House is allowed in friend games, as requested
            return ['Full House'];
        }
        // Global/Main Game - only include prizes in the updated PRIZE_AMOUNTS
        return Object.keys(PRIZE_AMOUNTS);
    }
    

    async function updateClaimButtons(claimedPrizes) {
        const applicablePrizes = getApplicablePrizes(currentTicketGameId);
        const prizeButtons = document.querySelectorAll('.claim-button');
        
        prizeButtons.forEach(button => {
            const prizeName = button.getAttribute('data-prize');
            let amount = PRIZE_AMOUNTS[prizeName] || '???';
            const isActive = applicablePrizes.includes(prizeName);

            // FIX 2: Dynamic prize display for Room Full House (Play with Friends)
            if (prizeName === 'Full House' && currentTicketGameId && !currentTicketGameId.startsWith('global-')) {
                // Display the estimated 90% prize pool if calculated
                amount = roomFullHousePrize > 0 ? roomFullHousePrize : Math.round(Object.values(currentPlayers).filter(p => p.paid).length * roomTicketPrice * 0.90) || 3000;
            }


            // Hide/Disable buttons for non-applicable prizes
            if (!isActive) {
                button.style.display = 'none';
                return;
            } else {
                button.style.display = 'block'; // Ensure it's visible
            }

            if (claimedPrizes.includes(prizeName)) {
                button.style.backgroundColor = 'gray';
                button.disabled = true;
                button.innerHTML = `<span class="claimed-button-text">CLAIMED</span> ₹${amount}`;
            } else {
                button.style.backgroundColor = 'green';
                button.disabled = false;
                button.innerHTML = `${prizeName} ₹${amount}`;
            }
        });
    }

    async function showSpecificTicket(gameId) {
        if (!userId) {
            alert("Please log in to view tickets.");
            return;
        }

        const ticketDataSnap = await userGamesRef.child(userId).child(gameId).once('value');
        const ticketData = ticketDataSnap.val();
        
        if (ticketData) {
            currentGrid = ticketData.ticket;
            currentTicketSerial = ticketData.serial;
            currentTicketGameId = gameId;
            
            // Get claimed prizes for this game from the central games node
            const gameClaimedPrizesSnap = await gamePrizesRef.child(gameId).once('value');
            const gameClaimedPrizes = gameClaimedPrizesSnap.val() || [];
            
            renderTicket(currentGrid, `#${currentTicketSerial}`);
            
            // Update UI based on central claimed prizes
            updateClaimButtons(gameClaimedPrizes);

            // Hide the list view and show the main ticket container
            const listEl = document.getElementById('userGamesList');
            const btnEl = document.getElementById('viewTicketsBtn');
            listEl.style.display = 'none';
            btnEl.textContent = 'View All Booked Tickets';

        } else {
            alert("Ticket not found!");
        }
    }


    [buyTicketBtnTop, buyTicketBtnBottom].forEach(btn=>{
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        if (!userId) {
          alert("Please create a profile first!");
          showProfileModal();
          return;
        }
        alert("Payment Placeholder: Payment Success! Your ticket is now booked.");
        
        // Use a unique gameId for global games
        const gameId = 'global-' + Date.now();
        
        const grid = generateTicketMatrix();
        const serial = Math.floor(Math.random()*100000);
        const ticketData = { ticket: grid, serial, gameId, gameName: 'Mega Contest', status: 'booked' };
        
        await saveTicketToDB(ticketData, gameId);
        
        currentGrid = grid;
        currentTicketSerial = serial;
        currentTicketGameId = gameId;
        
        // Clear old ticks for the new ticket
        localStorage.removeItem(LS_TICKET_TICKS_PREFIX + gameId);
        renderTicket(currentGrid, `#${serial}`);
        
        // Reset claim buttons to active state for new ticket
        const gameClaimedPrizesSnap = await gamePrizesRef.child(gameId).once('value');
        const gameClaimedPrizes = gameClaimedPrizesSnap.val() || [];
        updateClaimButtons(gameClaimedPrizes);
      });
    });
    
    if (viewTicketsBtn) {
        viewTicketsBtn.addEventListener('click', () => {
            const listEl = document.getElementById('userGamesList');
            if (listEl.style.display === 'none') {
                listEl.style.display = 'grid'; // Changed to grid for better display
                viewTicketsBtn.textContent = 'Hide Booked Tickets';
                loadUserTicket();
            } else {
                listEl.style.display = 'none';
                viewTicketsBtn.textContent = 'View All Booked Tickets';
            }
        });
    }
/* ================================================= */
    /* 🔥🔥🔥 RAZORPAY PAYMENT INTEGRATION START 🔥🔥🔥 */
    /* ================================================= */

    // --- 1. Define Ticket Price ---
    const GLOBAL_TICKET_PRICE = 100; // Set your global ticket price here (in Rupees)

    // --- 2. Razorpay Checkout Function ---
    async function checkoutTicketRazorpay(amount, gameId, isRoomGame = false, roomInfo = {}) {
        if (!userId) {
            alert("Please create a profile first!");
            showProfileModal();
            return;
        }

        // Razorpay Options
        const options = {
            // Replace 'YOUR_RAZORPAY_KEY_ID' with your actual Key ID.
            // THIS MUST BE A LIVE OR TEST KEY.
            key:"rzp_test_RYvtH6nAAnpMqp", 
            amount: amount * 100, // Amount is in paise
            currency: "INR",
            name: "Tambola 69",
            description: `Ticket for Game ID: ${gameId}`,
            image: myImageUrl, // Use user's profile image or a company logo
            handler: async function (response) {
                // --- 3. Payment Success Logic ---
                // *** IMPORTANT: Server-Side Verification is Recommended Here ***
                
                alert("Payment Successful! Processing ticket...");
                
                // --- Placeholder for SERVER-SIDE VERIFICATION ---
                // For a secure app, you would send:
                // response.razorpay_payment_id, response.razorpay_order_id, response.razorpay_signature 
                // to your server for verification before continuing with ticket generation.
                // --- END PLACEHOLDER ---
                
                // If verification is assumed successful (for this frontend-only demo):
                await handleSuccessfulPayment(gameId, isRoomGame, amount, roomInfo);
                
            },
            prefill: {
                name: myName || "Guest User",
                email: myEmail || "guest@example.com",
                contact: myContact || "9876543210" // Razorpay requires a contact number
            },
            theme: {
                color: "#ffc107" // Tambola gold/yellow theme
            },
            modal: {
                ondismiss: function() {
                    console.log('Payment checkout closed.');
                }
            }
        };

        const rzp = new window.Razorpay(options);
        rzp.open();
    }
    
    // --- 4. Handle Ticket Generation after Successful Payment ---
    async function handleSuccessfulPayment(gameId, isRoomGame, amount, roomInfo = {}) {
        const grid = generateTicketMatrix();
        const serial = Math.floor(Math.random() * 100000);
        const ticketData = { 
            ticket: grid, 
            serial, 
            gameId, 
            gameName: isRoomGame ? `Room ${roomInfo.roomId}` : 'Mega Contest', 
            status: 'booked',
            paymentAmount: amount
        };
        
        await saveTicketToDB(ticketData, gameId);
        
        currentGrid = grid;
        currentTicketSerial = serial;
        currentTicketGameId = gameId;
        
        // Clear old ticks for the new ticket
        localStorage.removeItem(LS_TICKET_TICKS_PREFIX + gameId);
        renderTicket(currentGrid, `#${serial}`);
        
        // Reset claim buttons to active state for new ticket
        const gameClaimedPrizesSnap = await gamePrizesRef.child(gameId).once('value');
        const gameClaimedPrizes = gameClaimedPrizesSnap.val() || [];
        updateClaimButtons(gameClaimedPrizes);

        if (isRoomGame && roomInfo.roomId && userId) {
             // Update room player status
            await db.ref(`rooms/${roomInfo.roomId}/players/${userId}`).update({ 
                paid: true, 
                ticket: grid, 
                serial
            });
            refreshPrizeDisplay(); // Recalculate and show new prize with new paid player
        } else {
            // For global game, decrement ticketsLeft
            await nextGameRef.child('ticketsLeft').transaction(left => Math.max(0, (left || 0) - 1));
        }
    }


    [buyTicketBtnTop, buyTicketBtnBottom].forEach(btn=>{
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        if (!userId) {
          alert("Please create a profile first!");
          showProfileModal();
          return;
        }
        
        // Use a fixed gameId for global next game
        const gameId = 'global-next';

        // Check if already booked
        const ticketSnap = await userGamesRef.child(userId).child(gameId).once('value');
        if (ticketSnap.exists()) {
            alert("Ek user sirf ek game main ek hi ticket book kar sakta h.");
            return;
        }

        // Check if spots are available
        const nextSnap = await nextGameRef.child('ticketsLeft').once('value');
        const left = nextSnap.val() || 0;
        if (left <= 0) {
            alert("Total spot book ho gaye hain. Agali game join karein.");
            return;
        }

        const amount = GLOBAL_TICKET_PRICE; 

        // Start Razorpay Checkout
        await checkoutTicketRazorpay(amount, gameId, false);
      });
    });
    
    /* =============================================== */
    /* 🔥🔥🔥 RAZORPAY PAYMENT INTEGRATION END 🔥🔥🔥 */
    /* =============================================== */
    
    if (viewTicketsBtn) {
        viewTicketsBtn.addEventListener('click', () => {
            const listEl = document.getElementById('userGamesList');
            if (listEl.style.display === 'none') {
                listEl.style.display = 'grid'; // Changed to grid for better display
                viewTicketsBtn.textContent = 'Hide Booked Tickets';
                loadUserTicket();
            } else {
                listEl.style.display = 'none';
                viewTicketsBtn.textContent = 'View All Booked Tickets';
            }
        });
    }

    /* ================= Global presence/history ================= */
    const presenceRef=db.ref('presence');
    let myPresence=null;
    let activeRoom = null;
    let isHost=false;
    let drawTimer=null;
    const DRAW_INTERVAL_MS = 4000;
    const ROOM_STATUS = { WAIT:'waiting', START:'started', END:'ended' };

    function highlightBoard(n, hist){
      document.querySelectorAll('.tambola-board-cell').forEach(cell => cell.classList.remove('drawn'));
      hist.forEach(num => {
        const hCell = document.getElementById('b_'+num);
        if(hCell) hCell.classList.add('drawn');
      });
      const latestCell = document.getElementById('b_' + n);
      if (latestCell) {
          latestCell.classList.add('drawn');
      }
    }

    let globalCountdownInterval;
    let nextCountdownInterval;

    function updateCountdownDisplay(seconds, elementId) {
      const countdownEl = document.getElementById(elementId);
      if (!countdownEl) return;
      let remaining = seconds;
      
      const intervalId = setInterval(() => {
        remaining--;
        if (remaining >= 0) {
          const hours = Math.floor(remaining / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          const secs = remaining % 60;
          const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
          countdownEl.textContent = formattedTime;
        } else {
          countdownEl.textContent = "00:00:00";
          clearInterval(intervalId);
        }
      }, 1000);
      return intervalId;
    }

    function handleGlobalGameData(data) {
        const status = data.status || 'idle';
        const liveNumber = data.liveNumber;
        const historyArr = data.history || [];
        const countdown = data.countdown;
        
        waitingTitle.textContent = `Game Status: ${status}`;
        waitingDesc.textContent = status === 'started' ? 'Global public draw is live' : 'No active game';
        latestNumber.textContent = liveNumber ? 'Number: ' + liveNumber : '—';
        historyEl.textContent = historyArr.length ? historyArr.join(', ') : 'None';
        highlightBoard(liveNumber, historyArr);

        if (status === 'ended' && currentTicketGameId && currentTicketGameId.startsWith('global-')) {
            showGameOverMessage();
        } else {
            hideGameOverMessage();
        }
        
        // FIX 1: Auto-claim check for global game
        if (status === 'started' && liveNumber) {
           checkAndAttemptAutoClaim(); 
        }
    }

    function showGameOverMessage() {
      if(gameOverMessageEl) gameOverMessageEl.style.display = 'block';
    }

    function hideGameOverMessage() {
      if(gameOverMessageEl) gameOverMessageEl.style.display = 'none';
    }

    function handleNextGameData(data) {
        const countdown = data.countdown;
        const ticketsLeft = data.ticketsLeft || 0;
        const prizePercentage = data.prizePercentage || 0;
        const totalSpots = data.totalSpots || 100;

        document.getElementById('ticketsLeftBottom').textContent = ticketsLeft;
        document.getElementById('prizePercentageBottom').textContent = `${prizePercentage}%`;
        document.getElementById('TotalSpotBottum').textContent = totalSpots;
        document.getElementById('ticketsLeftTop').textContent = ticketsLeft;
        document.getElementById('prizePercentageTop').textContent = `${prizePercentage}%`;
        document.getElementById('TotalSpotTop').textContent = totalSpots;
        
        if (countdown) {
            clearInterval(nextCountdownInterval);
            nextCountdownInterval = updateCountdownDisplay(countdown, 'nextCountdownBottom');
            updateCountdownDisplay(countdown, 'nextCountdownTop');
        }
    }

    currentGameRef.on('value', s => {
      const data = s.val() || {};
      if(!activeRoom) {
        handleGlobalGameData(data);
      }
    });

    nextGameRef.on('value', s => {
      const data = s.val() || {};
      handleNextGameData(data);
    });
    
    videoRef.on('value', snap => {
      const data = snap.val() || {};
      const liveBtn = document.getElementById('watchLiveBtn');
      if (data.url && liveBtn) {
        liveBtn.onclick = function() {
          liveFrame.src = data.url + '?autoplay=1&rel=0';
          liveVideoBox.style.display = 'block';
          liveBtn.style.display = 'none';
        };
      }
    });

    // New listener for central claimed prizes
    gamePrizesRef.on('child_changed', snap => {
        const gameId = snap.key;
        if(gameId === currentTicketGameId) {
            const claimedPrizes = snap.val() || [];
            updateClaimButtons(claimedPrizes);
        }
    });
    gamePrizesRef.on('child_added', snap => {
        const gameId = snap.key;
        if(gameId === currentTicketGameId) {
            const claimedPrizes = snap.val() || [];
            updateClaimButtons(claimedPrizes);
        }
    });

    /* ================= Claims & Winners ================= */
    const userHistoryRef = db.ref('userHistory');
    const withdrawalHistoryRef = db.ref('withdrawalHistory');
    const notificationRef = db.ref('notifications');

    
    // Function to handle "View All Winners" button
    async function showAllWinners() {
        const snap = await winnersRef.orderByChild('time').limitToLast(100).once('value');
        const data = snap.val() || {};
        
        const winnerList = await Promise.all(Object.entries(data).reverse().map(async ([k, w]) => { // FIX: .reverse() for latest first
            const userSnap = await db.ref('users/' + w.userId).once('value');
            const userData = userSnap.val() || {};
            const uname = userData.name || w.userName || 'Player';
            const imageUrl = userData.imageUrl || "https://via.placeholder.com/30";
            return `
                <div class="winner-row" onclick="showWinnerProfile('${w.userId}')">
                    <div class="winner-info">
                        <img src="${imageUrl}" class="winner-avatar" alt="Profile Image">
                        <div>${uname} - ${w.prize || 'Winner'}</div>
                    </div>
                    <div>₹${w.amount || 0}</div>
                </div>
            `;
        }));

        const modal = document.createElement('div');
        modal.className = 'modal-backdrop';
        modal.innerHTML = `<div class="modal" style="text-align:left;">
            <div class="row" style="justify-content:space-between; align-items:center;">
                <h3>All Winners List</h3>
                <button class="btn secondary" onclick="document.body.removeChild(this.closest('.modal-backdrop'));">Close</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                ${winnerList.length ? winnerList.join('') : '<p>No winners recorded yet.</p>'}
            </div>
        </div>`;
        document.body.appendChild(modal);
        modal.style.display = 'flex';
    }
    window.showAllWinners = showAllWinners; // Expose to global scope for HTML onclick

    // --- FIX: Winner's list update to show latest winners ---
    winnersRef.limitToLast(5).on('value', async (s) => { // FIX: Use limitToLast to get latest 5
        const data = s.val() || {};
        const arr = await Promise.all(Object.entries(data).reverse().map(async ([k, w]) => { // FIX: Reverse to ensure latest is at the top of the list
            const userSnap = await db.ref('users/' + w.userId).once('value');
            const userData = userSnap.val() || {};
            const uname = userData.name || w.userName || 'Player';
            const imageUrl = userData.imageUrl || "https://via.placeholder.com/30";
            const claimed = w.claimed ? '<span class="winner-x">✔️</span>' : '';
            
            return `
                <div class="winner-row" onclick="showWinnerProfile('${w.userId}')">
                    <div class="winner-info">
                        <img src="${imageUrl}" class="winner-avatar" alt="Profile Image">
                        <div>${claimed}${uname} - ${w.prize || 'Winner'}</div>
                    </div>
                    <div>₹${w.amount || 0}</div>
                </div>
            `;
        }));
        winnerListEl.innerHTML = arr.length ? arr.join('') : 'No winners yet...';
    });
    // --- END FIX ---

    // --- ADDED ---
    async function showWinnerProfile(winnerId) {
        const userSnap = await db.ref('users/' + winnerId).once('value');
        const userData = userSnap.val() || {};
        const gamesSnap = await userGamesRef.child(winnerId).once('value');
        const userGames = gamesSnap.val() || {};

        winnerProfileImage.src = userData.imageUrl || 'https://via.placeholder.com/100';
        winnerProfileName.textContent = userData.name || 'Player';
        
        let gamesHtml = '<h4>Game List</h4><div class="game-info-grid">';
        if (Object.keys(userGames).length === 0) {
            gamesHtml += 'No games played yet.';
        }
        else {
            Object.values(userGames).forEach(game => {
                gamesHtml += `
                    <div class="game-info-item">
                        <div style="font-weight: bold;">Game: ${game.gameName}</div>
                        <div>Ticket ID: ${game.serial}</div>
                        <div>Status: ${game.status ? game.status.toUpperCase() : 'BOOKED'}</div>
                    </div>
                `;
            });
        }
        gamesHtml += '</div>';
        winnerGamesList.innerHTML = gamesHtml;

        winnerProfileModal.style.display = 'flex';
    }
    window.showWinnerProfile = showWinnerProfile;
    // --- END ADDED ---

    /* ================= Wallet helpers ================= */
    async function ensureUserRecord(uid){
      const userRef=db.ref('users/'+uid);
      const snap=await userRef.once('value');
      if(!snap.exists()){
        await userRef.set({ name: localStorage.getItem(LS_NAME)||myName||'Guest', phone: localStorage.getItem(LS_CONTACT)||myContact||'', email: localStorage.getItem(LS_EMAIL) || myEmail || '', balance:0, imageUrl: myImageUrl });
      }
    }
    async function getUserBalance(uid){
      const snap=await db.ref('users/'+uid).once('value');
      return (snap.val() && snap.val().balance) || 0;
    }
    async function setUserBalance(uid, newBal){
      await db.ref('users/'+uid).update({ balance: newBal });
      document.getElementById('myWinnings').textContent = newBal;
    }

    /* ================= Claim Prize (with validation + buggy handling) ================= */
    async function claimPrize(prizeName){
        if(!currentGrid || !currentTicketGameId){
            alert("Please book and view a ticket first!"); 
            return;
        }

        const uid = localStorage.getItem(LS_UID) || userId || ('guest_'+Math.random().toString(36).slice(2,6));
        const name = localStorage.getItem(LS_NAME) || myName || 'Guest';
        let amount = PRIZE_AMOUNTS[prizeName] || 0;
        const gameId = currentTicketGameId;
        const isGlobalGame = gameId.startsWith('global-');

        // Check if this prize has already been claimed for this game
        const gameClaimedPrizesRef = gamePrizesRef.child(gameId);
        const claimedPrizesSnap = await gameClaimedPrizesRef.once('value');
        const claimedPrizes = claimedPrizesSnap.val() || [];
        if (claimedPrizes.includes(prizeName)) {
            alert("This prize has already been claimed!");
            return;
        }

        /** * FIX 1 & 2: Enforce only 'Full House' claimable in Play with Friends (non-global) games
         */
        if (!isGlobalGame && prizeName !== 'Full House') {
             alert("Only Full House can be claimed in this private room game!");
             return;
        }

        // FIX 2: For non-global (room) games, fetch dynamic amount for Full House (90% of pool)
        if (prizeName === 'Full House' && !isGlobalGame) {
            amount = await db.ref(`rooms/${gameId}/prizeInfo/fullHousePool`).once('value').then(s => s.val() || 0);
             if (amount === 0) {
                 alert("Room prize pool is zero or not set. Cannot claim.");
                 return;
            }
        }

        const historyRef = activeRoom ? db.ref(`rooms/${activeRoom}/draw/history`) : currentGameRef.child('history');
        const historyArr = (await historyRef.once('value')).val() || {};
        const H = Array.isArray(historyArr) ? historyArr : Object.values(historyArr||{});
        const tnums = ticketNumbersFlat(currentGrid);
        
        // Use only the numbers that are marked (ticked) by the user
        const myTickedNumbers = JSON.parse(localStorage.getItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId) || '[]');
        
        // 1. Check if all ticked numbers are actually drawn
        const undrawnTickedNumbers = myTickedNumbers.filter(n => !H.includes(n));
        if (undrawnTickedNumbers.length > 0) {
            markTicketBuggy(`Ticked undrawn number(s): ${undrawnTickedNumbers.join(', ')}`);
            alert('Invalid claim — you have ticked number(s) not yet drawn. Ticket marked buggy. Please review!');
            await db.ref('claims').push({ userId: uid, userName: name, prize: prizeName, time: firebase.database.ServerValue.TIMESTAMP, valid:false, gameId });
            return;
        }


        let valid = false;
        switch (prizeName) {
            case 'Early Five':
                // Check if the number of ticked numbers is exactly 5 AND all are drawn
                if (isGlobalGame && myTickedNumbers.length === 5 && myTickedNumbers.every(n => H.includes(n))) {
                    valid = true;
                }
                break;
            case 'Top Line':
                const topRow = currentGrid[0].filter(Boolean);
                // Check if all numbers in the top row are in myTickedNumbers
                if (isGlobalGame && topRow.every(n => myTickedNumbers.includes(n))) {
                    valid = true;
                }
                break;
            case 'Middle Line':
                const middleRow = currentGrid[1].filter(Boolean);
                // Check if all numbers in the middle row are in myTickedNumbers
                if (isGlobalGame && middleRow.every(n => myTickedNumbers.includes(n))) {
                    valid = true;
                }
                break;
            case 'Bottom Line':
                const bottomRow = currentGrid[2].filter(Boolean);
                // Check if all numbers in the bottom row are in myTickedNumbers
                if (isGlobalGame && bottomRow.every(n => myTickedNumbers.includes(n))) {
                    valid = true;
                }
                break;
            case 'Ticket Corner':
                // Only for Global/Main Game
                const tl = currentGrid[0].find(n=>n);
                const tr = currentGrid[0].slice().reverse().find(n=>n);
                const bl = currentGrid[2].find(n=>n);
                const br = currentGrid[2].slice().reverse().find(n=>n);
                
                const cornersOnTicket = [tl, tr, bl, br].filter(Boolean);

                if (isGlobalGame && cornersOnTicket.length > 0 && cornersOnTicket.every(n => myTickedNumbers.includes(n))) {
                    valid = true;
                }
                break;
            case 'Full House':
                // Check if all 15 ticket numbers are ticked
                if (tnums.length === 15 && tnums.every(n => myTickedNumbers.includes(n))) {
                    valid = true;
                }
                break;
            // FIX 1: 2nd Full House logic removed as it's no longer in PRIZE_AMOUNTS
        }


        if(!valid){
            markTicketBuggy(`Wrong claim: ${prizeName}`);
            alert(`Invalid claim for ${prizeName}. Ticket marked buggy. Please review your numbers and the prize rules.`);
            await db.ref('claims').push({ userId: uid, userName: name, prize: prizeName, time: firebase.database.ServerValue.TIMESTAMP, valid:false, gameId });
            return;
        }
      
        // Update central claimed prizes list
        claimedPrizes.push(prizeName);
        await gameClaimedPrizesRef.set(claimedPrizes);

        // Update claim button UI
        updateClaimButtons(claimedPrizes);

        const claimRef = claimsRef.push();
        await claimRef.set({ userId: uid, userName: name, prize: prizeName, time: firebase.database.ServerValue.TIMESTAMP, valid:true, gameId });
        const wref = winnersRef.push();
        await wref.set({ userId: uid, name, prize: prizeName, amount, claimed: true, time: firebase.database.ServerValue.TIMESTAMP, gameId });
        const userRef = db.ref('users/'+uid);
        const snap = await userRef.once('value');
        const existing = snap.val() || {};
        const newBal = (existing.balance||0) + amount;
        await userRef.update({ balance: newBal, name: name, phone: localStorage.getItem(LS_CONTACT)||myContact||'', email: localStorage.getItem(LS_EMAIL) || myEmail || '' });
        document.getElementById('myWinnings').textContent = newBal;
        speakTambolaSentence(`Congratulations ${name}! You have claimed ${prizeName} for ₹${amount}.`);
        alert(`Claim submitted for ${prizeName}. ₹${amount} added to your balance.`);

        // Update user's personal ticket status
        const userTicketRef = db.ref(`userTickets/${uid}/${currentTicketGameId}`);
        await userTicketRef.update({ status: 'claimed - ' + prizeName }); 

        userHistoryRef.child(uid).push({
            type: 'claim',
            prize: prizeName,
            amount,
            gameId,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
    
    // 🔥🔥🔥 FIX: New function for auto-claim logic (Updated for Fix 1) 🔥🔥🔥
    async function checkAndAttemptAutoClaim() {
        if (!autoClaimToggle.checked || !currentGrid || !currentTicketGameId || !userId) {
            return;
        }
        
        const gameId = currentTicketGameId;
        const isGlobalGame = gameId.startsWith('global-');

        const ticketDataSnap = await userGamesRef.child(userId).child(currentTicketGameId).once('value');
        const ticketInfo = ticketDataSnap.val();
        // Skip if ticket is already fully claimed (Full House is claimed)
        if (!ticketInfo || (ticketInfo.status && ticketInfo.status.includes('Full House'))) return;
        
        const gameClaimedPrizesSnap = await gamePrizesRef.child(currentTicketGameId).once('value');
        const gameClaimedPrizes = gameClaimedPrizesSnap.val() || [];

        const historyRef = activeRoom ? db.ref(`rooms/${activeRoom}/draw/history`) : currentGameRef.child('history');
        const historyArr = (await historyRef.once('value')).val() || {};
        const H = Array.isArray(historyArr) ? historyArr : Object.values(historyArr||{});
        const tnums = ticketNumbersFlat(currentGrid);
        
        // 1. Get all numbers on the ticket that have been drawn
        const drawnTicketNumbers = tnums.filter(n => H.includes(n));
        
        // --- Prize Priority Order ---
        let prizesToCheck = [];
        if (isGlobalGame) {
            // Global Game Prizes in Order of Priority (Early Five first, Full House last)
            prizesToCheck = [
                'Early Five', 'Top Line', 'Middle Line', 'Bottom Line', 
                'Ticket Corner', 'Full House'
            ];
        } else {
            // Room/Friend Game: ONLY Full House
            prizesToCheck = ['Full House'];
        }

        for (const prize of prizesToCheck) {
            // Check if prize is already claimed
            if (gameClaimedPrizes.includes(prize)) {
                continue;
            }

            let isReadyToClaim = false;

            switch (prize) {
                case 'Early Five':
                    // Must be exactly 5 drawn numbers
                    isReadyToClaim = drawnTicketNumbers.length === 5;
                    break;
                case 'Top Line':
                    const topRow = currentGrid[0].filter(Boolean);
                    isReadyToClaim = topRow.every(n => drawnTicketNumbers.includes(n));
                    break;
                case 'Middle Line':
                    const middleRow = currentGrid[1].filter(Boolean);
                    isReadyToClaim = middleRow.every(n => drawnTicketNumbers.includes(n));
                    break;
                case 'Bottom Line':
                    const bottomRow = currentGrid[2].filter(Boolean);
                    isReadyToClaim = bottomRow.every(n => drawnTicketNumbers.includes(n));
                    break;
                case 'Ticket Corner':
                    const tl = currentGrid[0].find(n=>n);
                    const tr = currentGrid[0].slice().reverse().find(n=>n);
                    const bl = currentGrid[2].find(n=>n);
                    const br = currentGrid[2].slice().reverse().find(n=>n);
                    const cornersOnTicket = [tl, tr, bl, br].filter(Boolean);

                    // All corner numbers that exist must be drawn/ticked
                    isReadyToClaim = cornersOnTicket.length > 0 && cornersOnTicket.every(n => drawnTicketNumbers.includes(n));
                    break;
                case 'Full House':
                    isReadyToClaim = tnums.length === 15 && tnums.every(n => drawnTicketNumbers.includes(n));
                    break;
            }

            // Only attempt to claim if ready
            if (isReadyToClaim) {
                // Critical step: Update local storage to match the required drawn numbers
                localStorage.setItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId, JSON.stringify(drawnTicketNumbers));
                renderTicket(currentGrid, `#${currentTicketSerial}`); // Re-render to show all ticks
                
                await claimPrize(prize);
                // Exit after one successful claim to prevent race conditions and ensure priority
                return; 
            }
        }
    }


    /* ================= Menu/Profile (Hamburger) ================= */
    (function setupHamburger(){
      const menuToggleEl = document.getElementById('menuToggle');
      const menuPanelEl = document.getElementById('menuPanel');
      menuToggleEl.addEventListener('click', ()=> menuPanelEl.classList.toggle('show'));
      document.addEventListener('click', (e)=>{
        if(!menuPanelEl.contains(e.target) && e.target !== menuToggleEl && e.target.closest('.hamburger') !== menuToggleEl){
          menuPanelEl.classList.remove('show');
        }
      });
    })();

    if(viewProfileBtn){
      viewProfileBtn.addEventListener('click', async ()=>{
        await loadAndShowProfile();
      });
    }

    function showProfileModal() {
        profileModal.style.display = 'flex';
        profileForm.style.display = 'block';
        profileView.style.display = 'none';
    }
    
    // Add these new functions for the profile modal
    async function loadAndShowProfile() {
        const uid = localStorage.getItem(LS_UID);
        if (!uid) {
            showProfileModal();
            return;
        }

        const snap = await db.ref('users/' + uid).once('value');
        const data = snap.val() || {};

        if (data.name) {
            profileModal.style.display = 'flex';
            profileForm.style.display = 'none';
            profileView.style.display = 'block';
            viewNameEl.textContent = data.name;
            viewPhoneEl.textContent = data.phone || '';
            viewEmailEl.textContent = data.email || '';
            profileImagePreview.src = data.imageUrl || "https://via.placeholder.com/100";
            myImageUrl = data.imageUrl || "https://via.placeholder.com/100"; // Ensure myImageUrl is updated
        } else {
            // If data is missing but UID exists, show the form for creation
            profileModal.style.display = 'flex';
            profileForm.style.display = 'block';
            profileView.style.display = 'none';
            profileNameInput.value = myName || '';
            profileContactInput.value = myContact || '';
            profileEmailInput.value = myEmail || '';
        }
    }

    if(closeProfileBtn){
      closeProfileBtn.addEventListener('click', ()=> profileModal.style.display='none');
    }
    if(closeViewProfileBtn){
        closeViewProfileBtn.addEventListener('click', ()=> profileModal.style.display='none');
    }
    if(editProfileBtn){
        editProfileBtn.addEventListener('click', async () => {
            const uid = localStorage.getItem(LS_UID);
            const snap = await db.ref('users/' + uid).once('value');
            const data = snap.val() || {};
            profileNameInput.value = data.name || myName || '';
            profileContactInput.value = data.phone || myContact || '';
            profileEmailInput.value = data.email || myEmail || '';
            profileForm.style.display = 'block';
            profileView.style.display = 'none';
        });
    }

    profileImageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            // Display preview
            const reader = new FileReader();
            reader.onload = (event) => {
                profileImagePreview.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // --- FIX 4: Handle saving the profile (Image Upload to Firebase Storage) ---
    if(saveProfileBtn){
      saveProfileBtn.addEventListener('click', async () => {
        const name = profileNameInput.value.trim();
        const phone = profileContactInput.value.trim();
        const email = profileEmailInput.value.trim();
        const imageFile = profileImageUpload.files[0];
        
        if (!name || !phone || !email) {
            alert('Please fill in Name, Phone, and Email.');
            return;
        }

        let uid = localStorage.getItem(LS_UID) || ('u_'+Date.now());
        let uploadedImageUrl = myImageUrl; // Start with current image URL

        // Handle image upload if a file is selected
        if (imageFile) {
            try {
                // Check for valid file size (e.g., max 2MB)
                if (imageFile.size > 2 * 1024 * 1024) { 
                    alert('Image size should be less than 2MB.');
                    return;
                }
                
                // Show a loading/progress indicator
                saveProfileBtn.textContent = 'Uploading... Please wait.';
                saveProfileBtn.disabled = true;

                // Get the storage reference: profile_images/{user_id}/profile.jpg (overwrite old image)
                const profileRef = storageRef.child('profile_images/' + uid + '/profile.jpg');
                
                // Upload the file
                const snapshot = await profileRef.put(imageFile);
               
                // Get the public download URL
                uploadedImageUrl = await snapshot.ref.getDownloadURL();
                alert('Image uploaded successfully!');
                
            } catch (error) {
                console.error('Image upload failed:', error);
                alert('Image upload failed. Saving profile without new image. Error: ' + error.message);
            } finally {
                 saveProfileBtn.textContent = 'Upload & Save Profile';
                 saveProfileBtn.disabled = false;
            }
        }
        
        // Save profile data with the new URL (or the old one)
        await saveProfileData(uid, name, phone, email, uploadedImageUrl);
      });
    }

    async function saveProfileData(uid, name, phone, email, imageUrl) {
        try {
            // Ensure the user ID is correctly set in local storage for the next load
            if (!localStorage.getItem(LS_UID)) {
                localStorage.setItem(LS_UID, uid);
                userId = uid;
            }

            await db.ref('users/' + uid).update({
                name: name,
                phone: phone,
                email: email,
                imageUrl: imageUrl 
            });
            
            setLocalProfile(uid, name, phone, email, imageUrl);
            myName = name;
            myContact = phone;
            myEmail = email;
            myImageUrl = imageUrl;
            userId = uid;
            
            alert('Profile saved successfully!');
            await loadAndShowProfile();

        } catch (error) {
            console.error('Error saving profile data:', error);
            alert('Failed to save profile data. Please try again. Check if your Firebase Security Rules allow writing to /users.');
        }
    }
    // --- END FIX 4 ---


    if(viewHistoryBtn){
      viewHistoryBtn.addEventListener('click', async () => {
        if (!userId) {
          alert('Please create a profile to view history.');
          showProfileModal();
          return;
        }

        const gameHistorySnap = await userHistoryRef.child(userId).once('value');
        const withdrawalHistorySnap = await withdrawalHistoryRef.child(userId).once('value');
        const gameHistory = gameHistorySnap.val() || {};
        const withdrawalHistory = withdrawalHistorySnap.val() || {};

        let gameHtml = '<h4>Game History</h4><div style="max-height: 200px; overflow-y: auto;">';
        if (Object.keys(gameHistory).length === 0) {
          gameHtml += '<p>No game history found.</p>';
        } else {
          Object.values(gameHistory).reverse().forEach(h => {
            const time = new Date(h.timestamp).toLocaleString();
            gameHtml += `<p>• <b>${h.type.toUpperCase()}</b> of ${h.prize||'Ticket'} for ₹${h.amount||'N/A'} in game <i>${h.gameId}</i> at ${time}</p>`;
          });
        }
        gameHtml += '</div>';

        let withdrawalHtml = '<h4>Payment History</h4><div style="max-height: 150px; overflow-y: auto;">';
        if (Object.keys(withdrawalHistory).length === 0) {
          withdrawalHtml += '<p>No payment history found.</p>';
        } else {
          Object.values(withdrawalHistory).reverse().forEach(h => {
            const time = new Date(h.timestamp).toLocaleString();
            withdrawalHtml += `<p>• <b>${h.type.toUpperCase()}</b> of ₹${h.amount} to ${h.dest} on ${time} (<span style="color: ${h.status==='pending'?'orange':'green'};">${h.status.toUpperCase()}</span>)</p>`;
          });
        }
        withdrawalHtml += '</div>';

        const modal = document.createElement('div');
        modal.className = 'modal-backdrop';
        modal.innerHTML = `<div class="modal" style="text-align:left; max-width: 500px;">
            <div class="row" style="justify-content:space-between; align-items:center;">
                <h3>History</h3>
                <button class="btn secondary" onclick="document.body.removeChild(this.closest('.modal-backdrop'));">Close</button>
            </div>
            ${gameHtml}
            ${withdrawalHtml}
        </div>`;
        document.body.appendChild(modal);
        modal.style.display = 'flex';
      });
    }
    
    // Function to show static content in a modal
    function showStaticPage(page) {
        const modal = document.getElementById('staticPageModal');
        const titleEl = document.getElementById('staticPageTitle');
        const contentEl = document.getElementById('staticPageContent');
        let title = '';
        let content = '';
        
        // Define content for each page
        switch (page) {
            case 'about':
                title = 'About Us';
                content = `
                    <p>Welcome to Tambola 69, your ultimate destination for playing Tambola/Housie online with friends and family! We are dedicated to providing a fun, engaging, and fair gaming experience for everyone.</p>
                    <p>Our platform allows you to join public games or create your own private rooms, ensuring a seamless and interactive experience. With features like live number announcements and automatic ticket marking, we bring the classic game of Tambola to your fingertips.</p>
                    <p>Happy playing! 🎉</p>
                `;
                break;
            case 'terms':
                title = 'Terms and Conditions';
                content = `
                    <p>Welcome to Tambola 69. These terms and conditions outline the rules and regulations for the use of Tambola 69's Website and App.</p>
                    <p>By accessing this website, we assume you accept these terms and conditions. Do not continue to use Tambola 69 if you do not agree to all of the terms and conditions stated on this page.</p>
                    <p><b>License:</b> Unless otherwise stated, Tambola 69 and/or its licensors own the intellectual property rights for all material on Tambola 69. All intellectual property rights are reserved. You may access this from Tambola 69 for your own personal use subjected to restrictions set in these terms and conditions.</p>
                    <p><b>User Obligations:</b> You must be of legal age to play this game in your region. You are responsible for maintaining the confidentiality of your account and password and for restricting access to your computer or device.</p>
                    <p><b>Disputes:</b> Any dispute related to these terms and conditions will be governed by the laws of India. All disputes will be resolved in the courts of [Your City].</p>
                    <p>We reserve the right to amend these terms at any time. Your continued use of the app signifies your acceptance of any new terms.</p>
                `;
                break;
            case 'privacy':
                title = 'Privacy Policy';
                content = `
                    <p>Your privacy is important to us. It is Tambola 69's policy to respect your privacy regarding any information we may collect from you.</p>
                    <p><b>Information We Collect:</b> We only ask for personal information when we truly need it to provide a service to you. We collect it by fair and lawful means, with your knowledge and consent.</p>
                    <p><b>How We Use Information:</b> The information we collect is used to process your game tickets, manage your winnings, and communicate with you about your account. We do not share your personally identifying information publicly or with third-parties, except when required by law.</p>
                    <p><b>Data Security:</b> We take reasonable precautions to protect the data you provide to us. However, please be aware that no method of electronic storage is 100% secure.</p>
                    <p><b>Changes to This Policy:</b> We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page.</p>
                `;
                break;
            default:
                title = 'Page Not Found';
                content = '<p>The requested page could not be found.</p>';
                break;
        }
        
        titleEl.textContent = title;
        contentEl.innerHTML = content;
        modal.style.display = 'flex';
    }
    
    // Expose the function to the global scope so onclick can use it
    window.showStaticPage = showStaticPage;


    /* ================= Presence ================= */
    function attachPresence(){
      try{
        if(myPresence){ myPresence.remove(); myPresence=null; }
      }catch(e){}
      const id = localStorage.getItem(LS_UID) || userId || ('guest_'+Math.random().toString(36).slice(2,8));
      myPresence = presenceRef.push({id, time:firebase.database.ServerValue.TIMESTAMP});
      myPresence.onDisconnect().remove();
    }
    presenceRef.on('value',snap=>{
      const n = snap.numChildren()||0;
      if(!activeRoom){
        waitingLiveText.textContent = 'Live Users: ' + n;
        liveDot.style.background = (n>0)?'#00e676':'#bdbdbd';
      }
    });

    /* ================= Auth lifecycle & OTP ================= */
    firebase.auth().onAuthStateChanged(async (u)=>{
      if(u){
        applyAuthUser(u); attachPresence();
        try{
          const snap = await db.ref('users/'+u.uid).once('value');
          const data = snap.val();
          if(data){
            myName = data.name || myName; myEmail = data.email || myEmail; myContact = u.phoneNumber || data.phone || myContact;
            myImageUrl = data.imageUrl || myImageUrl;
            setLocalProfile(u.uid, myName, myContact, myEmail, myImageUrl);
          }
          getUserBalance(u.uid).then(bal => document.getElementById('myWinnings').textContent = bal);
        }catch(e){}
      }else{
        ensureGuest(); attachPresence();
      }
    });
    
    /* ================= Share / Withdraw UI ================= */
    if(document.getElementById('withdrawBtn')){
      withdrawBtn.addEventListener('click', ()=>{
        if(!(localStorage.getItem(LS_UID) || firebase.auth().currentUser)) { showLoginModal(); return; }
        withdrawModal.style.display='flex';
      });
      cancelWithdrawBtn.addEventListener('click', ()=> withdrawModal.style.display='none');
      submitWithdrawBtn.addEventListener('click', async ()=>{
        const amt = Number(withdrawAmount.value||0);
        const dest = (withdrawDest.value||'').trim();
        if(!amt || !dest) return alert('Enter amount and UPI/Phone');
        const uid = localStorage.getItem(LS_UID) || userId || 'guest';
        const name = localStorage.getItem(LS_NAME) || myName || 'Guest';

        await ensureUserRecord(uid);
        const bal = await getUserBalance(uid);
        if(bal < amt) return alert('Insufficient balance for withdrawal.');
        const newBal = bal - amt;
        await setUserBalance(uid, newBal);

        const wref = db.ref('withdrawals').push();
        await wref.set({
          userId: uid, name, amount: amt, dest, time: firebase.database.ServerValue.TIMESTAMP, status: 'pending'
        });
        withdrawModal.style.display='none';
        document.getElementById('myWinnings').textContent = newBal;
        alert('Withdrawal request recorded. Admin will be notified.');

        withdrawalHistoryRef.child(uid).push({
          type: 'withdrawal',
          amount: amt,
          dest,
          status: 'pending',
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      });
    }

    /* ========================== ROOM SYSTEM ========================== */
    let roomListeners = [];
    let roomTicketPrice = 0;
    let roomFullHousePrize = 0;
    let currentPlayers = {};
    const friendsPrizePercentage = document.getElementById('friendsPrizePercentage');
    const priceSelection = document.getElementById('priceSelection');
    const confirmPriceBtn = document.getElementById('confirmPriceBtn');
    const roomPriceInfo = document.getElementById('roomPriceInfo');
    const roomPrice = document.getElementById('roomPrice');

    // FIX 2: Dynamic prize display for room game (90% of paid users' contribution)
    function refreshPrizeDisplay() {
        const paidCount = Object.values(currentPlayers).filter(p => p.paid).length;
        if (roomTicketPrice > 0) {
            const est = Math.round(paidCount * roomTicketPrice * 0.90);
            // Display estimated 90% prize pool for Full House on the claim button area
            friendsPrizePercentage.textContent = `Full House Prize: ₹${est} (90% Pool)`;
            
            // Update Full House claim button text if current ticket is a room ticket
            if (currentTicketGameId && !currentTicketGameId.startsWith('global-')) {
                document.querySelectorAll('.claim-button[data-prize="Full House"]').forEach(button => {
                    const claimed = button.disabled;
                    if (!claimed) {
                        button.innerHTML = `Full House ₹${est}`;
                    } else {
                        button.innerHTML = `<span class="claimed-button-text">CLAIMED</span> ₹${est}`;
                    }
                });
            }
        } else {
            friendsPrizePercentage.textContent = `Prize %: 90`;
        }
    }

    function uiSetRoomStatus(text){ roomStatusPill.textContent = text; }
    function refreshPlayers(players){
      const arr = Object.entries(players||{}).map(([uid,p])=> `${p.name||'Player'} ${p.paid?'✅':'❌'}`);
      playersListEl.innerHTML = arr.length ? ('Players: '+arr.join(' | ')) : 'Players: (none)';
    }

    async function createRoom(){
      if(!userId) { alert("Please create a profile first!"); showProfileModal(); return; }
      isHost=true;
      activeRoom = 'room_'+Math.random().toString(36).slice(2,8);
      await db.ref('rooms/'+activeRoom).set({
        host: userId,
        hostName: myName,
        status: ROOM_STATUS.WAIT,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });
      await db.ref(`rooms/${activeRoom}/players/${userId}`).set({ name: myName, paid:false });
      roomInfoEl.textContent='Room Created: '+activeRoom+' | Share this ID with friends.';
      joinRoomIdInput.style.display = 'none';
      roomBuyTicketBtn.style.display = 'none';
      startRoomGameBtn.style.display = 'block';
      startRoomGameBtn.disabled = true;
      uiSetRoomStatus('Waiting');
      if (isHost) priceSelection.style.display = 'block';
      attachRoomListeners(activeRoom);
    }

    async function joinRoomById(rid){
      if(!rid) return alert('Enter Room ID');
      if(!userId) { alert("Please create a profile first!"); showProfileModal(); return; }
      const snap = await db.ref('rooms/'+rid).once('value');
      if(!snap.exists()) return alert('Room not found');
      const data = snap.val();
      if(data.status!==ROOM_STATUS.WAIT) return alert('Room already started/closed');
      activeRoom = rid;
      isHost = (data.host === userId);
      await db.ref(`rooms/${rid}/players/${userId}`).update({ name: myName, paid:false });
      roomInfoEl.textContent = `Joined Room: ${rid} | Host: ${data.hostName || data.host} `;
      joinRoomIdInput.style.display = 'none';
      roomBuyTicketBtn.style.display = 'inline-block';
      if(isHost){
        startRoomGameBtn.style.display = 'inline-block';
        startRoomGameBtn.disabled = true;
      } else {
        startRoomGameBtn.style.display = 'none';
      }
      uiSetRoomStatus('Waiting');
      attachRoomListeners(rid);
    }

    function attachRoomListeners(rid){
      roomListeners.forEach(ref=>ref.off());
      roomListeners = [];
      const roomRef = db.ref(`rooms/${rid}`);
      const playersRef = db.ref(`rooms/${rid}/players`);
      const statusRef = db.ref(`rooms/${rid}/status`);
      const drawRef = db.ref(`rooms/${rid}/draw`);
      const priceRef = db.ref(`rooms/${rid}/ticketPrice`);
      const prizeInfoRef = db.ref(`rooms/${rid}/prizeInfo`);

      playersRef.on('value', s=>{
        const players = s.val() || {};
        currentPlayers = players;
        refreshPlayers(players);
        const amInRoom = !!players[userId];
        if(amInRoom){
          roomBuyTicketBtn.style.display = players[userId].paid ? 'none' : 'inline-block';
          if(isHost){
            startRoomGameBtn.style.display = 'inline-block';
          }
        } else {
          roomBuyTicketBtn.style.display = 'none';
          startRoomGameBtn.style.display = 'none';
        }
        const uids = Object.keys(players);
        const allPaid = uids.length>0 && uids.every(uid => players[uid].paid === true);
        if(isHost){
          startRoomGameBtn.disabled = !allPaid;
        }
        if(players[userId] && players[userId].ticket){
          currentGrid = players[userId].ticket;
          currentTicketGameId = rid;
          renderTicket(currentGrid, '#'+(players[userId].serial||'ROOM'));
          // Call updateClaimButtons here to ensure correct buttons are shown for a room ticket
          gamePrizesRef.child(rid).once('value').then(snap => {
              updateClaimButtons(snap.val() || []);
          });
        }
        refreshPrizeDisplay(); // FIX 2: Refresh prize on player change
      });
      roomListeners.push(playersRef);

      statusRef.on('value', s=>{
        const st = s.val();
        if(st===ROOM_STATUS.WAIT) uiSetRoomStatus('Waiting');
        else if(st===ROOM_STATUS.START) {
            uiSetRoomStatus('Started');
            hideGameOverMessage();
        }
        else if(st===ROOM_STATUS.END) {
            uiSetRoomStatus('Ended');
            showGameOverMessage();
        }
      });
      roomListeners.push(statusRef);

      drawRef.on('value', s=>{
        const d = s.val() || {};
        const cur = d.current;
        const hist = d.history || [];
        if(cur){ 
            latestNumber.textContent = 'Number: ' + cur; 
            highlightBoard(cur, hist); 
            // FIX 1: Auto-claim check for room game
            checkAndAttemptAutoClaim(); 
        }
        historyEl.textContent = hist.length ? hist.join(', ') : 'None';
        waitingTitle.textContent = (d && d.startedAt) ? 'Room Draw Live' : 'Waiting for Draw...';
        waitingDesc.textContent = (d && d.startedAt) ? `Room ${rid} playing` : 'Room waiting';
      });
      roomListeners.push(drawRef);

      priceRef.on('value', s=>{
        const price = s.val() || 0;
        roomTicketPrice = price;
        if(price > 0){
          roomPrice.textContent = price;
          roomPriceInfo.style.display='block';
          roomBuyTicketBtn.textContent = `Buy Ticket ₹${price}`;
          if(isHost) priceSelection.style.display='none';
        } else {
          roomPriceInfo.style.display='none';
          if(isHost) priceSelection.style.display='block';
        }
        refreshPrizeDisplay();
      });
      roomListeners.push(priceRef);

      prizeInfoRef.on('value', s=>{
        const pi = s.val() || {};
        roomFullHousePrize = pi.fullHousePool || 0;
        refreshPrizeDisplay(); // FIX 2: Refresh prize on host setting pool info
      });
      roomListeners.push(prizeInfoRef);
    }

    async function roomBuyTicket(){
      if(!activeRoom) return alert('Create or Join a room first');
      if(roomTicketPrice <=0) return alert('Wait for host to set ticket price.');
      alert(`Payment of ₹${roomTicketPrice} Successful!`);
      const grid = generateTicketMatrix();
      const serial = Math.floor(Math.random()*100000);
      const uid = userId;
      
      await db.ref(`rooms/${activeRoom}/players/${uid}`).update({ 
        paid:true, 
        ticket: grid, 
        serial
      });
      
      currentGrid = grid;
      currentTicketGameId = activeRoom;
      localStorage.removeItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId);
      renderTicket(currentGrid, '#'+serial);
      saveTicketToDB({ ticket: grid, serial, gameId: activeRoom, gameName: `Room ${activeRoom}` }, activeRoom);
      
      // Update the prize buttons for the new room ticket (will only show FH)
      updateClaimButtons([]);
      refreshPrizeDisplay(); // FIX 2: Recalculate and show new prize with new paid player
    }

    async function startRoomGame(){
      if(!isHost) return alert('Only host can start.');
      const plySnap = await db.ref(`rooms/${activeRoom}/players`).once('value');
      const players = plySnap.val()||{};
      const uids = Object.keys(players);
      const allPaid = uids.length>0 && uids.every(uid => players[uid].paid === true);
      if(!allPaid) return alert('All players must buy ticket first.');
      
      // FIX 2: Set the room prize details (90% of total pool)
      const ticketPriceSnap = await db.ref(`rooms/${activeRoom}/ticketPrice`).once('value');
      const TICKET_PRICE = ticketPriceSnap.val() || 0;
      if(TICKET_PRICE <=0) return alert('Set ticket price first.');
      const totalTickets = uids.length;
      const totalPool = totalTickets * TICKET_PRICE;
      const fullHousePrize = Math.round(totalPool * 0.90); // 90% for FH

      const nums = shuffle(Array.from({length:90},(_,i)=>i+1));
      await db.ref(`rooms/${activeRoom}`).update({ status: ROOM_STATUS.START });
      // Store pool info for later
      await db.ref(`rooms/${activeRoom}/prizeInfo`).set({ fullHousePool: fullHousePrize, totalPlayers: totalTickets }); 
      await db.ref(`rooms/${activeRoom}/draw`).set({ current:null, history:[], startedAt:Date.now(), intervalMs:DRAW_INTERVAL_MS, host: userId });
      let idx=0;
      clearInterval(drawTimer);
      drawTimer = setInterval(async ()=>{
        if(idx>=nums.length){
          clearInterval(drawTimer);
          await db.ref(`rooms/${activeRoom}`).update({ status: ROOM_STATUS.END });
          return;
        }
        const n = nums[idx++];
        const ref = db.ref(`rooms/${activeRoom}/draw`);
        const snap = await ref.once('value');
        const d = snap.val()||{history:[]};
        const hist = d.history || [];
        hist.push(n);
        await ref.update({ current:n, history:hist });
        applyAutoTickForNumber(n); // Simplified to just the number
        await checkAndAttemptAutoClaim(); // New auto-claim function
      }, DRAW_INTERVAL_MS);
    }

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
    
    // Updated applyAutoTickForNumber to be more robust
    function applyAutoTickForNumber(n){
      const doAuto = autoTickToggle.checked;
      if(!doAuto || !currentGrid || !currentTicketGameId) return;
      // Fetch latest ticks from storage for safety
      const ticksNow = JSON.parse(localStorage.getItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId)||'[]');
      const cells = ticketEl.querySelectorAll('.ticket-cell');
      cells.forEach(c=>{
        const val = Number(c.textContent);
        if(!isNaN(val) && val === n){
          if(!c.classList.contains('ticked')) c.classList.add('ticked');
          if(!ticksNow.includes(n)) { ticksNow.push(n); }
        }
      });
      localStorage.setItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId, JSON.stringify(ticksNow));
    }

    if(createRoomBtn) createRoomBtn.addEventListener('click', createRoom);
    if(joinRoomBtn) joinRoomBtn.addEventListener('click', ()=> {
        joinRoomIdInput.style.display = 'block';
        joinRoomBtn.textContent = 'Join Room';
        joinRoomBtn.onclick = () => joinRoomById(joinRoomIdInput.value.trim());
    });
    if(roomBuyTicketBtn) roomBuyTicketBtn.addEventListener('click', roomBuyTicket);
    if(startRoomGameBtn) startRoomGameBtn.addEventListener('click', startRoomGame);
    if(confirmPriceBtn) confirmPriceBtn.addEventListener('click', async () => {
        if(!isHost || !activeRoom) return;
        const price = Number(document.getElementById('priceSelect').value);
        if(price > 0){
            await db.ref(`rooms/${activeRoom}`).update({ ticketPrice: price });
        }
    });
/* ================= Initial setup ================= */
 ensureGuest();
 attachPresence();
 uiSetRoomStatus('No Room');
 userTicketContainer.style.display='none';
 latestNumber.textContent='—';
 historyEl.textContent='None';

 // Dynamically add progress bars below buy buttons
 if (buyTicketBtnTop) {
     const progressBarTop = document.createElement('progress');
     progressBarTop.id = 'progressBarTop';
     progressBarTop.max = 100;
     progressBarTop.value = 0;
     progressBarTop.style.width = '100%';
     progressBarTop.style.marginTop = '10px';
     buyTicketBtnTop.parentNode.insertBefore(progressBarTop, buyTicketBtnTop.nextSibling);
 }
 if (buyTicketBtnBottom) {
     const progressBarBottom = document.createElement('progress');
     progressBarBottom.id = 'progressBarBottom';
     progressBarBottom.max = 100;
     progressBarBottom.value = 0;
     progressBarBottom.style.width = '100%';
     progressBarBottom.style.marginTop = '10px';
     buyTicketBtnBottom.parentNode.insertBefore(progressBarBottom, buyTicketBtnBottom.nextSibling);
 }
 
 /* cleanup listeners on unload */
 window.addEventListener('beforeunload', ()=>{
 try{
 if(myPresence) myPresence.remove();
 if(activeRoom) db.ref(`rooms/${activeRoom}/players/${(localStorage.getItem(LS_UID)||'guest')}`).remove();
 }catch(e){}
 });
 
  
  /* ============ AI VOICE ANNOUNCER (FIX 3: Proper function on all devices) ============ */
  (function(){
  let VOICE_ENABLED = true;
  let lastSpoken = null;
  let _primed = false;
  
  // FIX 3: Prime speech (needed for mobile/browser policy)
  function primeVoice(){
    if (_primed || !window.speechSynthesis) return;
    try {
      // Attempt a dummy speak to initialize the engine on user interaction
      const dummy = new SpeechSynthesisUtterance(' '); 
      window.speechSynthesis.speak(dummy);
      window.speechSynthesis.cancel();
      _primed = true;
      // Remove listeners once primed
      window.removeEventListener('click', primeVoice);
      window.removeEventListener('touchstart', primeVoice);
    } catch(e){
      console.log("Voice priming failed:", e);
    }
  }
  
  // FIX 3: Attach listeners to the window to prime on first user interaction
  window.addEventListener('click', primeVoice, { once:true, passive:true });
  window.addEventListener('touchstart', primeVoice, { once:true, passive:true });
  
  // Dialogues mapping
  const tambolaDialog = {
  1: "single number, one, top of the house",
  3: "single number, three, सब गोलमाल है",
  4: "single number, four, मुर्गी चोर",
  5: "single number, five, ये नंबर मुझे दे दे ठाकुर",
  7: "single number seven, lucky for all, सात फेरे",
  10: "Badmash",
  19: "one nine, nineteen, Last of the teen",
  21: "two one, twenty one, marriageable age",
  24: "दिल का चोर, two and four, twenty four",
  25: "silver jubilee",
  26: "republic day",
  28: "pull the gate",
  29: "rise and shine",
  36: "flirty wife",
  41: "Alli Baba, चालीस चोर",
  46: "choke chhke",
  47: "four and seven, forty seven, Aajadi",
  48: "door and gate, forty eight",
  50: "Golden Jubilee",
  53: "smile is free, five and three, fifty three",
  65: "लाखों में एक है मेरी wife",
  66: "all the sixes, six and six, all the six",
  69: "six and nine, sixty nine, Maje Maro yaro",
  74: "open the door",
  75: "shuru karo deive",
  79: "old wine",
  82: "down with flu",
  85: "I still live",
  90: "last number of the house"
  };
  
  // Speak tambola number
  window.speakTambolaNumber = function(number) {
  if (!VOICE_ENABLED || !window.speechSynthesis || !_primed) return;
  const msg = new SpeechSynthesisUtterance();
  msg.text = tambolaDialog[number] || `Number ${number}`;
  msg.lang = 'en-IN';
  msg.rate = 1 + Math.random() * 0.2;
  msg.pitch = 1 + Math.random() * 0.3;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(msg);
  };
  
  window.speakTambolaSentence = function(sentence){
  if (!VOICE_ENABLED || !window.speechSynthesis || !_primed) return;
  const msg = new SpeechSynthesisUtterance(sentence);
  msg.lang='en-IN';
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(msg);
  };
  
  // Watch #latestNumber text changes to auto speak and auto-tick
  const target = document.getElementById('latestNumber');
  if (target) {
  const obs = new MutationObserver(async () => {
  const text = target.textContent || '';
  const match = text.match(/(\d+)/);
  if (!match) return;
  const num = parseInt(match[1], 10);
  if (!num) return;
  // speak
  speakTambolaNumber(num);
  // auto-tick
  applyAutoTickForNumber(num);
  // attempt auto-claims
  await checkAndAttemptAutoClaim(); // Changed from tryAutoClaims()
  });
  obs.observe(target, { childList:true, characterData:true, subtree:true });
  }
  })();
  
  /* Watch Live handler (keeps simple embed) */
  (function(){
  watchLiveBtn.addEventListener('click', function(){
  const VIDEO_ID = "YOUR_YOUTUBE_LIVE_VIDEO_ID"; // ⚠️ REPLACE with your live video ID
  if(!VIDEO_ID || VIDEO_ID === "YOUR_YOUTUBE_LIVE_VIDEO_ID"){
  alert("Please set your YouTube Live Video ID in the code (replace YOUR_YOUTUBE_LIVE_VIDEO_ID).");
  return;
  }
  liveFrame.src = "https://www.youtube.com/embed/" + VIDEO_ID + "?autoplay=1&rel=0";
  liveVideoBox.style.display = "block";
  watchLiveBtn.style.display = "none";
  });
  })();
  
  /* 🎵 Music Control */
  let isUserMuted = false;
  
  // Firebase listener
  musicRef.on("value", snap=>{
  const data = snap.val()||{};
  if(!data.url) return;
  if(player.src !== data.url) player.src = data.url;
  
  // Music logic: Play if Firebase says 'isPlaying' AND user hasn't manually muted
  if(data.isPlaying && !isUserMuted){
    player.play().catch(e => {
        // Autoplay failed, likely due to browser policy. User has to click play.
        console.log("Autoplay failed, user interaction required.", e);
    });
    musicBtn.style.opacity = "1";
  } else {
    player.pause();
    if(isUserMuted) musicBtn.style.opacity = "0.5";
    else musicBtn.style.opacity = "1";
  }
  });
  
  // User toggle button
  musicBtn.addEventListener("click", ()=>{
  if(player.paused){
    isUserMuted = false;
    // Attempt to override Firebase mute by playing (if a URL is set)
    if(player.src) player.play().catch(()=>{}); 
    musicBtn.style.opacity="1";
  } else {
    isUserMuted = true;
    player.pause();
    musicBtn.style.opacity="0.5";
  }
  });


  /* ============================================= */
  /* 🔥🔥 ANIMATION AND LOGIN FLOW LOGIC 🔥🔥 */
  /* ============================================= */
  const animationContainer = document.getElementById('animationContainer');
  const mainGameContainer = document.getElementById('mainGameContainer');
  const animationTicket = document.getElementById('animationTicket');
  const animationLoginBox = document.getElementById('animationLoginBox');
  const spinnerNumber = document.querySelector('.spinner-number');
  const finalNumber = document.querySelector('.final-number');
  const spinnerContainer = document.querySelector('.spinner-container');
  const saveDetailsBtn = document.getElementById('saveDetailsBtn');
  
  // Function to transition to the main game UI
  function showGameUI() {
    gsap.to(animationContainer, { autoAlpha: 0, duration: 1, onComplete: () => {
        animationContainer.style.display = 'none';
        mainGameContainer.style.display = 'block';
        gsap.fromTo(mainGameContainer, { autoAlpha: 0 }, { autoAlpha: 1, duration: 1 });
    }});
  }

  // Check if a user is already authenticated
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
        // User is logged in, skip animation and go to game UI
        animationContainer.style.display = 'none';
        mainGameContainer.style.display = 'block';
    } else {
        // User is not logged in, start the animation sequence
        // We only start the animation if the container is present on the page
        if(animationContainer) startAnimationSequence();
    }
  });

  // Start the animation sequence
  function startAnimationSequence() {
    gsap.set(animationTicket, { scale: 0, opacity: 0 });
    gsap.set(finalNumber, { scale: 0, opacity: 0 });
    gsap.set(animationLoginBox, { scale: 0, autoAlpha: 0 });

    const tl = gsap.timeline({ defaults: { duration: 1, ease: "power2.inOut" } });

    tl.to(animationTicket, { scale: 1, opacity: 1, duration: 1.5, ease: "back.out(1.7)" })
      .to(spinnerContainer, { autoAlpha: 1, scale: 1, duration: 0.8 }, "-=0.5");

    // Spinner number animation
    tl.to({}, {
      duration: 4, onUpdate: () => {
        spinnerNumber.textContent = Math.floor(Math.random() * 90) + 1;
      }
    });

    // Jump final number
    tl.to({}, {
      duration: 0.5, onComplete: () => {
        spinnerNumber.textContent = "69"; // final number
      }
    })
      .to(finalNumber, { opacity: 1, scale: 1, y: 0, duration: 0.5, ease: "back.out(1.7)" })
      .to(finalNumber, { scale: 1, duration: 0.3, ease: "elastic.out(1,0.3)", onComplete: confetti })
      .to(spinnerContainer, { autoAlpha: 0, scale: 0.5, duration: 1 }, "-=1.5");

    // Show login box at the end of the animation
    tl.add(function () {
      gsap.to(animationTicket, {
        autoAlpha: 0, scale: 0.9, duration: 1, onComplete: () => {
          animationTicket.style.display = 'none';
          animationLoginBox.style.display = 'block';
          gsap.to(animationLoginBox, { autoAlpha: 1, scale: 1, duration: 1.5, ease: "power2.out" });
        }
      });
    }, "+=1");
  }

  // Dummy login listeners for the animation login box
  document.querySelectorAll('.animation-login-button').forEach(button => {
    button.addEventListener('click', () => {
        // Here you would implement your actual Google/Facebook auth logic
        // For this example, we'll just simulate a successful login
        alert("Simulating successful login! Redirecting to game.");
        showGameUI();
    });
  });

  // Confetti effect
  function confetti() {
    for (let i = 0; i < 100; i++) {
        let div = document.createElement('div');
        div.classList.add('confetti');
        div.style.background = `hsl(${Math.random() * 360},100%,50%)`;
        div.style.left = '50%';
        div.style.top = '50%';
        document.body.appendChild(div);
        gsap.to(div, { x: (Math.random() - 0.5) * 500, y: (Math.random() - 0.5) * 500, duration: 2, opacity: 0, ease: "power1.out", onComplete: () => div.remove() });
    }
  }
  
  /* --- FIX: Simple Recaptcha Placeholder --- */
  function ensureRecaptcha(){
    if (typeof firebase.auth.RecaptchaVerifier !== 'undefined' && !recaptchaVerifier) {
      recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        'size': 'invisible',
        'callback': (response) => {
          // reCAPTCHA solved, proceed with phone authentication
        },
        'expired-callback': () => {
          // reCAPTCHA expired.
        }
      });
      // Render the invisible recaptcha on page load
      recaptchaVerifier.render().then(widgetId => {
        // console.log("Recaptcha rendered", widgetId);
      });
    }
  }
  
  // --- FIX: Phone Auth/OTP Logic ---
  if(sendOtpBtn){
    sendOtpBtn.addEventListener('click', async () => {
      const phoneNumber = phoneInput.value.trim();
      if (!phoneNumber) {
          alert("Please enter a phone number.");
          return;
      }
      
      // Check if reCAPTCHA is ready (ensureRecaptcha() is called on modal show)
      if (!recaptchaVerifier) {
          alert("Please wait for reCAPTCHA to load or ensure it's loaded in a secure context (HTTPS/localhost).");
          ensureRecaptcha();
          return;
      }

      try {
          confirmationResult = await firebase.auth().signInWithPhoneNumber(phoneNumber, recaptchaVerifier);
          alert('OTP sent to your phone!');
      } catch (error) {
          console.error("Error during signInWithPhoneNumber:", error);
          alert('Error sending OTP: ' + error.message);
          // Reset reCAPTCHA if visible
          if(typeof grecaptcha !== 'undefined') grecaptcha.reset(recaptchaVerifier.widgetId);
      }
    });
  }

  if(verifyOtpBtn){
    verifyOtpBtn.addEventListener('click', async () => {
        const otp = otpInput.value.trim();
        if (!otp) {
            alert("Please enter the OTP.");
            return;
        }

        try {
            const result = await confirmationResult.confirm(otp);
            const user = result.user;
            // Successfully signed in
            applyAuthUser(user);
            hideLoginModal();

            // Check if user profile exists in /users node
            const userSnap = await db.ref('users/' + user.uid).once('value');
            if (!userSnap.exists() || !userSnap.val().name) {
                // New user or missing profile details, prompt for details
                document.getElementById('loginModal').style.display='flex';
                detailsStep.style.display = 'block';
                phoneInput.disabled = true;
                otpInput.disabled = true;
                sendOtpBtn.disabled = true;
                verifyOtpBtn.disabled = true;
                // Pre-fill if auth gives a name/email (not common with phone auth)
                nameInput.value = user.displayName || '';
                emailInput.value = user.email || '';
            } else {
                // Existing user, close modal
                detailsStep.style.display = 'none';
            }
        } catch (error) {
            console.error("Error during OTP confirmation:", error);
            alert('Error verifying OTP: ' + error.message);
        }
    });
  }

  if(saveDetailsBtn){
    saveDetailsBtn.addEventListener('click', async () => {
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const user = firebase.auth().currentUser;

      if (!name || !email) {
          alert("Please fill in your Name and Email.");
          return;
      }
      
      // Save details to Firebase Realtime Database
      try {
          await saveProfileData(user.uid, name, user.phoneNumber, email, myImageUrl);
          hideLoginModal();
      } catch (error) {
          console.error("Error saving user details:", error);
          alert('Failed to save details: ' + error.message);
      }
    });
  }
      
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("Service Worker registered:", reg))
      .catch(err => console.log("Service Worker error:", err));
  }
</script>
</body>
</html>
