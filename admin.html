<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Admin Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
        }

        .loader {
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            color: #4CAF50;
            margin-top: 15px;
            font-size: 1.2em;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            box-sizing: border-box;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .container.visible {
            display: block;
            opacity: 1;
        }

        header {
            background-color: #1f1f1f;
            color: #4CAF50;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #4CAF50;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-section {
            background-color: #1f1f1f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        h2 {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-top: 0;
            color: #4CAF50;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #bbb;
        }

        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            box-sizing: border-box;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
            color: #e0e0e0;
        }
        
        .input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .input-group input {
            flex-grow: 1;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 5px;
            width: 100%;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #007bff;
        }

        .btn-secondary:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-ghost {
            background: none;
            color: #4CAF50;
            border: 1px solid #4CAF50;
            padding: 5px 10px;
            margin: 0 5px 0 0;
            width: auto;
        }
        
        .btn-ghost:hover {
            background-color: #2a3a2b;
        }

        .status-display {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-idle { background-color: #555; color: white; }
        .status-started { background-color: #28a745; color: white; }
        .status-stopped, .status-gameOver { background-color: #dc3545; color: white; }

        .tambola-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            margin-top: 15px;
        }

        .board-cell {
            background-color: #333;
            color: #e0e0e0;
            padding: 5px;
            text-align: center;
            border-radius: 3px;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
        }

        .board-cell.drawn {
            background-color: #4CAF50;
            color: #121212;
            font-weight: bold;
        }
        
        .winner-card {
            border: 1px solid #4CAF50;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #252525;
        }
        
        .winner-card input {
            margin-bottom: 5px;
        }

        .claims-section, .withdrawals-section {
            background-color: #1f1f1f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .claim-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #555;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #252525;
        }
        
        .muted {
            color: #999;
            font-size: 0.9em;
        }
        
        .table-small {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-small th, .table-small td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        .table-small th {
            color: #4CAF50;
        }
        
        .prize-management {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .tab-button {
            background-color: #333;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tab-button.active {
            background-color: #4CAF50;
        }

        .tab-content {
            display: none;
            background-color: #1f1f1f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .tab-content.active {
            display: block;
        }

        /* NEW: Unclaimed Prize Box Button */
        .btn-unclaimed {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
            padding: 12px 16px;
            font-size: 16px;
            margin-top: 10px;
        }
        .btn-unclaimed:hover {
            background: #c3e6cb;
        }
        .btn-unclaimed:disabled {
            background: #aaa;
            color: #666;
            cursor: not-allowed;
        }
        .unclaimed-status {
            margin-top: 8px;
            font-size: 0.9em;
            color: #aaa;
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="loading-screen">
        <div>
            <div class="loader"></div>
            <div class="loader-text">Loading Admin Panel...</div>
        </div>
    </div>

    <div id="main-content" class="container">
        <header>
            <h1>Tambola Live Game Admin Panel</h1>
            <p>Live Users: <span id="liveUserCountDisplay">0</span> | Total Tickets Sold: <span id="totalTicketsSoldDisplay">0</span></p>
        </header>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'GameControl')">Game Control</button>
            <button class="tab-button" onclick="openTab(event, 'ClaimsWithdrawals')">Claims & Withdrawals</button>
            <button class="tab-button" onclick="openTab(event, 'GlobalSettings')">Global Settings</button>
            <button class="tab-button" onclick="openTab(event, 'UsersTickets')">Users & Tickets</button>
        </div>

        <div id="GameControl" class="tab-content active">
            <div class="dashboard-grid">
                
                <div class="game-section">
                    <h2>Current Game</h2>

                    <!-- NEW: UNCLAIMED PRIZE BOX BUTTON -->
                    <div class="control-group">
                        <button id="unclaimedPrizeBtn" class="btn-unclaimed" onclick="toggleUnclaimedPrizeBox()" disabled>
                            Enable Claim Button on All Phones
                        </button>
                        <div class="unclaimed-status">Status: <span id="unclaimedStatus">Game Not Started</span></div>
                        <div class="muted">गेम शुरू होने के बाद क्लिक करें → सभी यूज़र्स को Claim बटन दिखेगा</div>
                    </div>

                    <div class="control-group">
                        <label>Status:</label>
                        <div id="currentStatusDisplay" class="status-display status-idle">Idle</div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-secondary" onclick="startGame('current')">Start</button>
                            <button class="btn-danger" onclick="stopGame('current')">Stop</button>
                            <button onclick="resetGame('current')">Reset</button>
                        </div>
                        <button onclick="clearGameClaimsAndTickets('current')" style="background-color:#d4af37; margin-top: 10px;">Fix: Clear Claims & Tickets</button>
                    </div>

                    <div class="control-group">
                        <label>Prize Percentage (%) / Current: <span id="currentPrizeDisplay">0%</span></label>
                        <input type="number" id="currentPrizeInput" min="1" max="100" placeholder="Enter % (1-100)">
                        <button onclick="updatePrize('current')">Update Prize %</button>
                    </div>

                    <div class="control-group">
                        <label>Tickets Left / Current: <span id="currentTicketsDisplay">0</span></label>
                        <input type="number" id="currentTicketsInput" min="0" placeholder="Enter tickets left">
                        <button onclick="updateTickets('current')">Update Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Total Spots / Current: <span id="currentSpotsDisplay">0</span></label>
                        <input type="number" id="currentSpotsInput" min="0" placeholder="Enter total spots">
                        <button onclick="updateSpots('current')">Update Spots</button>
                    </div>

                    <div class="control-group">
                        <label>Countdown Timer / Current: <span id="currentCountdownDisplay">00:00:00</span></label>
                        <div class="input-group">
                            <input type="number" id="currentCountdownInput_h" placeholder="H" min="0">
                            <input type="number" id="currentCountdownInput_m" placeholder="M" min="0" max="59">
                            <input type="number" id="currentCountdownInput_s" placeholder="S" min="0" max="59">
                        </div>
                        <button onclick="updateCountdown('current')">Set Countdown</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Broadcast Live Number:</label>
                        <input type="number" id="currentNumberInput" min="1" max="90" placeholder="Enter number (1-90)">
                        <button onclick="broadcastNumber('current')">Broadcast Number</button>
                        <button class="btn-secondary" onclick="autoDrawNumber('current')">Start Auto Draw (30s)</button>
                    </div>
                    
                    <h3>Tambola Board</h3>
                    <div id="currentTambolaBoard" class="tambola-board"></div>
                    
                    <h3>Game Claims</h3>
                    <div id="currentGameClaimsList"></div>
                    
                    <h3>Sold Tickets</h3>
                    <div id="currentTicketsList"></div>
                </div>

                <div class="game-section">
                    <h2>Next Game</h2>
                    <div class="control-group">
                        <label>Status:</label>
                        <div id="nextStatusDisplay" class="status-display status-idle">Idle</div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-secondary" onclick="startGame('next')">Start</button>
                            <button class="btn-danger" onclick="stopGame('next')">Stop</button>
                            <button onclick="resetGame('next')">Reset</button>
                        </div>
                        <button onclick="clearGameClaimsAndTickets('next')" style="background-color:#d4af37; margin-top: 10px;">Fix: Clear Claims & Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Prize Percentage (%) / Current: <span id="nextPrizeDisplay">0%</span></label>
                        <input type="number" id="nextPrizeInput" min="1" max="100" placeholder="Enter % (1-100)">
                        <button onclick="updatePrize('next')">Update Prize %</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Tickets Left / Current: <span id="nextTicketsDisplay">0</span></label>
                        <input type="number" id="nextTicketsInput" min="0" placeholder="Enter tickets left">
                        <button onclick="updateTickets('next')">Update Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Total Spots / Current: <span id="nextSpotsDisplay">0</span></label>
                        <input type="number" id="nextSpotsInput" min="0" placeholder="Enter total spots">
                        <button onclick="updateSpots('next')">Update Spots</button>
                    </div>

                    <div class="control-group">
                        <label>Countdown Timer / Current: <span id="nextCountdownDisplay">00:00:00</span></label>
                        <div class="input-group">
                            <input type="number" id="nextCountdownInput_h" placeholder="H" min="0">
                            <input type="number" id="nextCountdownInput_m" placeholder="M" min="0" max="59">
                            <input type="number" id="nextCountdownInput_s" placeholder="S" min="0" max="59">
                        </div>
                        <button onclick="updateCountdown('next')">Set Countdown</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Broadcast Live Number:</label>
                        <input type="number" id="nextNumberInput" min="1" max="90" placeholder="Enter number (1-90)">
                        <button onclick="broadcastNumber('next')">Broadcast Number</button>
                        <button class="btn-secondary" onclick="autoDrawNumber('next')">Start Auto Draw (30s)</button>
                    </div>
                    
                    <h3>Tambola Board</h3>
                    <div id="nextTambolaBoard" class="tambola-board"></div>
                    
                    <h3>Game Claims</h3>
                    <div id="nextGameClaimsList"></div>
                    
                    <h3>Sold Tickets</h3>
                    <div id="nextTicketsList"></div>
                </div>

                <div class="game-section">
                    <h2>Friends Room Control</h2>
                    <div class="control-group">
                        <label>Select Room:</label>
                        <div class="input-group">
                            <input type="text" id="roomSearch" placeholder="Search/Filter Room (e.g., Room101)" oninput="filterRooms()">
                            <select id="roomDropdown" onchange="changeRoom()"></select>
                        </div>
                        <div id="friendsStatusDisplay" class="status-display status-idle">Idle</div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-secondary" onclick="startGame('friends')">Start</button>
                            <button class="btn-danger" onclick="stopGame('friends')">Stop</button>
                            <button onclick="resetGame('friends')">Reset</button>
                        </div>
                        <button onclick="clearGameClaimsAndTickets('friends')" style="background-color:#d4af37; margin-top: 10px;">Fix: Clear Claims & Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Prize Percentage (%) / Current: <span id="friendsPrizeDisplay">0%</span></label>
                        <input type="number" id="friendsPrizeInput" min="1" max="100" placeholder="Enter % (1-100)">
                        <button onclick="updatePrize('friends')">Update Prize %</button>
                    </div>

                    <div class="control-group">
                        <label>Tickets Left / Current: <span id="friendsTicketsDisplay">0</span></label>
                        <input type="number" id="friendsTicketsInput" min="0" placeholder="Enter tickets left">
                        <button onclick="updateTickets('friends')">Update Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Total Spots / Current: <span id="friendsSpotsDisplay">0</span></label>
                        <input type="number" id="friendsSpotsInput" min="0" placeholder="Enter total spots">
                        <button onclick="updateSpots('friends')">Update Spots</button>
                    </div>

                    <div class="control-group">
                        <label>Countdown Timer / Current: <span id="friendsCountdownDisplay">00:00:00</span></label>
                        <div class="input-group">
                            <input type="number" id="friendsCountdownInput_h" placeholder="H" min="0">
                            <input type="number" id="friendsCountdownInput_m" placeholder="M" min="0" max="59">
                            <input type="number" id="friendsCountdownInput_s" placeholder="S" min="0" max="59">
                        </div>
                        <button onclick="updateCountdown('friends')">Set Countdown</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Broadcast Live Number:</label>
                        <input type="number" id="friendsNumberInput" min="1" max="90" placeholder="Enter number (1-90)">
                        <button onclick="broadcastNumber('friends')">Broadcast Number</button>
                        <button class="btn-secondary" onclick="autoDrawNumber('friends')">Start Auto Draw (30s)</button>
                    </div>

                    <h3>Tambola Board</h3>
                    <div id="friendsTambolaBoard" class="tambola-board"></div>
                    
                    <h3>Game Claims</h3>
                    <div id="friendsGameClaimsList"></div>
                    
                    <h3>Sold Tickets</h3>
                    <div id="friendsTicketsList"></div>
                </div>
            </div>

            <div class="game-section">
                <h2>Global Game Actions (CRITICAL FIXES)</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="startNewGameForAll()" class="btn-secondary" style="background-color: #28a745; flex: 1;">
                        Start New Game for All (Global Claims/Tickets Reset)
                    </button>
                    <button onclick="endAllGamesAndResetTickets()" class="btn-danger" style="flex: 1;">
                        Game Over & Reset All Tickets (Global Claims/Tickets Clear)
                    </button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="game-section">
                    <h2>Winners Management</h2>
                    <div class="control-group">
                        <label>Game Select:</label>
                        <select id="winnersGameSelect" onchange="loadWinnersForm(this.value)">
                            <option value="current">Current Game</option>
                            <option value="next">Next Game</option>
                            <option value="friends">Friends Game</option>
                        </select>
                        <div id="currentWinnersForm" style="margin-top: 10px;"></div>
                        <button onclick="saveAllWinners(document.getElementById('winnersGameSelect').value)">Save All Winners</button>
                    </div>
                </div>
                
                <div class="game-section">
                    <h2>Global Prize Amounts (₹)</h2>
                    <div id="prizeManagementContainer" class="prize-management">
                        </div>
                    <div class="muted" id="prizeUpdateMessage" style="margin-top: 10px;"></div>
                    <button onclick="savePrizes()">Update Global Prizes</button>
                </div>
            </div>
        </div>

        <div id="ClaimsWithdrawals" class="tab-content">
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                
                <div class="claims-section">
                    <h2>Live Claims Management</h2>
                    <button id="toggleClaimsButton" onclick="toggleClaimsView()" class="btn-secondary" style="width: auto; margin-bottom: 15px;">View All Claims</button>
                    <div id="claimsList">
                        </div>
                </div>

                <div class="withdrawals-section">
                    <h2>Withdrawal Requests</h2>
                    <div id="withdrawalsList">
                        </div>
                </div>
            </div>
        </div>
        
        <div id="GlobalSettings" class="tab-content">
            <div class="dashboard-grid">
                
                <div class="game-section">
                    <h2>Notifications</h2>
                    <div class="control-group">
                        <label>Message:</label>
                        <textarea id="notifyMessage" placeholder="Enter notification message..."></textarea>
                    </div>
                    <div class="control-group">
                        <label>Target User ID (Optional):</label>
                        <input type="text" id="notifyTo" placeholder="User ID (e.g., U123456)">
                    </div>
                    <div class="control-group" style="border: none;">
                        <input type="checkbox" id="notifyBroadcast" checked>
                        <label for="notifyBroadcast" style="display: inline; font-weight: normal;">Broadcast to all users</label>
                    </div>
                    <button onclick="sendNotification()">Send Notification</button>
                </div>
                
                <div class="game-section">
                    <h2>Music Control</h2>
                    <label>YouTube/SoundCloud URL:</label>
                    <input type="text" id="musicUrlInput" placeholder="Enter music URL">
                    <button onclick="saveMusicUrl()">Save Music URL</button>
                    <button id="toggleMusicBtn" class="btn-secondary" onclick="toggleMusic()" style="margin-top: 10px;">Play</button>
                </div>
                
                <div class="game-section">
                    <h2>Video Control</h2>
                    <label>YouTube Video ID or Embed URL:</label>
                    <input type="text" id="videoUrlInput" placeholder="Enter video URL or ID">
                    <button onclick="saveVideoUrl()">Save Video URL</button>
                    <button id="toggleVideoBtn" class="btn-secondary" onclick="toggleVideo()" style="margin-top: 10px;">प्ले</button>
                </div>
                
                <div class="game-section" style="grid-column: 1 / -1;">
                    <h2>Slider/Banner Control</h2>
                    <p>Current Index: <span id="currentIndexDisplay">0</span> | Speed: <span id="speedDisplay">0 ms</span></p>
                    <div class="control-group">
                        <label>Set Auto-Play Speed (ms):</label>
                        <input type="number" id="speedInput" placeholder="e.g., 5000 for 5 seconds" min="500">
                        <button onclick="setSpeed()">Set Speed</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Manual Controls:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="toggleSliderBtn" class="btn-secondary" onclick="toggleSliderPlay()">Play</button>
                            <button onclick="prevSlide()">Prev</button>
                            <button onclick="nextSlide()">Next</button>
                            <input type="number" id="gotoIndexInput" placeholder="Go To Index" style="width: 100px;">
                            <button onclick="goToSlide()">Go</button>
                        </div>
                    </div>
                    
                    <h3>Slides Configuration</h3>
                    <table style="width: 100%; margin-top: 10px; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 120px;">Actions</th>
                                <th>Image URL</th>
                                <th>Link URL</th>
                                <th>Overlay Text</th>
                                <th>Button (Text / Link)</th>
                                <th>Size (Width / Height)</th>
                            </tr>
                        </thead>
                        <tbody id="slidesTbody">
                            </tbody>
                    </table>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="addSlideRow()" style="background-color: #007bff; flex: 1;">+ Add Slide</button>
                        <button onclick="saveSlidesAdvanced()" style="flex: 1;">Save All Slides</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="UsersTickets" class="tab-content">
            <div class="dashboard-grid">
                <div class="game-section">
                    <h2>All Users (Balance)</h2>
                    <div id="usersTicketsList">
                        </div>
                </div>
                </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
    // === YOUR FIREBASE CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyAphHTM4faH7_FVXdnootp4NipZd3vtEck",
      authDomain: "tambola69-9dc8f.firebaseapp.com",
      databaseURL: "https://tambola69-9dc8f-default-rtdb.firebaseio.com",
      projectId: "tambola69-9dc8f",
      storageBucket: "tambola69-9dc8f.firebasestorage.app",
      messagingSenderId: "413290158586",
      appId: "1:413290158586:web:c4c6d6d224c96a7487ec43",
      measurementId: "G-TM68JPXH18"
    };

    let db;
    try {
      if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.database();
      }
    } catch (e) {
      console.error("Firebase init failed:", e);
      alert("Firebase failed.");
    }

    const currentGameRef = db ? db.ref('currentGame') : null;
    const nextGameRef = db ? db.ref('nextGame') : null;
    const presenceRef = db ? db.ref('presence') : null;
    const roomsRef = db ? db.ref('rooms') : null;
    let selectedRoom = "Room1";
    let friendsGameRef = roomsRef ? roomsRef.child(selectedRoom) : null;
    const musicRef = db ? db.ref("music") : null;
    const videoRef = db ? db.ref("video") : null;
    const sliderRef = db ? db.ref('slider') : null;
    const prizesRef = db ? db.ref('prizes') : null;
    const userTicketsRef = db ? db.ref('userTickets') : null;
    const globalClaimsRef = db ? db.ref('claims') : null;
    let localSlides = [];
    const autoTimers = { current: null, next: null, friends: null };
    let countdownIntervals = { current: null, next: null, friends: null };
    const listeners = { current: {}, next: {}, friends: {}, globalClaims: null, globalWithdrawals: null, globalUsers: null };

    function refFor(key) {
      if (key === 'current') return currentGameRef;
      if (key === 'next') return nextGameRef;
      if (key === 'friends') return friendsGameRef;
      return null;
    }

    // === NEW: UNCLAIMED PRIZE BOX ===
    function toggleUnclaimedPrizeBox() {
      if (!db) return alert("Firebase not initialized");
      const btn = document.getElementById('unclaimedPrizeBtn');
      const statusEl = document.getElementById('unclaimedStatus');
      const currentStatus = document.getElementById('currentStatusDisplay').innerText;

      if (currentStatus !== 'started') {
        return alert("गेम शुरू होने के बाद ही क्लिक करें!");
      }

      const newState = !(statusEl.innerText === 'Enabled');
      currentGameRef.child('unclaimedPrizeBox').set(newState)
        .then(() => {
          statusEl.innerText = newState ? 'Enabled' : 'Disabled';
          btn.innerText = newState ? 'Disable Claim on Phones' : 'Enable Claim on Phones';
          alert(newState ? 'Claim Button ENABLED on ALL Phones!' : 'Claim Button DISABLED');
        })
        .catch(e => alert("Error: " + e.message));
    }

    function updateUnclaimedButton(status) {
      const btn = document.getElementById('unclaimedPrizeBtn');
      const statusEl = document.getElementById('unclaimedStatus');
      if (!btn || !statusEl) return;

      if (status === 'started') {
        btn.disabled = false;
        currentGameRef.child('unclaimedPrizeBox').once('value').then(snap => {
          const enabled = snap.val() === true;
          statusEl.innerText = enabled ? 'Enabled' : 'Disabled';
          btn.innerText = enabled ? 'Disable Claim on Phones' : 'Enable Claim on Phones';
        });
      } else {
        btn.disabled = true;
        statusEl.innerText = 'Game Not Started';
        btn.innerText = 'Enable Claim on Phones';
      }
    }
    // === END NEW ===

    // === ALL ORIGINAL FUNCTIONS ===
    function clearGameClaimsAndTickets(game) {
        if (!db) return alert("Firebase not initialized.");
        const gameRef = refFor(game);
        if (!gameRef) return alert('Invalid game key');

        if (!confirm(`क्या आप सच में ${game.toUpperCase()} गेम के सभी पिछले 'claims' और 'tickets' हटाना चाहते हैं?`)) return;

        const gameUpdatePromise = gameRef.update({ claims: null, tickets: null });
        const claimsClearPromise = globalClaimsRef.remove();
        const notificationPromise = db.ref('notifications').push({
            message: `New round for ${game.toUpperCase()} started! Book new tickets now!`,
            time: firebase.database.ServerValue.TIMESTAMP
        });

        Promise.all([gameUpdatePromise, claimsClearPromise, notificationPromise])
            .then(() => alert(`${game.toUpperCase()} Claims/Tickets Reset Complete!`))
            .catch(e => alert("Error: " + e.message));
    }

    function startNewGameForAll() {
        if (!db) return alert("Firebase not initialized.");
        if (!confirm("सभी गेम्स शुरू करें?")) return;

        const gameKeys = ['current', 'next', 'friends'];
        const promises = gameKeys.map(key => {
            const ref = refFor(key);
            if (!ref) return Promise.resolve();
            return ref.update({
                status: 'started', liveNumber: null, countdown: 0, history: null,
                claims: null, winners: null, tickets: null, unclaimedPrizeBox: false,
                startTime: firebase.database.ServerValue.TIMESTAMP
            });
        });

        promises.push(globalClaimsRef.remove());
        promises.push(db.ref('notifications').push({ message: 'New Game Started!', time: firebase.database.ServerValue.TIMESTAMP }));

        Promise.all(promises).then(() => alert("All Games Started!"));
    }

    function endAllGamesAndResetTickets() {
        if (!db) return alert("Firebase not initialized.");
        if (!confirm("सभी गेम्स बंद करें और टिकट रीसेट करें?")) return;

        const gameKeys = ['current', 'next', 'friends'];
        const promises = gameKeys.map(key => {
            const ref = refFor(key);
            if (!ref) return Promise.resolve();
            return ref.update({
                status: 'gameOver', liveNumber: null, countdown: 0, history: null,
                claims: null, winners: null, tickets: null, unclaimedPrizeBox: null
            });
        });

        promises.push(userTicketsRef.remove());
        promises.push(globalClaimsRef.remove());
        promises.push(db.ref('notifications').push({ message: 'Game Over! Tickets Reset.', time: firebase.database.ServerValue.TIMESTAMP }));

        Promise.all(promises).then(() => alert("Game Over & Reset Complete!"));
    }

    function startGame(key) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(key);
      if (!ref) return alert('Invalid game key');
      ref.update({ 
        status: 'started', liveNumber: null, history: [], startTime: new Date().toISOString(),
        claims: null, winners: null, tickets: null, unclaimedPrizeBox: false
      }).then(() => {
        updateStatusUI(key, 'started');
        if (key === 'current') updateUnclaimedButton('started');
        alert(key + ' started');
      });
    }

    function stopGame(key) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(key);
      if (!ref) return alert('Invalid game key');
      clearInterval(autoTimers[key]);
      clearInterval(countdownIntervals[key]);
      ref.update({ status: 'stopped', stopTime: new Date().toISOString(), countdown: 0 })
        .then(() => {
          updateStatusUI(key, 'stopped');
          alert(key + ' stopped');
        });
    }

    function resetGame(key) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(key);
      if (!ref) return alert('Invalid game key');
      clearInterval(autoTimers[key]);
      clearInterval(countdownIntervals[key]);

      ref.update({
        status: 'idle', liveNumber: null, countdown: null, ticketsLeft: null, totalSpots: null,
        history: null, winners: null, claims: null, tickets: null, unclaimedPrizeBox: null
      }).then(() => {
        clearBoardHighlights(key);
        updateStatusUI(key, 'idle');
        if (key === 'current') updateUnclaimedButton('idle');
      });
    }

    function updateStatusUI(key, value) {
      const el = document.getElementById(`${key}StatusDisplay`);
      if (el) {
        el.innerText = value;
        el.className = `status-display status-${value.toLowerCase().replace(/\s/g, '-')}`;
      }
    }

    function clearBoardHighlights(game) {
      const id = (game === 'current') ? 'currentTambolaBoard' : (game === 'next') ? 'nextTambolaBoard' : 'friendsTambolaBoard';
      const board = document.getElementById(id);
      if (!board) return;
      Array.from(board.children).forEach(c => c.classList.remove('drawn'));
    }

    function broadcastNumber(game = 'current') {
      if (!db) return alert("Firebase not initialized.");
      const inputId = (game === 'current') ? 'currentNumberInput' : (game === 'next') ? 'nextNumberInput' : 'friendsNumberInput';
      const val = parseInt(document.getElementById(inputId).value);
      if (!val || val < 1 || val > 90) return alert('Enter number 1-90');
      const r = refFor(game);
      r.update({ liveNumber: val })
        .then(() => {
          r.child('history').transaction(hist => {
            const historyArr = hist || [];
            if (!historyArr.includes(val)) historyArr.push(val);
            return historyArr;
          });
        });
    }

    function autoDrawNumber(game = 'current') {
      if (!db) return alert("Firebase not initialized.");
      clearInterval(autoTimers[game]);
      const r = refFor(game);
      autoTimers[game] = setInterval(() => {
        r.child('history').transaction(historyArr => {
          const hist = historyArr || [];
          const drawnNumbers = new Set(hist);
          const availableNumbers = Array.from({ length: 90 }, (_, i) => i + 1).filter(num => !drawnNumbers.has(num));
          if (availableNumbers.length > 0) {
            const num = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
            r.child('liveNumber').set(num);
            hist.push(num);
          } else {
            clearInterval(autoTimers[game]);
            alert("All numbers drawn!");
          }
          return hist;
        });
      }, 30000);
      alert("Auto-draw started every 30s.");
    }

    function generateBoard(game = 'current') {
      const boardId = (game === 'current') ? 'currentTambolaBoard' : (game === 'next') ? 'nextTambolaBoard' : 'friendsTambolaBoard';
      const board = document.getElementById(boardId);
      if (!board) return;
      board.innerHTML = '';
      for (let i = 1; i <= 90; i++) {
        const cell = document.createElement('div');
        cell.className = 'board-cell';
        cell.id = game + 'Cell' + i;
        cell.innerText = i;
        board.appendChild(cell);
      }
    }

    function highlightNumber(game, num) {
      const el = document.getElementById(game + 'Cell' + num);
      if (el) el.classList.add('drawn');
    }

    function updatePrize(game) {
      if (!db) return alert("Firebase not initialized.");
      const id = (game === 'current') ? 'currentPrizeInput' : (game === 'next') ? 'nextPrizeInput' : 'friendsPrizeInput';
      const v = parseInt(document.getElementById(id).value) || 0;
      if (v < 1 || v > 100) return alert('Enter % between 1-100');
      refFor(game).child('prizePercentage').set(v);
    }

    function updateTickets(game) {
      if (!db) return alert("Firebase not initialized.");
      const id = (game === 'current') ? 'currentTicketsInput' : (game === 'next') ? 'nextTicketsInput' : 'friendsTicketsInput';
      const v = parseInt(document.getElementById(id).value) || 0;
      refFor(game).child('ticketsLeft').set(v);
    }

    function updateSpots(game) {
      if (!db) return alert("Firebase not initialized.");
      const id = (game === 'current') ? 'currentSpotsInput' : (game === 'next') ? 'nextSpotsInput' : 'friendsSpotsInput';
      const v = parseInt(document.getElementById(id).value) || 0;
      refFor(game).child('totalSpots').set(v);
    }

    function updateCountdown(key) {
      if (!db) return alert("Firebase not initialized.");
      const hours = parseInt(document.getElementById(key + 'CountdownInput_h').value) || 0;
      const minutes = parseInt(document.getElementById(key + 'CountdownInput_m').value) || 0;
      const seconds = parseInt(document.getElementById(key + 'CountdownInput_s').value) || 0;

      const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;

      if (totalSeconds < 5) {
        return alert('Countdown must be at least 5 seconds.');
      }
      startCountdown(key, totalSeconds);
    }

    function startCountdown(key, duration) {
      if (!db) return;
      let timerRef = refFor(key).child('countdown');
      let timeLeft = duration;
      
      clearInterval(countdownIntervals[key]);

      countdownIntervals[key] = setInterval(() => {
        timeLeft--;
        timerRef.set(timeLeft);
        if (timeLeft <= 0) {
          clearInterval(countdownIntervals[key]);
          timerRef.set(0);
        }
      }, 1000);
    }

    function loadWinnersForm(game = 'current') {
      const formId = (game === 'current') ? 'currentWinnersForm' : (game === 'next') ? 'nextWinnersForm' : 'friendsWinnersForm';
      let html = '';
      for (let i = 1; i <= 10; i++) {
        html += `<div class="winner-card">
          <b>Winner #${i}</b><br>
          Name: <input id="${game}Name${i}" placeholder="Name"><br>
          Phone: <input id="${game}Phone${i}" placeholder="Phone"><br>
          Prize (₹): <input id="${game}Prize${i}" type="number"><br>
        </div>`;
      }
      document.getElementById(formId).innerHTML = html;
    }

    function saveAllWinners(game) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(game).child('winners');
      let payload = {};
      for (let i = 1; i <= 10; i++) {
        const name = document.getElementById(game + 'Name' + i).value.trim();
        const phone = document.getElementById(game + 'Phone' + i).value.trim();
        const prize = parseInt(document.getElementById(game + 'Prize' + i).value) || 0;
        if (!name || !phone) { alert('Enter Name & Phone for Winner #' + i); return; }
        payload['winner' + i] = { name, phone, prize };
      }
      ref.set(payload);
    }

    function saveMusicUrl() {
      if (!db) return alert("Firebase not initialized.");
      const url = document.getElementById("musicUrlInput").value.trim();
      if (!url) return alert("Enter music URL first");
      musicRef.update({ url });
    }

    async function toggleMusic() {
      if (!db) return alert("Firebase not initialized.");
      const snap = await musicRef.once("value");
      const data = snap.val() || {};
      const newState = !data.isPlaying;
      musicRef.update({ isPlaying: newState });
    }

    function saveVideoUrl() {
      if (!db) return alert("Firebase not initialized.");
      const url = document.getElementById('videoUrlInput').value.trim();
      if (!url) return alert('वीडियो URL डालें');
      videoRef.update({ url });
    }

    async function toggleVideo() {
      if (!db) return alert("Firebase not initialized.");
      const snap = await videoRef.once('value');
      const d = snap.val() || {};
      const isPlaying = !d.isPlaying;
      await videoRef.update({ isPlaying });
    }

    function blankSlide() {
      return { src: '', linkUrl: '', title: '', buttonText: '', buttonUrl: '', width: '', height: '' };
    }

    function renderSlidesTable() {
      const tbody = document.getElementById('slidesTbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      localSlides.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="row-actions">
            <button onclick="moveSlide(${i}, -1)">↑</button>
            <button onclick="moveSlide(${i}, 1)">↓</button>
            <button onclick="deleteSlide(${i})">Delete</button>
          </td>
          <td><input class="w-220" placeholder="Image URL" value="${escapeHtml(s.src)}" oninput="onCellChange(${i}, 'src', this.value)"></td>
          <td><input class="w-220" placeholder="Link URL" value="${escapeHtml(s.linkUrl || '')}" oninput="onCellChange(${i}, 'linkUrl', this.value)"></td>
          <td><input class="w-220" placeholder="Title" value="${escapeHtml(s.title || '')}" oninput="onCellChange(${i}, 'title', this.value)"></td>
          <td>
            <input class="w-160" placeholder="Button Text" value="${escapeHtml(s.buttonText || '')}" oninput="onCellChange(${i}, 'buttonText', this.value)">
            <input class="w-220" placeholder="Button Link" value="${escapeHtml(s.buttonUrl || '')}" oninput="onCellChange(${i}, 'buttonUrl', this.value)">
          </td>
          <td>
            <input class="w-120" type="number" placeholder="W" value="${escapeHtml(s.width || '')}" oninput="onCellChange(${i}, 'width', this.value)">
            <input class="w-120" type="number" placeholder="H" value="${escapeHtml(s.height || '')}" oninput="onCellChange(${i}, 'height', this.value)">
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('slidesCount').innerText = localSlides.length;
    }

    function onCellChange(i, key, val) {
      localSlides[i][key] = val;
    }

    function addSlideRow() {
      localSlides.push(blankSlide());
      renderSlidesTable();
    }

    function deleteSlide(i) {
      if (!confirm('Delete this slide?')) return;
      localSlides.splice(i, 1);
      renderSlidesTable();
    }

    function moveSlide(i, dir) {
      const j = i + dir;
      if (j < 0 || j >= localSlides.length) return;
      const tmp = localSlides[i];
      localSlides[i] = localSlides[j];
      localSlides[j] = tmp;
      renderSlidesTable();
    }

    function saveSlidesAdvanced() {
      if (!db) return alert("Firebase not initialized.");
      const cleaned = localSlides
        .map(s => ({
          src: (s.src || '').trim(),
          linkUrl: (s.linkUrl || '').trim(),
          title: (s.title || '').trim(),
          buttonText: (s.buttonText || '').trim(),
          buttonUrl: (s.buttonUrl || '').trim(),
          width: s.width !== '' ? Number(s.width) : '',
          height: s.height !== '' ? Number(s.height) : ''
        }))
        .filter(s => s.src);
      if (!cleaned.length) return alert('कम-से-कम एक slide का Image URL भरें');
      sliderRef.update({ slides: cleaned });
    }

    async function toggleSliderPlay() {
      if (!db) return alert("Firebase not initialized.");
      const snap = await sliderRef.once('value');
      const data = snap.val() || {};
      const newState = !data.isPlaying;
      await sliderRef.update({ isPlaying: newState });
    }

    function nextSlide() {
      if (!db) return alert("Firebase not initialized.");
      sliderRef.child('currentIndex').transaction(i => (typeof i === 'number' ? i : 0) + 1);
    }

    function prevSlide() {
      if (!db) return alert("Firebase not initialized.");
      sliderRef.child('currentIndex').transaction(i => {
        const cur = (typeof i === 'number' ? i : 0);
        return cur - 1;
      });
    }

    function goToSlide() {
      if (!db) return alert("Firebase not initialized.");
      const idx = parseInt(document.getElementById('gotoIndexInput').value) || 0;
      sliderRef.update({ currentIndex: idx });
    }

    function setSpeed() {
      if (!db) return alert("Firebase not initialized.");
      const ms = parseInt(document.getElementById('speedInput').value) || 0;
      if (ms < 500) return alert('Minimum 500 ms');
      sliderRef.update({ speedMs: ms });
    }

    function sendNotification() {
      if (!db) return alert("Firebase not initialized.");
      const msg = document.getElementById('notifyMessage').value.trim();
      const to = document.getElementById('notifyTo').value.trim();
      const broadcast = document.getElementById('notifyBroadcast').checked;
      if (!msg) return alert('Enter message');
      if (broadcast) {
        db.ref('notifications').push({ message: msg, time: firebase.database.ServerValue.TIMESTAMP });
      } else if (to) {
        db.ref('userNotifications').child(to).push({ message: msg, time: firebase.database.ServerValue.TIMESTAMP });
      } else {
        db.ref('notifications').push({ message: msg, time: firebase.database.ServerValue.TIMESTAMP });
      }
    }

    function fillRooms() {
      const select = document.getElementById('roomDropdown');
      if (!select) return;
      select.innerHTML = '';
      for (let i = 1; i <= 1000; i++) {
        const opt = document.createElement('option');
        opt.value = 'Room' + i;
        opt.innerText = 'Room ' + i;
        select.appendChild(opt);
      }
      select.value = selectedRoom;
    }

    function filterRooms() {
      const q = document.getElementById('roomSearch').value.toLowerCase();
      const select = document.getElementById('roomDropdown');
      if (!select) return;
      Array.from(select.options).forEach(opt => {
        opt.style.display = opt.text.toLowerCase().includes(q) ? '' : 'none';
      });
    }

    function changeRoom() {
      if (!db) return alert("Firebase not initialized.");
      const sel = document.getElementById('roomDropdown').value;
      if (sel === selectedRoom) return;
      selectedRoom = sel;
      friendsGameRef = roomsRef.child(selectedRoom);
      generateBoard('friends');
      loadGameData('friends');
    }

    function approveClaim(id) {
      if (!db) return alert("Firebase not initialized.");
      db.ref('claims/' + id).update({ status: 'approved', reviewedBy: 'admin', reviewedAt: new Date().toISOString() });
    }

    function rejectClaim(id) {
      if (!db) return alert("Firebase not initialized.");
      db.ref('claims/' + id).update({ status: 'rejected', reviewedBy: 'admin', reviewedAt: new Date().toISOString() });
    }

    function approveWithdraw(id) {
      if (!db) return alert("Firebase not initialized.");
      db.ref('withdrawals/' + id).update({ status: 'approved', reviewedBy: 'admin', reviewedAt: new Date().toISOString() });
    }

    function rejectWithdrawPrompt(id) {
      const reason = prompt('Enter rejection reason:');
      if (reason === null) return;
      db.ref('withdrawals/' + id).update({ status: 'rejected', reviewedBy: 'admin', reviewedAt: new Date().toISOString(), rejectionReason: reason });
    }

    function renderPrizeInputs() {
      if (!db) return;
      prizesRef.once('value').then(snap => {
        const prizes = snap.val() || {};
        const prizeNames = ['Early Five', 'Ticket Corner', 'Each Line', 'Full House', '2nd Full House'];
        const container = document.getElementById('prizeManagementContainer');
        let html = '';
        prizeNames.forEach(prize => {
          const currentAmount = prizes[prize] !== undefined ? prizes[prize] : '';
          html += `
            <div style="margin: 8px 0;">
              <label style="font-weight:bold;display:block;margin-bottom:4px;">${prize} Prize (₹)</label>
              <input type="number" id="prizeInput_${prize.replace(/\s/g, '_')}" value="${currentAmount}" placeholder="Enter amount" min="0" step="1">
            </div>
          `;
        });
        container.innerHTML = html;
      });
    }

    function savePrizes() {
      if (!db) return alert("Firebase not initialized.");
      const prizeNames = ['Early Five', 'Ticket Corner', 'Each Line', 'Full House', '2nd Full House'];
      const updates = {};
      prizeNames.forEach(prize => {
        const input = document.getElementById(`prizeInput_${prize.replace(/\s/g, '_')}`);
        const value = input.value.trim();
        const amount = value ? parseInt(value) : null;
        updates[prize] = amount;
      });
      prizesRef.update(updates);
    }

    function toggleClaimsView() {
      showAllClaims = !showAllClaims;
      document.getElementById('toggleClaimsButton').innerText = showAllClaims ? 'Show Latest Claim' : 'View All Claims';
      renderClaims();
    }

    function renderClaims() {
      if (!db) return;
      globalClaimsRef.once('value').then(snap => {
        const data = snap.val() || {};
        const claims = Object.keys(data).map(id => ({ id, ...data[id], time: data[id].time || 0 }));
        let html = '';
        if (showAllClaims) {
          claims.forEach(c => {
            const status = c.status || 'pending';
            html += `<div class="claim-card">... (approve/reject buttons) ...</div>`;
          });
        } else {
          const latest = claims.sort((a, b) => b.time - a.time)[0];
          if (latest) {
            html = `<div class="claim-card">... (latest claim) ...</div>`;
          }
        }
        document.getElementById('claimsList').innerHTML = html || '<div class="muted">No claims yet</div>';
      });
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"'`]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;' })[s]);
    }

    function bindGlobalListeners() {
      if (!db) return;
      presenceRef.on('value', snap => {
        document.getElementById('liveUserCountDisplay').textContent = snap.numChildren();
      });
      db.ref('userTickets').on('value', snap => {
        let total = 0;
        snap.forEach(user => user.forEach(() => total++));
        document.getElementById('totalTicketsSoldDisplay').textContent = total;
      });
      // ... other listeners
    }

    function loadGameData(game) {
      if (!db) return;
      const gameRef = refFor(game);
      // ... all listeners for status, history, claims, tickets, etc.
      gameRef.child('status').on('value', snap => {
        const status = snap.val() || 'idle';
        updateStatusUI(game, status);
        if (game === 'current') updateUnclaimedButton(status);
      });
      // ... rest of listeners
    }

    window.openTab = function(evt, tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');
    };

    window.onload = function() {
      setTimeout(() => {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('main-content').classList.add('visible');
        document.body.style.overflow = 'auto';
      }, 3500);

      ['current', 'next', 'friends'].forEach(g => {
        generateBoard(g);
        loadWinnersForm(g);
        loadGameData(g);
      });

      fillRooms();
      renderPrizeInputs();
      renderClaims();
      bindGlobalListeners();
      updateUnclaimedButton('idle');
    };
    </script>
</body>
</html>
