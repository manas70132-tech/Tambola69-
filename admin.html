<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tambola 69 - Full Admin Panel</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background: #111; color: #fff; text-align: center; padding: 18px; }
  h1,h2,h3 { color: orange; margin: 10px 0; }
  .section { background: #222; padding: 14px; margin: 12px auto; max-width: 1000px; border-radius: 10px; text-align:left; }
  input, button, select, textarea { font-size: 15px; padding: 8px; margin: 6px 4px; border-radius: 6px; border: none; }
  button { background: orange; color: #000; cursor: pointer; font-weight: 700; }
  button:hover { background:#ff8800; }
  .action-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .live-box { background:#000; padding:8px 10px; border-radius:8px; display:inline-block; margin-left:8px; }
  .tambola-board, .ticket-board { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
  .board-cell, .ticket-cell { width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:#333; border-radius:6px; font-weight:bold; color:#fff; cursor:pointer; }
  .board-cell.drawn { background:#000; color:#ff0; }
  .winner-card { background:#000; padding:10px; margin:8px 0; border-radius:8px; }
  .claim-card { background:#1a1a1a; padding:10px; margin:8px 0; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .room-select { background:#111; padding:8px; border-radius:8px; display:flex; gap:8px; align-items:center; }
  .small { font-size:13px; padding:6px; }
  textarea { width:100%; min-height:60px; border-radius:6px; }
  .muted { color:#bbb; font-size:13px; }
  .table-wrap{ overflow:auto; border-radius:8px; border:1px solid #333; }
  table { width:100%; border-collapse: collapse; }
  th, td { padding:8px; border-bottom:1px solid #333; vertical-align: top; text-align:left; }
  th { position: sticky; top:0; background:#1b1b1b; }
  .row-actions button{ margin:0 4px; padding:6px 8px; }
  .w-120{ width:120px; }
  .w-160{ width:160px; }
  .w-220{ width:220px; }
  .w-60{ width:60px; }
  .table-small{ width:100%; border-collapse:collapse; margin-top:8px }
  .table-small th, .table-small td { padding:8px; border-bottom:1px solid #333; font-size:14px; text-align:left }
  .btn-ghost{ background:transparent; border:1px solid #333; color:#fff; padding:6px 8px; border-radius:6px; cursor:pointer }
  .btn-danger{ background:#ff4d4f; color:#fff; padding:6px 8px; border-radius:6px; cursor:pointer; border:none }
</style>
</head>
<body>
<h1>üéõÔ∏è Tambola 69 - Admin Panel</h1>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAphHTM4faH7_FVXdnootp4NipZd3vtEck",
  authDomain: "tambola69-9dc8f.firebaseapp.com",
  databaseURL: "https://tambola69-9dc8f-default-rtdb.firebaseio.com",
  projectId: "tambola69-9dc8f",
  storageBucket: "tambola69-9dc8f.firebasestorage.app",
  messagingSenderId: "413290158586",
  appId: "1:413290158586:web:c4c6d6d224c96a7487ec43",
  measurementId: "G-TM68JPXH18"
  };
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase connection successful!");
} else {
    console.log("Firebase app already running.");
}

const db = firebase.database();
const currentGameRef = db.ref('currentGame');
const nextGameRef = db.ref('nextGame');
const presenceRef = db.ref('presence');
const roomsRef = db.ref('rooms');
let selectedRoom = "Room1";
let friendsGameRef = roomsRef.child(selectedRoom);
const musicRef = db.ref("music");
const videoRef = db.ref("video");
const sliderRef = db.ref('slider');
const prizesRef = db.ref('prizes');
let localSlides = [];
const autoTimers = { current: null, next: null, friends: null };

let countdownIntervals = {
    current: null,
    next: null,
    friends: null
};

// Map to store active listeners for each game type (current, next, friends)
const listeners = {
    current: {},
    next: {},
    friends: {},
    globalClaims: null,
    globalWithdrawals: null,
    globalUsers: null
};

function refFor(key){
  if(key==='current') return currentGameRef;
  if(key==='next') return nextGameRef;
  if(key==='friends') return friendsGameRef;
  return null;
}

function startCountdown(key, duration) {
    let timerRef = refFor(key).child('countdown');
    let timeLeft = duration;
    
    clearInterval(countdownIntervals[key]);

    countdownIntervals[key] = setInterval(() => {
        timeLeft--;
        timerRef.set(timeLeft);

        if (timeLeft <= 0) {
            clearInterval(countdownIntervals[key]);
            timerRef.set(0);
        }
    }, 1000);
}

function saveMusicUrl(){
  const url = document.getElementById("musicUrlInput").value.trim();
  if(!url) return alert("Enter music URL first");
  musicRef.update({ url });
  alert("Music URL updated ‚úÖ");
}
async function toggleMusic(){
  const snap = await musicRef.once("value");
  const data = snap.val() || {};
  const newState = !data.isPlaying;
  musicRef.update({ isPlaying: newState });
}
function saveVideoUrl(){
  const url = (document.getElementById('videoUrlInput')||{}).value || '';
  if(!url.trim()) return alert('‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã URL ‡§°‡§æ‡§≤‡•á‡§Ç');
  videoRef.update({ url });
  alert('‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã URL ‡§∏‡•á‡§µ ‚úÖ');
}
async function toggleVideo(){
  const snap = await videoRef.once('value');
  const d = snap.val() || {};
  const isPlaying = !d.isPlaying;
  await videoRef.update({ isPlaying });
}
function blankSlide(){
  return { src:'', linkUrl:'', title:'', buttonText:'', buttonUrl:'', width:'', height:'' };
}
function renderSlidesTable(){
  const tbody = document.getElementById('slidesTbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  localSlides.forEach((s, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="row-actions">
        <button onclick="moveSlide(${i}, -1)">‚Üë</button>
        <button onclick="moveSlide(${i}, 1)">‚Üì</button>
        <button onclick="deleteSlide(${i})">üóë</button>
      </td>
      <td><input class="w-220" placeholder="Image URL" value="${escapeHtml(s.src)}" oninput="onCellChange(${i}, 'src', this.value)"></td>
      <td><input class="w-220" placeholder="Link URL (image click)" value="${escapeHtml(s.linkUrl||'')}" oninput="onCellChange(${i}, 'linkUrl', this.value)"></td>
      <td><input class="w-220" placeholder="Title / Text (overlay)" value="${escapeHtml(s.title||'')}" oninput="onCellChange(${i}, 'title', this.value)"></td>
      <td>
        <input class="w-160" placeholder="Button Text" value="${escapeHtml(s.buttonText||'')}" oninput="onCellChange(${i}, 'buttonText', this.value)">
        <input class="w-220" placeholder="Button Link URL" value="${escapeHtml(s.buttonUrl||'')}" oninput="onCellChange(${i}, 'buttonUrl', this.value)">
      </td>
      <td>
        <input class="w-120" type="number" min="0" placeholder="Width (px)" value="${escapeHtml(s.width||'')}" oninput="onCellChange(${i}, 'width', this.value)">
        <input class="w-120" type="number" min="0" placeholder="Height (px)" value="${escapeHtml(s.height||'')}" oninput="onCellChange(${i}, 'height', this.value)">
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('slidesCount').innerText = localSlides.length;
}
function onCellChange(i, key, val){
  localSlides[i][key] = val;
}
function addSlideRow(){
  localSlides.push(blankSlide());
  renderSlidesTable();
}
function deleteSlide(i){
  if(!confirm('Delete this slide?')) return;
  localSlides.splice(i,1);
  renderSlidesTable();
}
function moveSlide(i, dir){
  const j = i + dir;
  if(j<0 || j>=localSlides.length) return;
  const tmp = localSlides[i];
  localSlides[i] = localSlides[j];
  localSlides[j] = tmp;
  renderSlidesTable();
}
function saveSlidesAdvanced(){
  const cleaned = localSlides
    .map(s=>({
      src: (s.src||'').trim(),
      linkUrl: (s.linkUrl||'').trim(),
      title: (s.title||'').trim(),
      buttonText: (s.buttonText||'').trim(),
      buttonUrl: (s.buttonUrl||'').trim(),
      width: s.width!=='' ? Number(s.width) : '',
      height: s.height!=='' ? Number(s.height) : ''
    }))
    .filter(s=>s.src);
  if(!cleaned.length) return alert('‡§ï‡§Æ-‡§∏‡•á-‡§ï‡§Æ ‡§è‡§ï slide ‡§ï‡§æ Image URL ‡§≠‡§∞‡•á‡§Ç');
  sliderRef.update({ slides: cleaned })
    .then(()=>alert('Slides updated ‚úÖ'))
    .catch(e=>alert(e.message));
}
async function toggleSliderPlay(){
  const snap = await sliderRef.once('value');
  const data = snap.val() || {};
  const newState = !data.isPlaying;
  await sliderRef.update({ isPlaying: newState });
}
function nextSlide(){
  sliderRef.child('currentIndex').transaction(i => (typeof i === 'number' ? i : 0) + 1);
}
function prevSlide(){
  sliderRef.child('currentIndex').transaction(i => {
    const cur = (typeof i === 'number' ? i : 0);
    return cur - 1;
  });
}
function goToSlide(){
  const idx = parseInt((document.getElementById('gotoIndexInput')||{}).value) || 0;
  sliderRef.update({ currentIndex: idx });
}
function setSpeed(){
  const ms = parseInt((document.getElementById('speedInput')||{}).value) || 0;
  if(ms < 500) return alert('Minimum 500 ms');
  sliderRef.update({ speedMs: ms });
}

function startGame(key){
  const ref = refFor(key);
  if(!ref) return alert('Invalid game key');
  ref.update({ status: 'started', liveNumber: null, history: [], startTime: new Date().toISOString(), claims: null, winners: null });
  updateStatusUI(key,'started');
  alert(key + ' started ‚úÖ');
}
function stopGame(key){
  const ref = refFor(key);
  if(!ref) return alert('Invalid game key');
  clearInterval(autoTimers[key]);
  clearInterval(countdownIntervals[key]);
  ref.update({ status: 'stopped', stopTime: new Date().toISOString(), countdown: 0 });
  updateStatusUI(key,'stopped');
  alert(key + ' stopped ‚èπ');
}
function resetGame(key){
  const ref = refFor(key);
  if(!ref) return alert('Invalid game key');
  clearInterval(autoTimers[key]);
  clearInterval(countdownIntervals[key]);
  ref.update({
    status: 'idle', liveNumber: null, countdown: null, ticketsLeft: null, totalSpots: null, history: null, winners: null, claims: null, tickets: null
  }).then(()=>{
    clearBoardHighlights(key);
    updateStatusUI(key,'idle');
    alert(key + ' reset to idle üîÑ');
  }).catch(e=>alert(e.message));
}
function updateStatusUI(key, value){
  const el = document.getElementById(`${key}StatusDisplay`);
  if(el) el.innerText = value;
}
function clearBoardHighlights(game){
  const id = (game==='current') ? 'currentTambolaBoard' : (game==='next') ? 'nextTambolaBoard' : 'friendsTambolaBoard';
  const board = document.getElementById(id);
  if(!board) return;
  Array.from(board.children).forEach(c=>c.classList.remove('drawn'));
}
function broadcastNumber(game='current'){
  const inputId = (game==='current') ? 'currentNumberInput' : (game==='next') ? 'nextNumberInput' : 'friendsNumberInput';
  const val = parseInt(document.getElementById(inputId).value);
  if(!val || val<1 || val>90) return alert('Enter number 1-90');
  const r = refFor(game);
  r.update({ liveNumber: val });
  r.child('history').transaction(hist => {
    const historyArr = hist || [];
    if (!historyArr.includes(val)) {
      historyArr.push(val);
    }
    return historyArr;
  });
}
function autoDrawNumber(game='current'){
  clearInterval(autoTimers[game]);
  const r = refFor(game);
  autoTimers[game] = setInterval(()=>{
    r.child('history').transaction(historyArr => {
      const hist = historyArr || [];
      const drawnNumbers = new Set(hist);
      const availableNumbers = Array.from({length: 90}, (_, i) => i + 1).filter(num => !drawnNumbers.has(num));
      if (availableNumbers.length > 0) {
        const num = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
        hist.push(num);
        r.child('liveNumber').set(num);
      } else {
        clearInterval(autoTimers[game]);
        alert("All numbers drawn! Auto-draw stopped.");
      }
      return hist;
    });
  }, 30000);
  alert("Auto-draw started for " + game + " every 30 seconds.");
}
function generateBoard(game='current'){
  const boardId = (game==='current') ? 'currentTambolaBoard' : (game==='next') ? 'nextTambolaBoard' : 'friendsTambolaBoard';
  const board = document.getElementById(boardId);
  if(!board) return;
  board.innerHTML = '';
  for(let i=1;i<=90;i++){
    const cell = document.createElement('div');
    cell.className = 'board-cell';
    cell.id = game + 'Cell' + i;
    cell.innerText = i;
    board.appendChild(cell);
  }
}
function highlightNumber(game, num){
  const el = document.getElementById(game+'Cell'+num);
  if(el) el.classList.add('drawn');
}
function updatePrize(game){
  const id = (game==='current') ? 'currentPrizeInput' : (game==='next') ? 'nextPrizeInput' : 'friendsPrizeInput';
  const v = parseInt(document.getElementById(id).value) || 0;
  if(v<1 || v>100) return alert('Enter % between 1-100');
  refFor(game).child('prizePercentage').set(v);
}
function updateTickets(game){
  const id = (game==='current') ? 'currentTicketsInput' : (game==='next') ? 'nextTicketsInput' : 'friendsTicketsInput';
  const v = parseInt(document.getElementById(id).value) || 0;
  refFor(game).child('ticketsLeft').set(v);
}
function updateSpots(game){
  const id = (game==='current') ? 'currentSpotsInput' : (game==='next') ? 'nextSpotsInput' : 'friendsSpotsInput';
  const v = parseInt(document.getElementById(id).value) || 0;
  refFor(game).child('totalSpots').set(v);
}
function updateCountdown(key) {
  const hours = parseInt(document.getElementById(key + 'CountdownInput_h').value) || 0;
  const minutes = parseInt(document.getElementById(key + 'CountdownInput_m').value) || 0;
  const seconds = parseInt(document.getElementById(key + 'CountdownInput_s').value) || 0;

  const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;

  if (totalSeconds < 5) {
    return alert('Countdown must be at least 5 seconds.');
  }
  startCountdown(key, totalSeconds);
}
function loadWinnersForm(game='current'){
  const formId = (game==='current') ? 'currentWinnersForm'
               : (game==='next') ? 'nextWinnersForm'
               : 'friendsWinnersForm';
  let html = '';
  for(let i=1;i<=10;i++){
    html += `<div class="winner-card">
      <b>Winner #${i}</b><br>
      Name: <input id="${game}Name${i}" placeholder="Name"><br>
      Phone: <input id="${game}Phone${i}" placeholder="Phone"><br>
      Prize (‚Çπ): <input id="${game}Prize${i}" type="number"><br>
      <button type="button" onclick="saveSingleWinner('${game}',${i})">Update Winner #${i}</button>
    </div>`;
  }
  document.getElementById(formId).innerHTML = html;
}
function saveSingleWinner(game, i){
  const ref = refFor(game).child('winners');
  const name = document.getElementById(game+'Name'+i).value.trim();
  const phone = document.getElementById(game+'Phone'+i).value.trim();
  const prize = parseInt(document.getElementById(game+'Prize'+i).value) || 0;
  if(!name || !phone) return alert('Enter Name and Phone for Winner #' + i);
  ref.child('winner'+i).set({ name, phone, prize });
  alert('Winner #' + i + ' updated for ' + game);
}
function saveAllWinners(game){
  const ref = refFor(game).child('winners');
  let payload = {};
  for(let i=1;i<=10;i++){
    const name = document.getElementById(game+'Name'+i).value.trim();
    const phone = document.getElementById(game+'Phone'+i).value.trim();
    const prize = parseInt(document.getElementById(game+'Prize'+i).value) || 0;
    if(!name || !phone) { alert('Enter Name & Phone for Winner #' + i); return; }
    payload['winner'+i] = { name, phone, prize };
  }
  ref.set(payload).then(()=>alert('All winners saved for ' + game));
}
function sendNotification(){
  const msg = (document.getElementById('notifyMessage')||{}).value || '';
  const to = (document.getElementById('notifyTo')||{}).value || '';
  const broadcast = document.getElementById('notifyBroadcast') && document.getElementById('notifyBroadcast').checked;
  if(!msg.trim()) return alert('Enter message');
  const payload = { message: msg.trim(), time: new Date().toISOString(), from: 'admin' };
  if(broadcast){
    db.ref('notifications').push({ message: msg.trim(), time: firebase.database.ServerValue.TIMESTAMP });
    alert('Broadcast notification sent ‚úÖ');
  } else if(to.trim()){
    db.ref('userNotifications').child(to.trim()).push({ message: msg.trim(), time: firebase.database.ServerValue.TIMESTAMP });
    alert('Notification sent to ' + to.trim() + ' ‚úÖ');
  } else {
    db.ref('notifications').push({ message: msg.trim(), time: firebase.database.ServerValue.TIMESTAMP });
    alert('Notification pushed to notifications (no target) ‚úÖ');
  }
  document.getElementById('notifyMessage').value = '';
  document.getElementById('notifyTo').value = '';
  if(document.getElementById('notifyBroadcast')) document.getElementById('notifyBroadcast').checked = false;
}
function fillRooms(){
  const select = document.getElementById('roomDropdown');
  select.innerHTML = '';
  for(let i=1;i<=1000;i++){
    const opt = document.createElement('option');
    opt.value = 'Room'+i;
    opt.innerText = 'Room ' + i;
    select.appendChild(opt);
  }
  select.value = selectedRoom;
}
function filterRooms(){
  const q = (document.getElementById('roomSearch')||{}).value.toLowerCase();
  const select = document.getElementById('roomDropdown');
  Array.from(select.options).forEach(opt=>{
    opt.style.display = opt.text.toLowerCase().includes(q) ? '' : 'none';
  });
}
function changeRoom(){
  const sel = document.getElementById('roomDropdown').value || 'Room1';
  
  if(sel === selectedRoom) return;

  // Unbind old listeners before changing room
  for(const key in listeners.friends) {
    if(listeners.friends[key]) {
      friendsGameRef.child(key).off('value', listeners.friends[key]);
    }
  }

  selectedRoom = sel;
  friendsGameRef = roomsRef.child(selectedRoom);
  alert('Now controlling ' + selectedRoom);
  generateBoard('friends');
  loadGameData('friends');
}

function approveClaim(id){
  db.ref('claims/'+id).update({ status: 'approved', reviewedBy: 'admin', reviewedAt: new Date().toISOString() });
  db.ref('claims/'+id).once('value').then(snap=>{
    const c = snap.val() || {};
    if(c.userId) db.ref('userNotifications').child(c.userId).push({ message: `Your claim for ${c.prize} has been approved`, time: firebase.database.ServerValue.TIMESTAMP, from:'admin' });
  });
  alert('Claim approved ‚úÖ');
}
function rejectClaim(id){
  db.ref('claims/'+id).update({ status: 'rejected', reviewedBy: 'admin', reviewedAt: new Date().toISOString() });
  db.ref('claims/'+id).once('value').then(snap=>{
    const c = snap.val() || {};
    if(c.userId) db.ref('userNotifications').child(c.userId).push({ message: `Your claim for ${c.prize} was rejected`, time: firebase.database.ServerValue.TIMESTAMP, from:'admin' });
  });
  alert('Claim rejected ‚ùå');
}
function approveWithdraw(id){
  const wRef = db.ref('withdrawals/' + id);
  wRef.once('value').then(snap=>{
    const w = snap.val() || {};
    wRef.update({ status:'approved', reviewedBy:'admin', reviewedAt:new Date().toISOString() });
    if(w.userId) {
      db.ref('userNotifications').child(w.userId).push({ message: `Your withdrawal ‚Çπ${w.amount} approved`, time: firebase.database.ServerValue.TIMESTAMP, from:'admin' });
    }
    alert('Withdrawal approved ‚úÖ');
  }).catch(e => alert(e.message));
}
function rejectWithdrawPrompt(id){
  const reason = prompt('Enter rejection reason (optional):','');
  if(reason === null) return;
  rejectWithdraw(id, reason);
}
function rejectWithdraw(id, reason){
  const wRef = db.ref('withdrawals/' + id);
  wRef.once('value').then(snap=>{
    const w = snap.val() || {};
    wRef.update({ status:'rejected', reviewedBy:'admin', reviewedAt:new Date().toISOString(), rejectionReason: reason||'' });
    if(w.userId) {
      db.ref('userNotifications').child(w.userId).push({ message: `Your withdrawal ‚Çπ${w.amount} was rejected: ${reason||'No reason'}`, time: firebase.database.ServerValue.TIMESTAMP, from:'admin' });
    }
    alert('Withdrawal rejected ‚ùå');
  }).catch(e => alert(e.message));
}
function viewWithdraw(id){
  db.ref('withdrawals/'+id).once('value').then(snap=>{
    const w = snap.val() || {};
    alert(`User: ${w.userId}\nAmount: ‚Çπ${w.amount}\nDestination: ${w.dest}\nStatus: ${w.status}\nRequested: ${new Date(w.time).toLocaleString()||''}\nReason: ${w.rejectionReason||''}`);
  });
}
function renderPrizeInputs() {
    prizesRef.once('value').then(snap => {
        const prizes = snap.val() || {};
        const prizeNames = ['Early Five', 'Ticket Corner', 'Each Line', 'Full House', '2nd Full House'];
        const container = document.getElementById('prizeManagementContainer');
        let html = '';
        prizeNames.forEach(prize => {
            const currentAmount = prizes[prize] || 0;
            html += `
                <div style="margin: 8px 0;">
                    <label style="font-weight:bold;display:block;margin-bottom:4px;">${prize} Prize (‚Çπ)</label>
                    <input type="number" id="prizeInput_${prize.replace(/\s/g, '_')}" value="${currentAmount}" placeholder="Enter amount">
                </div>
            `;
        });
        container.innerHTML = html;
    });
}
function savePrizes() {
    const prizeNames = ['Early Five', 'Ticket Corner', 'Each Line', 'Full House', '2nd Full House'];
    const updates = {};
    prizeNames.forEach(prize => {
        const input = document.getElementById(`prizeInput_${prize.replace(/\s/g, '_')}`);
        const amount = parseInt(input.value) || 0;
        updates[prize] = amount;
    });
    prizesRef.update(updates)
        .then(() => alert('Prizes updated successfully!'))
        .catch(e => alert('Error updating prizes: ' + e.message));
}
function escapeHtml(str){
  return String(str||'').replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s]));
}

// Global Listener Initialization
function bindGlobalListeners() {
  // Music Listener
  musicRef.on("value", snap=>{
    const data = snap.val() || {};
    const urlInput = document.getElementById("musicUrlInput");
    const tBtn = document.getElementById("toggleMusicBtn");
    if(urlInput) urlInput.value = data.url || "";
    if(tBtn) tBtn.innerText = data.isPlaying ? "‚è∏ Pause" : "‚ñ∂Ô∏è Play";
  });

  // Video Listener
  videoRef.on("value", snap => {
    const d = snap.val() || {};
    const urlInput = document.getElementById('videoUrlInput');
    const tBtn = document.getElementById('toggleVideoBtn');
    if (urlInput) urlInput.value = d.url || '';
    if (tBtn) tBtn.innerText = d.isPlaying ? '‚è∏ ‡§™‡•â‡§ú‡§º' : '‚ñ∂Ô∏è ‡§™‡•ç‡§≤‡•á';
  });

  // Slider Listener
  sliderRef.on('value', snap=>{
    const d = snap.val() || {};
    localSlides = Array.isArray(d.slides) ? JSON.parse(JSON.stringify(d.slides)) : [];
    renderSlidesTable();
    const tBtn = document.getElementById('toggleSliderBtn');
    if(tBtn) tBtn.innerText = d.isPlaying ? '‚è∏ Pause' : '‚ñ∂Ô∏è Play';
    const idxDisp = document.getElementById('currentIndexDisplay');
    if(idxDisp) idxDisp.innerText = (typeof d.currentIndex==='number' ? d.currentIndex : 0);
    const spDisp = document.getElementById('speedDisplay');
    if(spDisp) spDisp.innerText = (d.speedMs || 0) + ' ms';
  });
  
  // Claims Listener
  if (!listeners.globalClaims) {
    listeners.globalClaims = db.ref('claims').on('value', snap => {
        const data = snap.val() || {};
        let html = '';
        Object.keys(data).forEach(id => {
            const c = data[id];
            const status = c.status || 'pending';
            html += `<div class="claim-card">
              <div style="flex:1">
                <div><b>User:</b> ${escapeHtml(c.userName||'Unknown')}</div>
                <div class="muted"><b>Prize:</b> ${escapeHtml(c.prize||'claim')}</div>
                <div class="muted"><b>Game:</b> ${escapeHtml(c.gameId||'N/A')}</div>
                <div class="muted"><b>Time:</b> ${escapeHtml(new Date(c.time).toLocaleString() || '')}</div>
                <div class="muted"><b>Status:</b> ${escapeHtml(status)}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button type="button" onclick="approveClaim('${id}')">‚úÖ Approve</button>
                <button type="button" onclick="rejectClaim('${id}')">‚ùå Reject</button>
              </div>
            </div>`;
        });
        document.getElementById('claimsList').innerHTML = html || '<div class="muted">No claims yet</div>';
    });
  }

  // Withdrawals Listener
  if (!listeners.globalWithdrawals) {
    listeners.globalWithdrawals = db.ref('withdrawals').on('value', snap => {
        const data = snap.val() || {};
        let rows = '';
        Object.keys(data).forEach(id => {
            const w = data[id];
            const status = w.status || 'pending';
            const requested = w.time ? new Date(w.time).toLocaleString() : '';
            rows += `<tr>
              <td><b>${escapeHtml(w.name||'unknown')}</b><div class="muted">${escapeHtml(w.userId)}</div></td>
              <td>‚Çπ${escapeHtml(w.amount||0)}</td>
              <td>${escapeHtml(w.dest||'--')}</td>
              <td>${escapeHtml(status)}</td>
              <td>${requested}</td>
              <td>
                ${status === 'pending' ? `<button onclick="approveWithdraw('${id}')" class="btn-ghost">Approve</button>
                <button onclick="rejectWithdrawPrompt('${id}')" class="btn-danger">Reject</button>` : `<button class="btn-ghost" onclick="viewWithdraw('${id}')">View</button>`}
              </td>
            </tr>`;
        });
        if (!rows) rows = '<tr><td colspan="6" class="muted">No withdrawal requests</td></tr>';
        document.getElementById('withdrawalsList').innerHTML = `<table class="table-small"><thead><tr><th>User</th><th>Amount</th><th>Destination</th><th>Status</th><th>Requested</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>`;
    });
  }

  // Users Listener
  if (!listeners.globalUsers) {
    listeners.globalUsers = db.ref('users').on('value', snap => {
        const data = snap.val() || {};
        let rows = '';
        Object.keys(data).forEach(uid => {
            const u = data[uid] || {};
            rows += `<tr>
              <td><b>${escapeHtml(uid)}</b><div class="muted">${escapeHtml(u.name||'')}</div></td>
              <td>‚Çπ${u.balance || 0}</td>
            </tr>`;
        });
        if (!rows) rows = '<tr><td colspan="2" class="muted">No users found</td></tr>';
        document.getElementById('usersTicketsList').innerHTML = `<table class="table-small"><thead><tr><th>User ID</th><th>Balance</th></tr></thead><tbody>${rows}</tbody></table>`;
    });
  }

  // Live User Counter
  presenceRef.on('value', snap => {
      const count = snap.numChildren();
      document.getElementById('liveUserCountDisplay').textContent = count;
  });

  // Total Tickets Sold
  db.ref('userTickets').on('value', snap => {
      let totalCount = 0;
      if (snap.exists()) {
          snap.forEach(userTickets => {
              totalCount += userTickets.numChildren();
          });
      }
      document.getElementById('totalTicketsSoldDisplay').textContent = totalCount;
  });
}

function loadGameData(game) {
    const gameRef = refFor(game);

    // Unbind previous listeners for this game instance to prevent duplicates
    for(const key in listeners[game]) {
      gameRef.child(key).off('value', listeners[game][key]);
    }
    listeners[game] = {}; // Clear the listener map

    // Listener for status, tickets, spots, and countdown
    const gameDataListener = gameRef.on('value', snap => {
      const data = snap.val() || {};
      
      const statusEl = document.getElementById(`${game}StatusDisplay`);
      if(statusEl) statusEl.innerText = data.status || 'idle';

      const prizeInputEl = document.getElementById(`${game}PrizeInput`);
      if (prizeInputEl) prizeInputEl.value = data.prizePercentage || 0;
      const prizeDisplayEl = document.getElementById(`${game}PrizeDisplay`);
      if (prizeDisplayEl) prizeDisplayEl.innerText = (data.prizePercentage || 0) + '%';
      
      const ticketsInputEl = document.getElementById(`${game}TicketsInput`);
      if(ticketsInputEl) ticketsInputEl.value = data.ticketsLeft || 0;
      const ticketsDisplayEl = document.getElementById(`${game}TicketsDisplay`);
      if(ticketsDisplayEl) ticketsDisplayEl.innerText = data.ticketsLeft || 0;

      const spotsInputEl = document.getElementById(`${game}SpotsInput`);
      if(spotsInputEl) spotsInputEl.value = data.totalSpots || 0;
      const spotsDisplayEl = document.getElementById(`${game}SpotsDisplay`);
      if(spotsDisplayEl) spotsDisplayEl.innerText = data.totalSpots || 0;
      
      const countdownDisplayEl = document.getElementById(`${game}CountdownDisplay`);
      const countdownValue = data.countdown || 0;
      if(countdownDisplayEl) {
          const h = Math.floor(countdownValue / 3600);
          const m = Math.floor((countdownValue % 3600) / 60);
          const s = countdownValue % 60;
          countdownDisplayEl.innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }
    });
    listeners[game].gameData = gameDataListener;

    // Listener for winners
    const winnersListener = gameRef.child('winners').on('value', snap => {
        const winners = snap.val() || {};
        for(let i = 1; i <= 10; i++) {
            const winner = winners[`winner${i}`] || {};
            const nameInput = document.getElementById(`${game}Name${i}`);
            const phoneInput = document.getElementById(`${game}Phone${i}`);
            const prizeInput = document.getElementById(`${game}Prize${i}`);
            if (nameInput) nameInput.value = winner.name || '';
            if (phoneInput) phoneInput.value = winner.phone || '';
            if (prizeInput) prizeInput.value = winner.prize || 0;
        }
    });
    listeners[game].winners = winnersListener;

    // Listener for claims
    const claimsListId = `${game}ClaimsList`;
    const claimsList = document.getElementById(claimsListId);
    if(claimsList) {
        const claimsListener = gameRef.child('claims').on('value', snap => {
            const data = snap.val() || {};
            let html = '';
            Object.keys(data).forEach(id => {
                const c = data[id];
                const status = c.status || 'pending';
                html += `<div class="claim-card">
                    <div style="flex:1">
                        <div><b>User:</b> ${escapeHtml(c.userName||'Unknown')}</div>
                        <div class="muted"><b>Prize:</b> ${escapeHtml(c.prize||'claim')}</div>
                        <div class="muted"><b>Game:</b> ${escapeHtml(c.gameId||'N/A')}</div>
                        <div class="muted"><b>Time:</b> ${escapeHtml(new Date(c.time).toLocaleString() || '')}</div>
                        <div class="muted"><b>Status:</b> ${escapeHtml(status)}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px">
                        <button type="button" onclick="approveClaim('${id}')">‚úÖ Approve</button>
                        <button type="button" onclick="rejectClaim('${id}')">‚ùå Reject</button>
                    </div>
                </div>`;
            });
            claimsList.innerHTML = html || '<div class="muted">No claims for this game yet.</div>';
        });
        listeners[game].claims = claimsListener;
    }
    
    // Listener for tickets
    const ticketsListId = `${game}TicketsList`;
    const ticketsList = document.getElementById(ticketsListId);
    if(ticketsList) {
        const ticketsListener = gameRef.child('tickets').on('value', snap => {
            const tickets = snap.val() || {};
            let html = '';
            Object.keys(tickets).forEach(userId => {
                const userTickets = tickets[userId];
                html += `<div style="margin-top:10px;"><b>User ID: ${escapeHtml(userId)}</b></div>`;
                Object.values(userTickets).forEach(ticket => {
                    html += `<div style="border:1px solid #444; padding:8px; margin-top:5px; border-radius:6px;">`;
                    html += `Ticket ID: ${escapeHtml(ticket.ticketId)}<br>`;
                    html += `Numbers: ${escapeHtml(ticket.numbers.join(', '))}`;
                    html += `</div>`;
                });
            });
            ticketsList.innerHTML = html || '<div class="muted">No tickets purchased for this game yet.</div>';
        });
        listeners[game].tickets = ticketsListener;
    }
    
    // Listener for history
    const historyListener = gameRef.child('history').on('value', snap => {
        const history = snap.val() || [];
        clearBoardHighlights(game);
        history.forEach(num => highlightNumber(game, num));
    });
    listeners[game].history = historyListener;
}


window.onload = function(){
  // All global listeners are bound only once on page load.
  bindGlobalListeners();
  
  // Initialize UI for all game types
  ['current','next','friends'].forEach(g=>{
    generateBoard(g);
    loadWinnersForm(g);
    loadGameData(g); 
  });
  fillRooms();
  renderPrizeInputs();
}

</script>

<div class="section">
    <h2>üñºÔ∏è Slider Control</h2>
    <div class="action-row">
        <button onclick="toggleSliderPlay()" id="toggleSliderBtn">‚ñ∂Ô∏è Play</button>
        <button onclick="prevSlide()">‚óÄÔ∏è Previous</button>
        <button onclick="nextSlide()">Next ‚ñ∂Ô∏è</button>
        <button onclick="addSlideRow()">+ Add Slide</button>
    </div>
    <div class="action-row" style="margin-top:8px">
        <input type="number" id="gotoIndexInput" min="0" placeholder="Go to index">
        <button onclick="goToSlide()">Go</button>
        <div class="live-box">Current Index: <span id="currentIndexDisplay">0</span></div>
    </div>
    <div class="action-row" style="margin-top:8px">
        <input type="number" id="speedInput" min="500" placeholder="Speed (ms)">
        <button onclick="setSpeed()">Set Speed</button>
        <div class="live-box">Speed: <span id="speedDisplay">0 ms</span></div>
    </div>
    <div class="table-wrap" style="margin-top:10px">
        <table>
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Image URL</th>
                    <th>Link URL</th>
                    <th>Title</th>
                    <th>Button</th>
                    <th>Size (Optional)</th>
                </tr>
            </thead>
            <tbody id="slidesTbody">
                </tbody>
        </table>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
        <div class="muted">Total Slides: <span id="slidesCount">0</span></div>
        <button onclick="saveSlidesAdvanced()">üíæ Save All Slides to DB</button>
    </div>
</div>
---
<div class="section">
  <h2>üéµ Music Control</h2>
  <input type="text" id="musicUrlInput" placeholder="Enter music stream URL" style="width:70%">
  <button onclick="saveMusicUrl()">Save URL</button>
  <button id="toggleMusicBtn" onclick="toggleMusic()">‚ñ∂Ô∏è Play</button>
  <div class="muted" style="margin-top:6px">Clients will auto-play if their local mute is off.</div>
</div>
---
<div class="section">
  <h2>üé¨ ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤</h2>
  <input type="text" id="videoUrlInput" placeholder="‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ URL ‡§°‡§æ‡§≤‡•á‡§Ç" style="width:70%">
  <button onclick="saveVideoUrl()">URL ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
  <button id="toggleVideoBtn" onclick="toggleVideo()">‚ñ∂Ô∏è ‡§™‡•ç‡§≤‡•á</button>
  <div class="muted" style="margin-top:6px">‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ë‡§ü‡•ã-‡§™‡•ç‡§≤‡•á ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á ‡§Ö‡§ó‡§∞ ‡§â‡§®‡§ï‡§æ ‡§Æ‡•ç‡§Ø‡•Ç‡§ü ‡§ë‡§´ ‡§π‡•à‡•§</div>
</div>
---
<div class="section">
  <h2>üì¢ Notifications</h2>
  <div style="display:flex;gap:8px;align-items:center;">
    <input id="notifyTo" type="text" placeholder="User ID (leave empty for broadcast) - e.g. user123" style="width:40%">
    <label style="display:flex;align-items:center;gap:6px;"><input id="notifyBroadcast" type="checkbox"> Broadcast to all</label>
  </div>
  <textarea id="notifyMessage" placeholder="Enter message for users..."></textarea>
  <div style="display:flex;gap:8px;">
    <button onclick="sendNotification()">Send Notification</button>
  </div>
  <div class="muted" style="margin-top:8px">Notifications are pushed to <code>/notifications</code>. For specific users also stored under <code>/userNotifications/{userId}</code>.</div>
</div>
---
<div class="section">
    <h2>üéÅ Prize Management</h2>
    <div id="prizeManagementContainer">
        </div>
    <button onclick="savePrizes()">üíæ Save Prizes</button>
    <div class="muted" style="margin-top:8px;">Update prize amounts for the user app.</div>
</div>
---
<div class="section">
  <h2>üü¢ Current Game</h2>
  <div class="action-row">
    <button onclick="startGame('current')">Start Game</button>
    <button onclick="stopGame('current')">Stop Game</button>
    <button onclick="resetGame('current')">Reset Game</button>
    <div class="live-box">Status: <span id="currentStatusDisplay">idle</span></div>
    <div class="live-box">Live Users: <span id="liveUserCountDisplay">0</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="currentPrizeInput" type="number" min="1" max="100" placeholder="Prize %"><button onclick="updatePrize('current')">Update Prize</button>
    <div class="live-box">Prize: <span id="currentPrizeDisplay">0%</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="currentTicketsInput" type="number" min="0" placeholder="Tickets Left"><button onclick="updateTickets('current')">Update Tickets</button>
    <div class="live-box">Tickets Left: <span id="currentTicketsDisplay">0</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="currentSpotsInput" type="number" min="0" placeholder="Total Spots"><button onclick="updateSpots('current')">Update Spots</button>
    <div class="live-box">Total Spots: <span id="currentSpotsDisplay">0</span></div>
  </div>
  
  <div style="margin-top:8px">
    <label for="currentCountdownInput_hms">Countdown (HH:MM:SS):</label>
    <input id="currentCountdownInput_h" type="number" min="0" placeholder="HH" class="small w-60">
    <input id="currentCountdownInput_m" type="number" min="0" max="59" placeholder="MM" class="small w-60">
    <input id="currentCountdownInput_s" type="number" min="0" max="59" placeholder="SS" class="small w-60">
    <button onclick="updateCountdown('current')">Update Countdown</button>
    <div class="live-box">Countdown: <span id="currentCountdownDisplay">0s</span></div>
  </div>
  
  <div class="action-row" style="margin-top:8px">
    <input id="currentNumberInput" type="number" min="1" max="90" placeholder="Draw Number">
    <button onclick="broadcastNumber('current')">Broadcast Number</button>
    <button onclick="autoDrawNumber('current')">Auto Draw Every 30s</button>
  </div>
  
  <h3>Tambola Board</h3>
  <div id="currentTambolaBoard" class="tambola-board"></div>

  <h3>üèÜ Winners</h3>
  <div id="currentWinnersForm"></div>
  <button onclick="saveAllWinners('current')">Save All Winners</button>

  <h3>‚úÖ Claims</h3>
  <div id="currentClaimsList"></div>

  <h3>üé´ User Tickets</h3>
  <div id="currentTicketsList"></div>
  
</div>
---
<div class="section">
  <h2>üü° Next Game</h2>
  <div class="action-row">
    <button onclick="startGame('next')">Start Game</button>
    <button onclick="stopGame('next')">Stop Game</button>
    <button onclick="resetGame('next')">Reset Game</button>
    <div class="live-box">Status: <span id="nextStatusDisplay">idle</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="nextPrizeInput" type="number" min="1" max="100" placeholder="Prize %"><button onclick="updatePrize('next')">Update Prize</button>
    <div class="live-box">Prize: <span id="nextPrizeDisplay">0%</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="nextTicketsInput" type="number" min="0" placeholder="Tickets Left"><button onclick="updateTickets('next')">Update Tickets</button>
    <div class="live-box">Tickets Left: <span id="nextTicketsDisplay">0</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="nextSpotsInput" type="number" min="0" placeholder="Total Spots"><button onclick="updateSpots('next')">Update Spots</button>
    <div class="live-box">Total Spots: <span id="nextSpotsDisplay">0</span></div>
  </div>
  
  <div style="margin-top:8px">
    <label for="nextCountdownInput_hms">Countdown (HH:MM:SS):</label>
    <input id="nextCountdownInput_h" type="number" min="0" placeholder="HH" class="small w-60">
    <input id="nextCountdownInput_m" type="number" min="0" max="59" placeholder="MM" class="small w-60">
    <input id="nextCountdownInput_s" type="number" min="0" max="59" placeholder="SS" class="small w-60">
    <button onclick="updateCountdown('next')">Update Countdown</button>
    <div class="live-box">Countdown: <span id="nextCountdownDisplay">0s</span></div>
  </div>
  
  <div class="action-row" style="margin-top:8px">
    <input id="nextNumberInput" type="number" min="1" max="90" placeholder="Draw Number">
    <button onclick="broadcastNumber('next')">Broadcast Number</button>
    <button onclick="autoDrawNumber('next')">Auto Draw Every 30s</button>
  </div>
  
  <h3>Tambola Board</h3>
  <div id="nextTambolaBoard" class="tambola-board"></div>

  <h3>üèÜ Winners</h3>
  <div id="nextWinnersForm"></div>
  <button onclick="saveAllWinners('next')">Save All Winners</button>

  <h3>‚úÖ Claims</h3>
  <div id="nextClaimsList"></div>
  
  <h3>üé´ User Tickets</h3>
  <div id="nextTicketsList"></div>
  
</div>
---
<div class="section">
  <h2>üéÆ Play With Friends</h2>
  <div class="action-row">
    <button onclick="startGame('friends')">Start Game</button>
    <button onclick="stopGame('friends')">Stop Game</button>
    <button onclick="resetGame('friends')">Reset Game</button>
    <div class="live-box">Status: <span id="friendsStatusDisplay">idle</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="friendsPrizeInput" type="number" min="1" max="100" placeholder="Prize %"><button onclick="updatePrize('friends')">Update Prize</button>
    <div class="live-box">Prize: <span id="friendsPrizeDisplay">0%</span></div>
  </div>
  
  <div style="margin-top:8px">
    <input id="friendsSpotsInput" type="number" min="0" placeholder="Total Spots"><button onclick="updateSpots('friends')">Update Spots</button>
    <div class="live-box">Total Spots: <span id="friendsSpotsDisplay">0</span></div>
  </div>
  
  <div style="margin-top:8px">
    <label for="friendsCountdownInput_hms">Countdown (HH:MM:SS):</label>
    <input id="friendsCountdownInput_h" type="number" min="0" placeholder="HH" class="small w-60">
    <input id="friendsCountdownInput_m" type="number" min="0" max="59" placeholder="MM" class="small w-60">
    <input id="friendsCountdownInput_s" type="number" min="0" max="59" placeholder="SS" class="small w-60">
    <button onclick="updateCountdown('friends')">Update Countdown</button>
    <div class="live-box">Countdown: <span id="friendsCountdownDisplay">0s</span></div>
  </div>
  
  <div class="action-row" style="margin-top:8px">
    <input id="friendsNumberInput" type="number" min="1" max="90" placeholder="Draw Number">
    <button onclick="broadcastNumber('friends')">Broadcast Number</button>
    <button onclick="autoDrawNumber('friends')">Auto Draw Every 30s</button>
  </div>
  
  <div class="room-select" style="margin-top:10px">
    <input type="text" id="roomSearch" onkeyup="filterRooms()" placeholder="üîç Search Room...">
    <select id="roomDropdown" onchange="changeRoom()"></select>
  </div>
  
  <h3>Tambola Board</h3>
  <div id="friendsTambolaBoard" class="tambola-board"></div>

  <h3>üèÜ Winners</h3>
  <div id="friendsWinnersForm"></div>
  <button onclick="saveAllWinners('friends')">Save All Winners</button>

  <h3>‚úÖ Claims</h3>
  <div id="friendsClaimsList"></div>
  
  <h3>üé´ User Tickets</h3>
  <div id="friendsTicketsList"></div>
  
</div>
---
<div class="section">
  <h2>üí∞ Withdrawal Requests</h2>
  <div class="table-wrap"><div id="withdrawalsList" class="muted">Loading withdrawals...</div></div>
</div>
---
<div class="section">
  <h2>üë• Users & Balance</h2>
  <div id="usersTicketsList" class="muted">Loading users & tickets...</div>
</div>
---
<div class="section">
  <h2>üèÜ Claims</h2>
  <div id="claimsList" class="muted">Loading claims...</div>
</div>
---
<div class="section">
  <h2>‚öôÔ∏è Quick admin</h2>
  <div class="action-row">
    <div class="live-box">Total Tickets Sold: <span id="totalTicketsSoldDisplay">0</span></div>
    <button onclick="generateBoard('current')">Regenerate Current Board UI</button>
    <button onclick="generateBoard('next')">Regenerate Next Board UI</button>
    <button onclick="generateBoard('friends')">Regenerate Friends Board UI</button>
  </div>
</div>

</body>
</html>
