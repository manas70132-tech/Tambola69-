<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Admin Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
        }

        .loader {
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            color: #4CAF50;
            margin-top: 15px;
            font-size: 1.2em;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            box-sizing: border-box;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .container.visible {
            display: block;
            opacity: 1;
        }

        header {
            background-color: #1f1f1f;
            color: #4CAF50;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #4CAF50;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-section {
            background-color: #1f1f1f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        h2 {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-top: 0;
            color: #4CAF50;
        }

        .control-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #bbb;
        }

        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            box-sizing: border-box;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
            color: #e0e0e0;
        }
        
        .input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

        .input-group input {
            flex-grow: 1;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 5px;
            width: 100%;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #007bff;
        }

        .btn-secondary:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-ghost {
            background: none;
            color: #4CAF50;
            border: 1px solid #4CAF50;
            padding: 5px 10px;
            margin: 0 5px 0 0;
            width: auto;
        }
        
        .btn-ghost:hover {
            background-color: #2a3a2b;
        }

        .status-display {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-idle { background-color: #555; color: white; }
        .status-started { background-color: #28a745; color: white; }
        .status-stopped, .status-gameOver { background-color: #dc3545; color: white; }

        .tambola-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            margin-top: 15px;
        }

        .board-cell {
            background-color: #333;
            color: #e0e0e0;
            padding: 5px;
            text-align: center;
            border-radius: 3px;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
        }

        .board-cell.drawn {
            background-color: #4CAF50;
            color: #121212;
            font-weight: bold;
        }
        
        .winner-card {
            border: 1px solid #4CAF50;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #252525;
        }
        
        .winner-card input {
            margin-bottom: 5px;
        }

        .claims-section, .withdrawals-section {
            background-color: #1f1f1f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .claim-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #555;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #252525;
        }
        
        .muted {
            color: #999;
            font-size: 0.9em;
        }
        
        .table-small {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-small th, .table-small td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        .table-small th {
            color: #4CAF50;
        }
        
        .prize-management {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .tab-button {
            background-color: #333;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tab-button.active {
            background-color: #4CAF50;
        }

        .tab-content {
            display: none;
            background-color: #1f1f1f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Advanced Slider CSS */
        #slidesTbody input {
            margin-bottom: 0;
        }
        .w-220 { width: 220px !important; }
        .w-160 { width: 160px !important; }
        .w-120 { width: 120px !important; }
        .row-actions button {
            width: auto;
            padding: 5px;
            margin-right: 2px;
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="loading-screen">
        <div>
            <div class="loader"></div>
            <div class="loader-text">Loading Admin Panel...</div>
        </div>
    </div>

    <div id="main-content" class="container">
        <header>
            <h1>Tambola Live Game Admin Panel üé≤</h1>
            <p>Live Users: <span id="liveUserCountDisplay">0</span> | Total Tickets Sold: <span id="totalTicketsSoldDisplay">0</span></p>
        </header>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'GameControl')">Game Control</button>
            <button class="tab-button" onclick="openTab(event, 'ClaimsWithdrawals')">Claims & Withdrawals</button>
            <button class="tab-button" onclick="openTab(event, 'GlobalSettings')">Global Settings</button>
            <button class="tab-button" onclick="openTab(event, 'UsersTickets')">Users & Tickets</button>
        </div>

        <div id="GameControl" class="tab-content active">
            <div class="dashboard-grid">
                
                <div class="game-section">
                    <h2>Current Game üü¢</h2>
                    <div class="control-group">
                        <label>Status:</label>
                        <div id="currentStatusDisplay" class="status-display status-idle">Idle</div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-secondary" onclick="startGame('current')">Start</button>
                            <button class="btn-danger" onclick="stopGame('current')">Stop</button>
                            <button onclick="resetGame('current')">Reset</button>
                        </div>
                        <button onclick="clearGameClaimsAndTickets('current')" style="background-color:#d4af37; margin-top: 10px;">Fix: Clear Claims & Tickets</button>
                    </div>

                    <div class="control-group">
                        <label>Prize Percentage (%) / Current: <span id="currentPrizeDisplay">0%</span></label>
                        <input type="number" id="currentPrizeInput" min="1" max="100" placeholder="Enter % (1-100)">
                        <button onclick="updatePrize('current')">Update Prize %</button>
                    </div>

                    <div class="control-group">
                        <label>Tickets Left / Current: <span id="currentTicketsDisplay">0</span></label>
                        <input type="number" id="currentTicketsInput" min="0" placeholder="Enter tickets left">
                        <button onclick="updateTickets('current')">Update Tickets</button>
                    </div>
                    
                     <div class="control-group">
                        <label>Total Spots / Current: <span id="currentSpotsDisplay">0</span></label>
                        <input type="number" id="currentSpotsInput" min="0" placeholder="Enter total spots">
                        <button onclick="updateSpots('current')">Update Spots</button>
                    </div>

                    <div class="control-group">
                        <label>Countdown Timer / Current: <span id="currentCountdownDisplay">00:00:00</span></label>
                        <div class="input-group">
                            <input type="number" id="currentCountdownInput_h" placeholder="H" min="0">
                            <input type="number" id="currentCountdownInput_m" placeholder="M" min="0" max="59">
                            <input type="number" id="currentCountdownInput_s" placeholder="S" min="0" max="59">
                        </div>
                        <button onclick="updateCountdown('current')">Set Countdown</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Broadcast Live Number:</label>
                        <input type="number" id="currentNumberInput" min="1" max="90" placeholder="Enter number (1-90)">
                        <button onclick="broadcastNumber('current')">Broadcast Number</button>
                        <button class="btn-secondary" onclick="autoDrawNumber('current')">Start Auto Draw (30s)</button>
                    </div>
                    
                    <h3>Tambola Board</h3>
                    <div id="currentTambolaBoard" class="tambola-board"></div>
                    
                    <h3>Game Claims</h3>
                    <div id="currentGameClaimsList"></div>
                    
                    <h3>Sold Tickets</h3>
                    <div id="currentTicketsList"></div>
                </div>

                <div class="game-section">
                    <h2>Next Game ‚û°Ô∏è</h2>
                    <div class="control-group">
                        <label>Status:</label>
                        <div id="nextStatusDisplay" class="status-display status-idle">Idle</div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-secondary" onclick="startGame('next')">Start</button>
                            <button class="btn-danger" onclick="stopGame('next')">Stop</button>
                            <button onclick="resetGame('next')">Reset</button>
                        </div>
                        <button onclick="clearGameClaimsAndTickets('next')" style="background-color:#d4af37; margin-top: 10px;">Fix: Clear Claims & Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Prize Percentage (%) / Current: <span id="nextPrizeDisplay">0%</span></label>
                        <input type="number" id="nextPrizeInput" min="1" max="100" placeholder="Enter % (1-100)">
                        <button onclick="updatePrize('next')">Update Prize %</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Tickets Left / Current: <span id="nextTicketsDisplay">0</span></label>
                        <input type="number" id="nextTicketsInput" min="0" placeholder="Enter tickets left">
                        <button onclick="updateTickets('next')">Update Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Total Spots / Current: <span id="nextSpotsDisplay">0</span></label>
                        <input type="number" id="nextSpotsInput" min="0" placeholder="Enter total spots">
                        <button onclick="updateSpots('next')">Update Spots</button>
                    </div>

                    <div class="control-group">
                        <label>Countdown Timer / Current: <span id="nextCountdownDisplay">00:00:00</span></label>
                        <div class="input-group">
                            <input type="number" id="nextCountdownInput_h" placeholder="H" min="0">
                            <input type="number" id="nextCountdownInput_m" placeholder="M" min="0" max="59">
                            <input type="number" id="nextCountdownInput_s" placeholder="S" min="0" max="59">
                        </div>
                        <button onclick="updateCountdown('next')">Set Countdown</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Broadcast Live Number:</label>
                        <input type="number" id="nextNumberInput" min="1" max="90" placeholder="Enter number (1-90)">
                        <button onclick="broadcastNumber('next')">Broadcast Number</button>
                        <button class="btn-secondary" onclick="autoDrawNumber('next')">Start Auto Draw (30s)</button>
                    </div>
                    
                    <h3>Tambola Board</h3>
                    <div id="nextTambolaBoard" class="tambola-board"></div>
                    
                    <h3>Game Claims</h3>
                    <div id="nextGameClaimsList"></div>
                    
                    <h3>Sold Tickets</h3>
                    <div id="nextTicketsList"></div>
                </div>

                <div class="game-section">
                    <h2>Friends Room Control ü§ù</h2>
                    <div class="control-group">
                        <label>Select Room:</label>
                        <div class="input-group">
                            <input type="text" id="roomSearch" placeholder="Search/Filter Room (e.g., Room101)" oninput="filterRooms()">
                            <select id="roomDropdown" onchange="changeRoom()"></select>
                        </div>
                        <div id="friendsStatusDisplay" class="status-display status-idle">Idle</div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button class="btn-secondary" onclick="startGame('friends')">Start</button>
                            <button class="btn-danger" onclick="stopGame('friends')">Stop</button>
                            <button onclick="resetGame('friends')">Reset</button>
                        </div>
                        <button onclick="clearGameClaimsAndTickets('friends')" style="background-color:#d4af37; margin-top: 10px;">Fix: Clear Claims & Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Prize Percentage (%) / Current: <span id="friendsPrizeDisplay">0%</span></label>
                        <input type="number" id="friendsPrizeInput" min="1" max="100" placeholder="Enter % (1-100)">
                        <button onclick="updatePrize('friends')">Update Prize %</button>
                    </div>

                    <div class="control-group">
                        <label>Tickets Left / Current: <span id="friendsTicketsDisplay">0</span></label>
                        <input type="number" id="friendsTicketsInput" min="0" placeholder="Enter tickets left">
                        <button onclick="updateTickets('friends')">Update Tickets</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Total Spots / Current: <span id="friendsSpotsDisplay">0</span></label>
                        <input type="number" id="friendsSpotsInput" min="0" placeholder="Enter total spots">
                        <button onclick="updateSpots('friends')">Update Spots</button>
                    </div>

                    <div class="control-group">
                        <label>Countdown Timer / Current: <span id="friendsCountdownDisplay">00:00:00</span></label>
                        <div class="input-group">
                            <input type="number" id="friendsCountdownInput_h" placeholder="H" min="0">
                            <input type="number" id="friendsCountdownInput_m" placeholder="M" min="0" max="59">
                            <input type="number" id="friendsCountdownInput_s" placeholder="S" min="0" max="59">
                        </div>
                        <button onclick="updateCountdown('friends')">Set Countdown</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Broadcast Live Number:</label>
                        <input type="number" id="friendsNumberInput" min="1" max="90" placeholder="Enter number (1-90)">
                        <button onclick="broadcastNumber('friends')">Broadcast Number</button>
                        <button class="btn-secondary" onclick="autoDrawNumber('friends')">Start Auto Draw (30s)</button>
                    </div>

                    <h3>Tambola Board</h3>
                    <div id="friendsTambolaBoard" class="tambola-board"></div>
                    
                    <h3>Game Claims</h3>
                    <div id="friendsGameClaimsList"></div>
                    
                    <h3>Sold Tickets</h3>
                    <div id="friendsTicketsList"></div>
                </div>
            </div>

            <div class="game-section">
                <h2>Global Game Actions üåê (CRITICAL FIXES)</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="startNewGameForAll()" class="btn-secondary" style="background-color: #28a745; flex: 1;">
                        ‚úÖ Start New Game for All (Global Claims/Tickets Reset)
                    </button>
                    <button onclick="endAllGamesAndResetTickets()" class="btn-danger" style="flex: 1;">
                        ‚ùå Game Over & Reset All Tickets (Global Claims/Tickets Clear)
                    </button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="game-section">
                    <h2>Winners Management</h2>
                    <div class="control-group">
                        <label>Game Select:</label>
                        <select id="winnersGameSelect" onchange="loadWinnersForm(this.value)">
                            <option value="current">Current Game</option>
                            <option value="next">Next Game</option>
                            <option value="friends">Friends Game</option>
                        </select>
                        <div id="currentWinnersForm" style="margin-top: 10px;"></div>
                        <button onclick="saveAllWinners(document.getElementById('winnersGameSelect').value)">Save All Winners</button>
                    </div>
                </div>
                
                <div class="game-section">
                    <h2>Global Prize Amounts (‚Çπ)</h2>
                    <div id="prizeManagementContainer" class="prize-management">
                        </div>
                    <div class="muted" id="prizeUpdateMessage" style="margin-top: 10px;"></div>
                    <button onclick="savePrizes()">Update Global Prizes</button>
                </div>
            </div>
        </div>

        <div id="ClaimsWithdrawals" class="tab-content">
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                
                <div class="claims-section">
                    <h2>Live Claims Management üîî</h2>
                    <button id="toggleClaimsButton" onclick="toggleClaimsView()" class="btn-secondary" style="width: auto; margin-bottom: 15px;">View All Claims</button>
                    <div id="claimsList">
                        </div>
                </div>

                <div class="withdrawals-section">
                    <h2>Withdrawal Requests üí∞</h2>
                    <div id="withdrawalsList">
                        </div>
                </div>
            </div>
        </div>
        
        <div id="GlobalSettings" class="tab-content">
            <div class="dashboard-grid">
                
                <div class="game-section">
                    <h2>Notifications üì¢</h2>
                    <div class="control-group">
                        <label>Message:</label>
                        <textarea id="notifyMessage" placeholder="Enter notification message..."></textarea>
                    </div>
                    <div class="control-group">
                        <label>Target User ID (Optional, leave blank for general notification):</label>
                        <input type="text" id="notifyTo" placeholder="User ID (e.g., U123456)">
                    </div>
                    <div class="control-group" style="border: none;">
                        <input type="checkbox" id="notifyBroadcast" checked>
                        <label for="notifyBroadcast" style="display: inline; font-weight: normal;">Broadcast to all users (Overrides Target User ID)</label>
                    </div>
                    <button onclick="sendNotification()">Send Notification</button>
                </div>
                
                <div class="game-section">
                    <h2>Music Control üé∂</h2>
                    <label>YouTube/SoundCloud URL:</label>
                    <input type="text" id="musicUrlInput" placeholder="Enter music URL">
                    <button onclick="saveMusicUrl()">Save Music URL</button>
                    <button id="toggleMusicBtn" class="btn-secondary" onclick="toggleMusic()" style="margin-top: 10px;">‚ñ∂Ô∏è Play</button>
                </div>
                
                <div class="game-section">
                    <h2>Video Control üé•</h2>
                    <label>YouTube Video ID or Embed URL:</label>
                    <input type="text" id="videoUrlInput" placeholder="Enter video URL or ID">
                    <button onclick="saveVideoUrl()">Save Video URL</button>
                    <button id="toggleVideoBtn" class="btn-secondary" onclick="toggleVideo()" style="margin-top: 10px;">‚ñ∂Ô∏è ‡§™‡•ç‡§≤‡•á</button>
                </div>
                
                <div class="game-section" style="grid-column: 1 / -1;">
                    <h2>Slider/Banner Control üñºÔ∏è</h2>
                    <p>Current Index: <span id="currentIndexDisplay">0</span> | Speed: <span id="speedDisplay">0 ms</span></p>
                    <div class="control-group">
                        <label>Set Auto-Play Speed (ms):</label>
                        <input type="number" id="speedInput" placeholder="e.g., 5000 for 5 seconds" min="500">
                        <button onclick="setSpeed()">Set Speed</button>
                    </div>
                    
                    <div class="control-group">
                        <label>Manual Controls:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="toggleSliderBtn" class="btn-secondary" onclick="toggleSliderPlay()">‚ñ∂Ô∏è Play</button>
                            <button onclick="prevSlide()">‚Üê Prev</button>
                            <button onclick="nextSlide()">Next ‚Üí</button>
                            <input type="number" id="gotoIndexInput" placeholder="Go To Index" style="width: 100px;">
                            <button onclick="goToSlide()">Go</button>
                        </div>
                    </div>
                    
                    <h3>Slides Configuration</h3>
                    <table style="width: 100%; margin-top: 10px; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 120px;">Actions</th>
                                <th>Image URL</th>
                                <th>Link URL</th>
                                <th>Overlay Text</th>
                                <th>Button (Text / Link)</th>
                                <th>Size (Width / Height)</th>
                            </tr>
                        </thead>
                        <tbody id="slidesTbody">
                            </tbody>
                    </table>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="addSlideRow()" style="background-color: #007bff; flex: 1;">+ Add Slide</button>
                        <button onclick="saveSlidesAdvanced()" style="flex: 1;">Save All Slides</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="UsersTickets" class="tab-content">
            <div class="dashboard-grid">
                <div class="game-section">
                    <h2>All Users (Balance) üë§</h2>
                    <div id="usersTicketsList">
                        </div>
                </div>
                </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
    // Firebase Configuration - REPLACE WITH YOUR FIREBASE PROJECT DETAILS
    // Note: You must fill in your actual Firebase config here for the script to work.
    const firebaseConfig = {
      apiKey: "AIzaSyAphHTM4faH7_FVXdnootp4NipZd3vtEck",
      authDomain: "tambola69-9dc8f.firebaseapp.com",
      databaseURL: "https://tambola69-9dc8f-default-rtdb.firebaseio.com",
      projectId: "tambola69-9dc8f",
      storageBucket: "tambola69-9dc8f.firebasestorage.app",
      messagingSenderId: "413290158586",
      appId: "1:413290158586:web:c4c6d6d224c96a7487ec43",
      measurementId: "G-TM68JPXH18"
    };

    // Initialize Firebase with error handling
    let db;
    try {
      if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          console.log("Firebase connection successful!");
        } else {
          console.log("Firebase app already running.");
        }
        db = firebase.database();
      } else {
        throw new Error("Firebase config missing or incomplete.");
      }
    } catch (e) {
      console.error("Firebase initialization failed:", e);
      alert("Firebase setup issue. Admin panel will load without Firebase features. Please fill in `firebaseConfig`.");
    }

    // Firebase references (only if Firebase is initialized)
    const currentGameRef = db ? db.ref('currentGame') : null;
    const nextGameRef = db ? db.ref('nextGame') : null;
    const presenceRef = db ? db.ref('presence') : null;
    const roomsRef = db ? db.ref('rooms') : null;
    let selectedRoom = "Room1";
    let friendsGameRef = roomsRef ? roomsRef.child(selectedRoom) : null;
    const musicRef = db ? db.ref("music") : null;
    const videoRef = db ? db.ref("video") : null;
    const sliderRef = db ? db.ref('slider') : null;
    const prizesRef = db ? db.ref('prizes') : null;
    const userTicketsRef = db ? db.ref('userTickets') : null; // Reference to userTickets
    const globalClaimsRef = db ? db.ref('claims') : null; // Global claims ref - CRITICAL FOR FIX
    let localSlides = [];
    const autoTimers = { current: null, next: null, friends: null };

    let countdownIntervals = {
      current: null,
      next: null,
      friends: null
    };

    const listeners = {
      current: {},
      next: {},
      friends: {},
      globalClaims: null,
      globalWithdrawals: null,
      globalUsers: null
    };

    function refFor(key) {
      if (key === 'current') return currentGameRef;
      if (key === 'next') return nextGameRef;
      if (key === 'friends') return friendsGameRef;
      return null;
    }

    // --- FIX: FUNCTION TO CLEAR CLAIMS AND ENABLE NEW TICKET BOOKING ---
    /**
     * Clears game-specific claims, global claims, and game-specific tickets,
     * enabling new ticket generation for the specified game.
     * @param {string} game - The game key ('current', 'next', 'friends').
     */
    function clearGameClaimsAndTickets(game) {
        if (!db) return alert("Firebase not initialized.");
        const gameRef = refFor(game);
        if (!gameRef) return alert('Invalid game key');

        if (!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§ö ‡§Æ‡•á‡§Ç ${game.toUpperCase()} ‡§ó‡•á‡§Æ ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§™‡§ø‡§õ‡§≤‡•á 'claims' (‡§ó‡•á‡§Æ-‡§∏‡•ç‡§™‡•á‡§∏‡§ø‡§´‡§º‡§ø‡§ï ‡§î‡§∞ ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§¶‡•ã‡§®‡•ã‡§Ç) ‡§î‡§∞ 'tickets' ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§ê‡§∏‡§æ ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§è ‡§ü‡§ø‡§ï‡§ü ‡§¨‡•Å‡§ï ‡§ï‡§∞ ‡§™‡§æ‡§è‡§Ç‡§ó‡•á ‡§î‡§∞ ‡§â‡§®‡•ç‡§π‡•á‡§Ç 'already claimed' ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§è‡§ó‡•Ä‡•§`)) {
            return;
        }

        // 1. Clear game-specific claims and tickets
        const gameUpdatePromise = gameRef.update({
            claims: null, // Clear game-specific claims
            tickets: null // Clear tickets booked for this specific game
        }).then(() => `‚úÖ Game ${game} claims and tickets cleared.`);

        // 2. Clear the global 'claims' node (CRITICAL FIX FOR "ALREADY CLAIMED")
        const claimsClearPromise = globalClaimsRef.remove()
            .then(() => '‚úÖ Global claims cleared successfully (Users will no longer see "already claimed").')
            .catch(e => {
                console.error("Error clearing claims:", e);
                return `‚ùå Error clearing global claims: ${e.message}`;
            });
            
        // 3. Send a notification to inform users
        const notificationPromise = db.ref('notifications').push({
            message: `New round for ${game.toUpperCase()} started! All previous claims/tickets cleared. Book new tickets now!`,
            time: firebase.database.ServerValue.TIMESTAMP
        }).then(() => '‚úÖ Notification sent.');

        Promise.all([gameUpdatePromise, claimsClearPromise, notificationPromise])
            .then(results => {
                console.log("Clear Claims & New Ticket results:", results);
                alert(`‚úÖ ${game.toUpperCase()} Claims/Tickets Reset Complete!\n\nDetails: \n` + results.join('\n'));
            })
            .catch(e => {
                console.error("Critical error during claims/tickets reset:", e);
                alert("‚ùå CRITICAL ERROR during claims/tickets reset: " + e.message + ". Please check Firebase console.");
            });
    }
    // --- END FIX FUNCTION ---

    // --- FIX: UPDATED FUNCTION TO START ALL GAMES AFTER RESET ---
    /**
     * Starts all games (current, next, and current friends room) and resets necessary data.
     */
    function startNewGameForAll() {
        if (!db) return alert("Firebase not initialized.");

        if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§ö ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§ó‡•á‡§Æ‡•ç‡§∏ (Current, Next, Friends) ‡§ï‡•ã 'Started' ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡§ï‡•á ‡§®‡§Ø‡§æ ‡§ó‡•á‡§Æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) {
            return;
        }

        const gameKeys = ['current', 'next', 'friends'];
        const gameRefs = gameKeys.map(refFor).filter(ref => ref !== null);
        
        // 1. Update status to 'started' and clear history/claims/winners/tickets for all active games
        const gameUpdatePromises = gameRefs.map(ref => {
            clearInterval(autoTimers[ref.key]); // Stop auto-draw if running
            clearInterval(countdownIntervals[ref.key]); // Stop countdown
            return ref.update({
                status: 'started',
                liveNumber: null,
                countdown: 0, // Reset countdown to 0
                history: null,
                claims: null, // <<-- ‡§ó‡•á‡§Æ-‡§∏‡•ç‡§™‡•á‡§∏‡§ø‡§´‡§º‡§ø‡§ï ‡§ï‡•ç‡§≤‡•á‡§Æ ‡§∞‡•Ä‡§∏‡•á‡§ü
                winners: null,
                tickets: null, // ‡§™‡§ø‡§õ‡§≤‡•á ‡§ñ‡§∞‡•Ä‡§¶‡•á ‡§ó‡§è ‡§ü‡§ø‡§ï‡§ü ‡§π‡§ü‡§æ‡§è
                startTime: firebase.database.ServerValue.TIMESTAMP // Set new start time
            }).then(() => {
                 updateStatusUI(ref.key, 'started');
                 return `Game ${ref.key} updated to 'started' and history/claims/winners cleared.`;
            });
        });
        
        // 2. Clear the global 'claims' node (CRITICAL FIX FOR "ALREADY CLAIMED")
        const claimsClearPromise = globalClaimsRef.remove()
            .then(() => '‚úÖ Global claims cleared successfully (Users will no longer see "already claimed").')
            .catch(e => {
                console.error("Error clearing claims:", e);
                return `‚ùå Error clearing global claims: ${e.message}`;
            });
            
        // 3. Send a notification to all users about the new game
        const notificationPromise = db.ref('notifications').push({
            message: 'New Game Started! Book your tickets now!',
            time: firebase.database.ServerValue.TIMESTAMP
        }).then(() => 'Start new game notification sent.');

        Promise.all([...gameUpdatePromises, claimsClearPromise, notificationPromise])
            .then(results => {
                console.log("Start New Game results:", results);
                alert("‚úÖ New Game Started Successfully! Users can now book new tickets. \n\nDetails: \n" + results.join('\n'));
            })
            .catch(e => {
                console.error("Critical error during start new game:", e);
                alert("‚ùå CRITICAL ERROR during start new game: " + e.message + ". Please check Firebase console.");
            });
    }
    // --- END UPDATED FUNCTION ---


    // --- FIX: UPDATED FUNCTION TO END ALL GAMES AND RESET TICKETS ---
    /**
     * Stops all games (current, next, and current friends room), sets status to 'gameOver',
     * clears all booked tickets for those games, and resets the global 'userTickets' node AND 'claims' node.
     */
    function endAllGamesAndResetTickets() {
        if (!db) return alert("Firebase not initialized.");

        if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡§ö ‡§Æ‡•á‡§Ç ‡§∏‡§≠‡•Ä ‡§ó‡•á‡§Æ‡•ç‡§∏ (Current, Next, Friends) ‡§ï‡•ã 'Game Over' ‡§ï‡§∞‡§ï‡•á ‡§â‡§®‡§ï‡•á ‡§î‡§∞ ‡§∏‡§≠‡•Ä users ‡§ï‡•á tickets ‡§ï‡•ã reset ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§°‡•á‡§ü‡§æ Permanent ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞ ‡§¶‡•á‡§ó‡§æ‡•§ ‡§∏‡§æ‡§• ‡§π‡•Ä, ‡§Ø‡§π users ‡§ï‡•á 'claims' ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§≠‡•Ä ‡§π‡§ü‡§æ ‡§¶‡•á‡§ó‡§æ, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§â‡§®‡•ç‡§π‡•á‡§Ç 'already claimed' ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§è‡§ó‡•Ä‡•§")) {
            return;
        }

        const gameKeys = ['current', 'next', 'friends'];
        const gameRefs = gameKeys.map(refFor).filter(ref => ref !== null);
        
        // 1. Update status to 'gameOver' and clear tickets/history/claims/winners for all active games
        const gameUpdatePromises = gameRefs.map(ref => {
            clearInterval(autoTimers[ref.key]); // Stop auto-draw if running
            clearInterval(countdownIntervals[ref.key]); // Stop countdown
            return ref.update({
                status: 'gameOver',
                liveNumber: null,
                countdown: 0,
                history: null,
                claims: null,
                winners: null,
                tickets: null // Clear tickets booked for this specific game
            }).then(() => {
                 updateStatusUI(ref.key, 'gameOver');
                 return `Game ${ref.key} updated to 'gameOver' and game tickets cleared.`;
            });
        });

        // 2. Clear the main userTickets node
        const userTicketsClearPromise = userTicketsRef.remove()
            .then(() => '‚úÖ Global userTickets cleared successfully (Users can book new tickets).')
            .catch(e => {
                console.error("Error clearing userTickets:", e);
                return `‚ùå Error clearing global userTickets: ${e.message}`;
            });
            
        // 3. Clear the global 'claims' node (CRITICAL FIX FOR "ALREADY CLAIMED")
        const claimsClearPromise = globalClaimsRef.remove()
            .then(() => '‚úÖ Global claims cleared successfully (Users will no longer see "already claimed").')
            .catch(e => {
                console.error("Error clearing claims:", e);
                return `‚ùå Error clearing global claims: ${e.message}`;
            });
            
        // 4. Send a notification to all users about the game reset
        const notificationPromise = db.ref('notifications').push({
            message: 'Game Over! All tickets reset. Please wait for the Admin to start a new game.',
            time: firebase.database.ServerValue.TIMESTAMP
        }).then(() => 'Reset notification sent.');

        Promise.all([...gameUpdatePromises, userTicketsClearPromise, claimsClearPromise, notificationPromise])
            .then(results => {
                console.log("Reset results:", results);
                alert("‚úÖ Game Over and Reset Complete! Users must now wait for 'Start New Game' to book tickets. \n\nDetails: \n" + results.join('\n'));
            })
            .catch(e => {
                console.error("Critical error during reset:", e);
                alert("‚ùå CRITICAL ERROR during reset: " + e.message + ". Please check Firebase console.");
            });
    }
    // --- END UPDATED FUNCTION ---


    function startCountdown(key, duration) {
      if (!db) return;
      let timerRef = refFor(key).child('countdown');
      let timeLeft = duration;
      
      clearInterval(countdownIntervals[key]);

      countdownIntervals[key] = setInterval(() => {
        timeLeft--;
        timerRef.set(timeLeft).catch(e => console.error(`Error updating countdown for ${key}:`, e));
        if (timeLeft <= 0) {
          clearInterval(countdownIntervals[key]);
          timerRef.set(0);
        }
      }, 1000);
    }

    function saveMusicUrl() {
      if (!db) return alert("Firebase not initialized.");
      const url = document.getElementById("musicUrlInput").value.trim();
      if (!url) return alert("Enter music URL first");
      musicRef.update({ url })
        .then(() => alert("Music URL updated ‚úÖ"))
        .catch(e => alert("Error updating music URL: " + e.message));
    }

    async function toggleMusic() {
      if (!db) return alert("Firebase not initialized.");
      const snap = await musicRef.once("value");
      const data = snap.val() || {};
      const newState = !data.isPlaying;
      musicRef.update({ isPlaying: newState })
        .catch(e => alert("Error toggling music: " + e.message));
    }

    function saveVideoUrl() {
      if (!db) return alert("Firebase not initialized.");
      const url = (document.getElementById('videoUrlInput') || {}).value || '';
      if (!url.trim()) return alert('‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã URL ‡§°‡§æ‡§≤‡•á‡§Ç');
      videoRef.update({ url })
        .then(() => alert('‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã URL ‡§∏‡•á‡§µ ‚úÖ'))
        .catch(e => alert("Error updating video URL: " + e.message));
    }

    async function toggleVideo() {
      if (!db) return alert("Firebase not initialized.");
      const snap = await videoRef.once('value');
      const d = snap.val() || {};
      const isPlaying = !d.isPlaying;
      await videoRef.update({ isPlaying })
        .catch(e => alert("Error toggling video: " + e.message));
    }

    function blankSlide() {
      return { src: '', linkUrl: '', title: '', buttonText: '', buttonUrl: '', width: '', height: '' };
    }

    function renderSlidesTable() {
      const tbody = document.getElementById('slidesTbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      localSlides.forEach((s, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="row-actions">
            <button onclick="moveSlide(${i}, -1)">‚Üë</button>
            <button onclick="moveSlide(${i}, 1)">‚Üì</button>
            <button onclick="deleteSlide(${i})">üóë</button>
          </td>
          <td><input class="w-220" placeholder="Image URL" value="${escapeHtml(s.src)}" oninput="onCellChange(${i}, 'src', this.value)"></td>
          <td><input class="w-220" placeholder="Link URL (image click)" value="${escapeHtml(s.linkUrl || '')}" oninput="onCellChange(${i}, 'linkUrl', this.value)"></td>
          <td><input class="w-220" placeholder="Title / Text (overlay)" value="${escapeHtml(s.title || '')}" oninput="onCellChange(${i}, 'title', this.value)"></td>
          <td>
            <input class="w-160" placeholder="Button Text" value="${escapeHtml(s.buttonText || '')}" oninput="onCellChange(${i}, 'buttonText', this.value)">
            <input class="w-220" placeholder="Button Link URL" value="${escapeHtml(s.buttonUrl || '')}" oninput="onCellChange(${i}, 'buttonUrl', this.value)">
          </td>
          <td>
            <input class="w-120" type="number" min="0" placeholder="Width (px)" value="${escapeHtml(s.width || '')}" oninput="onCellChange(${i}, 'width', this.value)">
            <input class="w-120" type="number" min="0" placeholder="Height (px)" value="${escapeHtml(s.height || '')}" oninput="onCellChange(${i}, 'height', this.value)">
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('slidesCount').innerText = localSlides.length;
    }

    function onCellChange(i, key, val) {
      localSlides[i][key] = val;
    }

    function addSlideRow() {
      localSlides.push(blankSlide());
      renderSlidesTable();
    }

    function deleteSlide(i) {
      if (!confirm('Delete this slide?')) return;
      localSlides.splice(i, 1);
      renderSlidesTable();
    }

    function moveSlide(i, dir) {
      const j = i + dir;
      if (j < 0 || j >= localSlides.length) return;
      const tmp = localSlides[i];
      localSlides[i] = localSlides[j];
      localSlides[j] = tmp;
      renderSlidesTable();
    }

    function saveSlidesAdvanced() {
      if (!db) return alert("Firebase not initialized.");
      const cleaned = localSlides
        .map(s => ({
          src: (s.src || '').trim(),
          linkUrl: (s.linkUrl || '').trim(),
          title: (s.title || '').trim(),
          buttonText: (s.buttonText || '').trim(),
          buttonUrl: (s.buttonUrl || '').trim(),
          width: s.width !== '' ? Number(s.width) : '',
          height: s.height !== '' ? Number(s.height) : ''
        }))
        .filter(s => s.src);
      if (!cleaned.length) return alert('‡§ï‡§Æ-‡§∏‡•á-‡§ï‡§Æ ‡§è‡§ï slide ‡§ï‡§æ Image URL ‡§≠‡§∞‡•á‡§Ç');
      sliderRef.update({ slides: cleaned })
        .then(() => alert('Slides updated ‚úÖ'))
        .catch(e => alert('Error updating slides: ' + e.message));
    }

    async function toggleSliderPlay() {
      if (!db) return alert("Firebase not initialized.");
      const snap = await sliderRef.once('value');
      const data = snap.val() || {};
      const newState = !data.isPlaying;
      await sliderRef.update({ isPlaying: newState })
        .catch(e => alert('Error toggling slider: ' + e.message));
    }

    function nextSlide() {
      if (!db) return alert("Firebase not initialized.");
      sliderRef.child('currentIndex').transaction(i => (typeof i === 'number' ? i : 0) + 1)
        .catch(e => alert('Error advancing slide: ' + e.message));
    }

    function prevSlide() {
      if (!db) return alert("Firebase not initialized.");
      sliderRef.child('currentIndex').transaction(i => {
        const cur = (typeof i === 'number' ? i : 0);
        return cur - 1;
      }).catch(e => alert('Error going to previous slide: ' + e.message));
    }

    function goToSlide() {
      if (!db) return alert("Firebase not initialized.");
      const idx = parseInt((document.getElementById('gotoIndexInput') || {}).value) || 0;
      sliderRef.update({ currentIndex: idx })
        .catch(e => alert('Error setting slide index: ' + e.message));
    }

    function setSpeed() {
      if (!db) return alert("Firebase not initialized.");
      const ms = parseInt((document.getElementById('speedInput') || {}).value) || 0;
      if (ms < 500) return alert('Minimum 500 ms');
      sliderRef.update({ speedMs: ms })
        .catch(e => alert('Error setting slider speed: ' + e.message));
    }

    function startGame(key) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(key);
      if (!ref) return alert('Invalid game key');
      ref.update({ status: 'started', liveNumber: null, history: [], startTime: new Date().toISOString(), claims: null, winners: null, tickets: null }) // Added tickets: null to ensure start game also clears tickets
        .then(() => {
          updateStatusUI(key, 'started');
          alert(key + ' started ‚úÖ');
        })
        .catch(e => alert('Error starting game: ' + e.message));
    }

    function stopGame(key) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(key);
      if (!ref) return alert('Invalid game key');
      clearInterval(autoTimers[key]);
      clearInterval(countdownIntervals[key]);
      ref.update({ status: 'stopped', stopTime: new Date().toISOString(), countdown: 0 })
        .then(() => {
          updateStatusUI(key, 'stopped');
          alert(key + ' stopped ‚èπ');
        })
        .catch(e => alert('Error stopping game: ' + e.message));
    }

    // --- FIX: UPDATED resetGame function to clear global claims also ---
    function resetGame(key) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(key);
      if (!ref) return alert('Invalid game key');
      clearInterval(autoTimers[key]);
      clearInterval(countdownIntervals[key]);

      const gameResetPromise = ref.update({
        status: 'idle', liveNumber: null, countdown: null, ticketsLeft: null, totalSpots: null, history: null, winners: null, claims: null, tickets: null
      }).then(() => {
        clearBoardHighlights(key);
        updateStatusUI(key, 'idle');
        return `${key} reset to idle üîÑ`;
      }).catch(e => {
        console.error(`Error resetting game ${key}:`, e);
        return `Error resetting game ${key}: ${e.message}`;
      });

      // Also clear global claims to resolve any residual "already claimed" issues (CRITICAL FIX)
      const claimsClearPromise = globalClaimsRef.remove()
        .then(() => '‚úÖ Global claims cleared successfully.')
        .catch(e => {
          console.error("Error clearing global claims in reset:", e);
          return `‚ùå Error clearing global claims: ${e.message}`;
        });

      Promise.all([gameResetPromise, claimsClearPromise])
        .then(results => {
          alert(`‚úÖ Reset Complete for ${key}.\n\nDetails: \n` + results.join('\n'));
        });
    }
    // --- END UPDATED resetGame function ---

    function updateStatusUI(key, value) {
      const el = document.getElementById(`${key}StatusDisplay`);
      if (el) {
        el.innerText = value;
        el.className = `status-display status-${value.toLowerCase().replace(/\s/g, '-')}`;
      }
    }

    function clearBoardHighlights(game) {
      const id = (game === 'current') ? 'currentTambolaBoard' : (game === 'next') ? 'nextTambolaBoard' : 'friendsTambolaBoard';
      const board = document.getElementById(id);
      if (!board) return;
      Array.from(board.children).forEach(c => c.classList.remove('drawn'));
    }

    function broadcastNumber(game = 'current') {
      if (!db) return alert("Firebase not initialized.");
      const inputId = (game === 'current') ? 'currentNumberInput' : (game === 'next') ? 'nextNumberInput' : 'friendsNumberInput';
      const val = parseInt(document.getElementById(inputId).value);
      if (!val || val < 1 || val > 90) return alert('Enter number 1-90');
      const r = refFor(game);
      r.update({ liveNumber: val })
        .then(() => {
          r.child('history').transaction(hist => {
            const historyArr = hist || [];
            if (!historyArr.includes(val)) {
              historyArr.push(val);
            }
            return historyArr;
          });
        })
        .catch(e => alert('Error broadcasting number: ' + e.message));
    }

    function autoDrawNumber(game = 'current') {
      if (!db) return alert("Firebase not initialized.");
      clearInterval(autoTimers[game]);
      const r = refFor(game);
      autoTimers[game] = setInterval(() => {
        r.child('history').transaction(historyArr => {
          const hist = historyArr || [];
          const drawnNumbers = new Set(hist);
          const availableNumbers = Array.from({ length: 90 }, (_, i) => i + 1).filter(num => !drawnNumbers.has(num));
          if (availableNumbers.length > 0) {
            const num = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
            r.child('liveNumber').set(num);
            hist.push(num);
          } else {
            clearInterval(autoTimers[game]);
            alert("All numbers drawn! Auto-draw stopped.");
          }
          return hist;
        }).catch(e => console.error(`Error in auto-draw for ${game}:`, e));
      }, 30000);
      alert("Auto-draw started for " + game + " every 30 seconds.");
    }

    function generateBoard(game = 'current') {
      const boardId = (game === 'current') ? 'currentTambolaBoard' : (game === 'next') ? 'nextTambolaBoard' : 'friendsTambolaBoard';
      const board = document.getElementById(boardId);
      if (!board) return;
      board.innerHTML = '';
      for (let i = 1; i <= 90; i++) {
        const cell = document.createElement('div');
        cell.className = 'board-cell';
        cell.id = game + 'Cell' + i;
        cell.innerText = i;
        board.appendChild(cell);
      }
    }

    function highlightNumber(game, num) {
      const el = document.getElementById(game + 'Cell' + num);
      if (el) el.classList.add('drawn');
    }

    function updatePrize(game) {
      if (!db) return alert("Firebase not initialized.");
      const id = (game === 'current') ? 'currentPrizeInput' : (game === 'next') ? 'nextPrizeInput' : 'friendsPrizeInput';
      const v = parseInt(document.getElementById(id).value) || 0;
      if (v < 1 || v > 100) return alert('Enter % between 1-100');
      refFor(game).child('prizePercentage').set(v)
        .then(() => alert('Prize percentage updated for ' + game + ' ‚úÖ'))
        .catch(e => alert('Error updating prize percentage: ' + e.message));
    }

    function updateTickets(game) {
      if (!db) return alert("Firebase not initialized.");
      const id = (game === 'current') ? 'currentTicketsInput' : (game === 'next') ? 'nextTicketsInput' : 'friendsTicketsInput';
      const v = parseInt(document.getElementById(id).value) || 0;
      refFor(game).child('ticketsLeft').set(v)
        .then(() => alert('Tickets updated for ' + game + ' ‚úÖ'))
        .catch(e => alert('Error updating tickets: ' + e.message));
    }

    function updateSpots(game) {
      if (!db) return alert("Firebase not initialized.");
      const id = (game === 'current') ? 'currentSpotsInput' : (game === 'next') ? 'nextSpotsInput' : 'friendsSpotsInput';
      const v = parseInt(document.getElementById(id).value) || 0;
      refFor(game).child('totalSpots').set(v)
        .then(() => alert('Spots updated for ' + game + ' ‚úÖ'))
        .catch(e => alert('Error updating spots: ' + e.message));
    }

    function updateCountdown(key) {
      if (!db) return alert("Firebase not initialized.");
      const hours = parseInt(document.getElementById(key + 'CountdownInput_h').value) || 0;
      const minutes = parseInt(document.getElementById(key + 'CountdownInput_m').value) || 0;
      const seconds = parseInt(document.getElementById(key + 'CountdownInput_s').value) || 0;

      const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;

      if (totalSeconds < 5) {
        return alert('Countdown must be at least 5 seconds.');
      }
      startCountdown(key, totalSeconds);
    }

    function loadWinnersForm(game = 'current') {
      const formId = (game === 'current') ? 'currentWinnersForm' : (game === 'next') ? 'nextWinnersForm' : 'friendsWinnersForm';
      let html = '';
      for (let i = 1; i <= 10; i++) {
        html += `<div class="winner-card">
          <b>Winner #${i}</b><br>
          Name: <input id="${game}Name${i}" placeholder="Name"><br>
          Phone: <input id="${game}Phone${i}" placeholder="Phone"><br>
          Prize (‚Çπ): <input id="${game}Prize${i}" type="number"><br>
        </div>`;
      }
      document.getElementById(formId).innerHTML = html;
    }

    function saveAllWinners(game) {
      if (!db) return alert("Firebase not initialized.");
      const ref = refFor(game).child('winners');
      let payload = {};
      for (let i = 1; i <= 10; i++) {
        const name = document.getElementById(game + 'Name' + i).value.trim();
        const phone = document.getElementById(game + 'Phone' + i).value.trim();
        const prize = parseInt(document.getElementById(game + 'Prize' + i).value) || 0;
        if (!name || !phone) { alert('Enter Name & Phone for Winner #' + i); return; }
        payload['winner' + i] = { name, phone, prize };
      }
      ref.set(payload)
        .then(() => {
          alert('All winners saved for ' + game + ' ‚úÖ');
        })
        .catch(e => alert('Error saving winners: ' + e.message));
    }

    function sendNotification() {
      if (!db) return alert("Firebase not initialized.");
      const msg = (document.getElementById('notifyMessage') || {}).value || '';
      const to = (document.getElementById('notifyTo') || {}).value || '';
      const broadcast = document.getElementById('notifyBroadcast') && document.getElementById('notifyBroadcast').checked;
      if (!msg.trim()) return alert('Enter message');
      const payload = { message: msg.trim(), time: new Date().toISOString(), from: 'admin' };
      if (broadcast) {
        db.ref('notifications').push({ message: msg.trim(), time: firebase.database.ServerValue.TIMESTAMP })
          .then(() => {
            alert('Broadcast notification sent ‚úÖ');
            document.getElementById('notifyMessage').value = '';
            document.getElementById('notifyTo').value = '';
            if (document.getElementById('notifyBroadcast')) document.getElementById('notifyBroadcast').checked = false;
          })
          .catch(e => alert('Error sending broadcast notification: ' + e.message));
      } else if (to.trim()) {
        db.ref('userNotifications').child(to.trim()).push({ message: msg.trim(), time: firebase.database.ServerValue.TIMESTAMP })
          .then(() => {
            alert('Notification sent to ' + to.trim() + ' ‚úÖ');
            document.getElementById('notifyMessage').value = '';
            document.getElementById('notifyTo').value = '';
          })
          .catch(e => alert('Error sending notification: ' + e.message));
      } else {
        db.ref('notifications').push({ message: msg.trim(), time: firebase.database.ServerValue.TIMESTAMP })
          .then(() => {
            alert('Notification pushed to notifications (no target) ‚úÖ');
            document.getElementById('notifyMessage').value = '';
            document.getElementById('notifyTo').value = '';
          })
          .catch(e => alert('Error sending notification: ' + e.message));
      }
    }

    function fillRooms() {
      const select = document.getElementById('roomDropdown');
      if (!select) return;
      select.innerHTML = '';
      for (let i = 1; i <= 1000; i++) {
        const opt = document.createElement('option');
        opt.value = 'Room' + i;
        opt.innerText = 'Room ' + i;
        select.appendChild(opt);
      }
      select.value = selectedRoom;
    }

    function filterRooms() {
      const q = (document.getElementById('roomSearch') || {}).value.toLowerCase();
      const select = document.getElementById('roomDropdown');
      if (!select) return;
      Array.from(select.options).forEach(opt => {
        opt.style.display = opt.text.toLowerCase().includes(q) ? '' : 'none';
      });
    }

    function changeRoom() {
      if (!db) return alert("Firebase not initialized.");
      const sel = document.getElementById('roomDropdown').value || 'Room1';
      
      if (sel === selectedRoom) return;

      for (const key in listeners.friends) {
        if (listeners.friends[key]) {
          friendsGameRef.child(key).off('value', listeners.friends[key]);
        }
      }

      selectedRoom = sel;
      friendsGameRef = roomsRef.child(selectedRoom);
      alert('Now controlling ' + selectedRoom);
      generateBoard('friends');
      loadGameData('friends');
    }

    function approveClaim(id) {
      if (!db) return alert("Firebase not initialized.");
      // Using globalClaimsRef for approval as per new structure
      db.ref('claims/' + id).update({ status: 'approved', reviewedBy: 'admin', reviewedAt: new Date().toISOString() })
        .then(() => {
          db.ref('claims/' + id).once('value').then(snap => {
            const c = snap.val() || {};
            if (c.userId) {
              db.ref('userNotifications').child(c.userId).push({ 
                message: `Your claim for ${c.prize} has been approved`, 
                time: firebase.database.ServerValue.TIMESTAMP, 
                from: 'admin' 
              });
            }
            alert('Claim approved ‚úÖ');
          });
        })
        .catch(e => alert('Error approving claim: ' + e.message));
    }

    function rejectClaim(id) {
      if (!db) return alert("Firebase not initialized.");
      // Using globalClaimsRef for rejection as per new structure
      db.ref('claims/' + id).update({ status: 'rejected', reviewedBy: 'admin', reviewedAt: new Date().toISOString() })
        .then(() => {
          db.ref('claims/' + id).once('value').then(snap => {
            const c = snap.val() || {};
            if (c.userId) {
              db.ref('userNotifications').child(c.userId).push({ 
                message: `Your claim for ${c.prize} was rejected`, 
                time: firebase.database.ServerValue.TIMESTAMP, 
                from: 'admin' 
              });
            }
            alert('Claim rejected ‚ùå');
          });
        })
        .catch(e => alert('Error rejecting claim: ' + e.message));
    }

    function approveWithdraw(id) {
      if (!db) return alert("Firebase not initialized.");
      const wRef = db.ref('withdrawals/' + id);
      wRef.once('value').then(snap => {
        const w = snap.val() || {};
        wRef.update({ status: 'approved', reviewedBy: 'admin', reviewedAt: new Date().toISOString() })
          .then(() => {
            if (w.userId) {
              db.ref('userNotifications').child(w.userId).push({ 
                message: `Your withdrawal ‚Çπ${w.amount} approved`, 
                time: firebase.database.ServerValue.TIMESTAMP, 
                from: 'admin' 
              });
            }
            alert('Withdrawal approved ‚úÖ');
          })
          .catch(e => alert('Error approving withdrawal: ' + e.message));
      }).catch(e => alert('Error fetching withdrawal: ' + e.message));
    }

    function rejectWithdrawPrompt(id) {
      if (!db) return alert("Firebase not initialized.");
      const reason = prompt('Enter rejection reason (optional):', '');
      if (reason === null) return;
      rejectWithdraw(id, reason);
    }

    function rejectWithdraw(id, reason) {
      if (!db) return alert("Firebase not initialized.");
      const wRef = db.ref('withdrawals/' + id);
      wRef.once('value').then(snap => {
        const w = snap.val() || {};
        wRef.update({ status: 'rejected', reviewedBy: 'admin', reviewedAt: new Date().toISOString(), rejectionReason: reason || '' })
          .then(() => {
            if (w.userId) {
              db.ref('userNotifications').child(w.userId).push({ 
              message: `Your withdrawal ‚Çπ${w.amount} was rejected: ${reason || 'No reason'}`, 
                time: firebase.database.ServerValue.TIMESTAMP, 
                from: 'admin' 
              });
            }
            alert('Withdrawal rejected ‚ùå');
          })
          .catch(e => alert('Error rejecting withdrawal: ' + e.message));
      }).catch(e => alert('Error fetching withdrawal: ' + e.message));
    }

    function viewWithdraw(id) {
      if (!db) return alert("Firebase not initialized.");
      db.ref('withdrawals/' + id).once('value').then(snap => {
        const w = snap.val() || {};
        alert(`User: ${w.userId}\nAmount: ‚Çπ${w.amount}\nDestination: ${w.dest}\nStatus: ${w.status}\nRequested: ${new Date(w.time).toLocaleString() || ''}\nReason: ${w.rejectionReason || ''}`);
      }).catch(e => alert('Error viewing withdrawal: ' + e.message));
    }

    function renderPrizeInputs() {
      if (!db) {
        document.getElementById('prizeManagementContainer').innerHTML = '<div class="muted">Firebase not initialized. Prize management unavailable.</div>';
        return;
      }
      prizesRef.once('value').then(snap => {
        const prizes = snap.val() || {};
        const prizeNames = ['Early Five', 'Ticket Corner', 'Each Line', 'Full House', '2nd Full House'];
        const container = document.getElementById('prizeManagementContainer');
        let html = '';
        prizeNames.forEach(prize => {
          const currentAmount = prizes[prize] !== undefined ? prizes[prize] : '';
          html += `
            <div style="margin: 8px 0;">
              <label style="font-weight:bold;display:block;margin-bottom:4px;">${prize} Prize (‚Çπ)</label>
              <input type="number" id="prizeInput_${prize.replace(/\s/g, '_')}" value="${currentAmount}" placeholder="Enter amount" min="0" step="1">
            </div>
          `;
        });
        container.innerHTML = html;
        document.getElementById('prizeUpdateMessage').innerText = 'Prizes loaded successfully.';
      }).catch(e => {
        console.error('Error fetching prizes:', e);
        document.getElementById('prizeUpdateMessage').innerText = 'Error loading prizes: ' + e.message;
      });
    }

    function savePrizes() {
      if (!db) return alert("Firebase not initialized.");
      const prizeNames = ['Early Five', 'Ticket Corner', 'Each Line', 'Full House', '2nd Full House'];
      const updates = {};
      let hasValidInput = false;

      prizeNames.forEach(prize => {
        const input = document.getElementById(`prizeInput_${prize.replace(/\s/g, '_')}`);
        const value = input.value.trim();
        const amount = value ? parseInt(value) : null;

        if (value && (isNaN(amount) || amount < 0)) {
          alert(`Invalid amount for ${prize}. Please enter a non-negative number or leave empty.`);
          document.getElementById('prizeUpdateMessage').innerText = `Invalid amount for ${prize}.`;
          throw new Error(`Invalid amount for ${prize}`);
        }

        updates[prize] = amount !== null ? amount : null;
        if (amount !== null) hasValidInput = true;
      });

      if (!hasValidInput) {
        alert('Please set at least one prize amount.');
        document.getElementById('prizeUpdateMessage').innerText = 'Please set at least one prize amount.';
        return;
      }

      prizesRef.update(updates)
        .then(() => {
          document.getElementById('prizeUpdateMessage').innerText = 'Prizes updated successfully! ‚úÖ';
          setTimeout(() => {
            document.getElementById('prizeUpdateMessage').innerText = '';
          }, 3000);
        })
        .catch(e => {
          console.error('Error updating prizes:', e);
          document.getElementById('prizeUpdateMessage').innerText = `Error updating prizes: ${e.message}. Please check Firebase configuration and rules.`;
        });
    }

    function toggleClaimsView() {
      showAllClaims = !showAllClaims;
      const button = document.getElementById('toggleClaimsButton');
      button.innerText = showAllClaims ? 'Show Latest Claim' : 'View All Claims';
      renderClaims();
    }

    function renderClaims() {
      if (!db) {
        document.getElementById('claimsList').innerHTML = '<div class="muted">Firebase not initialized. Claims unavailable.</div>';
        return;
      }
      globalClaimsRef.once('value').then(snap => { // Using globalClaimsRef
        const data = snap.val() || {};
        const claims = Object.keys(data).map(id => ({
          id,
          ...data[id],
          time: data[id].time || 0
        }));
        let html = '';
        if (showAllClaims) {
          claims.forEach(c => {
            const status = c.status || 'pending';
            html += `<div class="claim-card">
              <div style="flex:1">
                <div><b>User:</b> ${escapeHtml(c.userName || c.userId || 'Unknown')}</div>
                <div class="muted"><b>Prize:</b> ${escapeHtml(c.prize || 'claim')}</div>
                <div class="muted"><b>Game:</b> ${escapeHtml(c.gameKey || 'N/A')}</div>
                <div class="muted"><b>Time:</b> ${escapeHtml(new Date(c.time).toLocaleString() || '')}</div>
                <div class="muted"><b>Status:</b> ${escapeHtml(status)}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button type="button" onclick="approveClaim('${c.id}')" ${status !== 'pending' ? 'disabled' : ''}>‚úÖ Approve</button>
                <button type="button" onclick="rejectClaim('${c.id}')" ${status !== 'pending' ? 'disabled' : ''}>‚ùå Reject</button>
              </div>
            </div>`;
          });
        } else {
          const latestClaim = claims.sort((a, b) => b.time - a.time)[0];
          if (latestClaim) {
            const status = latestClaim.status || 'pending';
            html = `<div class="claim-card">
              <div style="flex:1">
                <div><b>User:</b> ${escapeHtml(latestClaim.userName || latestClaim.userId || 'Unknown')}</div>
                <div class="muted"><b>Prize:</b> ${escapeHtml(latestClaim.prize || 'claim')}</div>
                <div class="muted"><b>Game:</b> ${escapeHtml(latestClaim.gameKey || 'N/A')}</div>
                <div class="muted"><b>Time:</b> ${escapeHtml(new Date(latestClaim.time).toLocaleString() || '')}</div>
                <div class="muted"><b>Status:</b> ${escapeHtml(status)}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button type="button" onclick="approveClaim('${latestClaim.id}')" ${status !== 'pending' ? 'disabled' : ''}>‚úÖ Approve</button>
                <button type="button" onclick="rejectClaim('${latestClaim.id}')" ${status !== 'pending' ? 'disabled' : ''}>‚ùå Reject</button>
              </div>
            </div>`;
          }
        }
        document.getElementById('claimsList').innerHTML = html || '<div class="muted">No claims yet</div>';
      }).catch(e => {
        console.error('Error fetching claims:', e);
        document.getElementById('claimsList').innerHTML = `<div class="muted">Error loading claims: ${e.message}</div>`;
      });
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"'`]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;' })[s]);
    }

    function bindGlobalListeners() {
      if (!db) {
        console.warn("Firebase not initialized. Skipping global listeners.");
        return;
      }
      musicRef.on("value", snap => {
        const data = snap.val() || {};
        const urlInput = document.getElementById("musicUrlInput");
        const tBtn = document.getElementById("toggleMusicBtn");
        if (urlInput) urlInput.value = data.url || "";
        if (tBtn) tBtn.innerText = data.isPlaying ? "‚è∏ Pause" : "‚ñ∂Ô∏è Play";
      });

      videoRef.on("value", snap => {
        const d = snap.val() || {};
        const urlInput = document.getElementById('videoUrlInput');
        const tBtn = document.getElementById('toggleVideoBtn');
        if (urlInput) urlInput.value = d.url || '';
        if (tBtn) tBtn.innerText = d.isPlaying ? '‚è∏ ‡§™‡•â‡§ú‡§º' : '‚ñ∂Ô∏è ‡§™‡•ç‡§≤‡•á';
      });

      sliderRef.on('value', snap => {
        const d = snap.val() || {};
        localSlides = Array.isArray(d.slides) ? JSON.parse(JSON.stringify(d.slides)) : [];
        renderSlidesTable();
        const tBtn = document.getElementById('toggleSliderBtn');
        if (tBtn) tBtn.innerText = d.isPlaying ? '‚è∏ Pause' : '‚ñ∂Ô∏è Play';
        const idxDisp = document.getElementById('currentIndexDisplay');
        if (idxDisp) idxDisp.innerText = (typeof d.currentIndex === 'number' ? d.currentIndex : 0);
        const spDisp = document.getElementById('speedDisplay');
        if (spDisp) spDisp.innerText = (d.speedMs || 0) + ' ms';
      });

      if (!listeners.globalClaims) {
        listeners.globalClaims = globalClaimsRef.on('value', () => { // Using globalClaimsRef
          renderClaims();
        });
      }

      if (!listeners.globalWithdrawals) {
        listeners.globalWithdrawals = db.ref('withdrawals').on('value', snap => {
          const data = snap.val() || {};
          let rows = '';
          // Ensure sorting by time/status is correct for better visibility
          const withdrawals = Object.keys(data).map(id => ({ id, ...data[id] }))
            .sort((a, b) => {
              if ((a.status || 'pending') === 'pending' && (b.status || 'pending') !== 'pending') return -1;
              if ((a.status || 'pending') !== 'pending' && (b.status || 'pending') === 'pending') return 1;
              return (b.time || 0) - (a.time || 0); // Latest first
            });

          withdrawals.forEach(w => {
            const status = w.status || 'pending';
            const requested = w.time ? new Date(w.time).toLocaleString() : '';
            rows += `<tr>
              <td><b>${escapeHtml(w.name || 'unknown')}</b><div class="muted">${escapeHtml(w.userId)}</div></td>
              <td>‚Çπ${escapeHtml(w.amount || 0)}</td>
              <td>${escapeHtml(w.dest || '--')}</td>
              <td>${escapeHtml(status)}</td>
              <td>${requested}</td>
              <td>
                ${status === 'pending' ? `<button onclick="approveWithdraw('${w.id}')" class="btn-ghost">Approve</button>
                <button onclick="rejectWithdrawPrompt('${w.id}')" class="btn-danger">Reject</button>` : `<button class="btn-ghost" onclick="viewWithdraw('${w.id}')">View</button>`}
              </td>
            </tr>`;
          });
          if (!rows) rows = '<tr><td colspan="6" class="muted">No withdrawal requests</td></tr>';
          document.getElementById('withdrawalsList').innerHTML = `<table class="table-small"><thead><tr><th>User</th><th>Amount</th><th>Destination</th><th>Status</th><th>Requested</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>`;
        });
      }

      if (!listeners.globalUsers) {
        listeners.globalUsers = db.ref('users').on('value', snap => {
          const data = snap.val() || {};
          let rows = '';
          Object.keys(data).forEach(uid => {
            const u = data[uid] || {};
            rows += `<tr>
              <td><b>${escapeHtml(uid)}</b><div class="muted">${escapeHtml(u.name || '')}</div></td>
              <td>‚Çπ${u.balance || 0}</td>
            </tr>`;
          });
          if (!rows) rows = '<tr><td colspan="2" class="muted">No users found</td></tr>';
          document.getElementById('usersTicketsList').innerHTML = `<table class="table-small"><thead><tr><th>User ID</th><th>Balance</th></tr></thead><tbody>${rows}</tbody></table>`;
        });
      }

      presenceRef.on('value', snap => {
        const count = snap.numChildren();
        document.getElementById('liveUserCountDisplay').textContent = count;
      });
      
      // LIVE TICKET SOLD COUNT LISTENER
      db.ref('userTickets').on('value', snap => {
        let totalCount = 0;
        if (snap.exists()) {
          snap.forEach(userNode => {
            userNode.forEach(ticketNode => {
                 totalCount++;
            });
          });
        }
        document.getElementById('totalTicketsSoldDisplay').textContent = totalCount;
      });
    }

    function loadGameData(game) {
      if (!db) {
        console.warn(`Firebase not initialized. Skipping game data load for ${game}.`);
        return;
      }
      const gameRef = refFor(game);

      for (const key in listeners[game]) {
        if (listeners[game][key]) {
            gameRef.child(key).off('value', listeners[game][key]);
        }
      }
      listeners[game] = {};

      const gameDataListener = gameRef.on('value', snap => {
        const data = snap.val() || {};
        
        updateStatusUI(game, data.status || 'idle');

        const prizeInputEl = document.getElementById(`${game}PrizeInput`);
        if (prizeInputEl) prizeInputEl.value = data.prizePercentage || 0;
        const prizeDisplayEl = document.getElementById(`${game}PrizeDisplay`);
        if (prizeDisplayEl) prizeDisplayEl.innerText = (data.prizePercentage || 0) + '%';
        
        const ticketsInputEl = document.getElementById(`${game}TicketsInput`);
        if (ticketsInputEl) ticketsInputEl.value = data.ticketsLeft || 0;
        const ticketsDisplayEl = document.getElementById(`${game}TicketsDisplay`);
        if (ticketsDisplayEl) ticketsDisplayEl.innerText = data.ticketsLeft || 0;

        const spotsInputEl = document.getElementById(`${game}SpotsInput`);
        if (spotsInputEl) spotsInputEl.value = data.totalSpots || 0;
        const spotsDisplayEl = document.getElementById(`${game}SpotsDisplay`);
        if (spotsDisplayEl) spotsDisplayEl.innerText = data.totalSpots || 0;
        
        const countdownDisplayEl = document.getElementById(`${game}CountdownDisplay`);
        const countdownValue = data.countdown || 0;
        if (countdownDisplayEl) {
          const h = Math.floor(countdownValue / 3600);
          const m = Math.floor((countdownValue % 3600) / 60);
          const s = countdownValue % 60;
          countdownDisplayEl.innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
      });
      listeners[game].gameData = gameDataListener;

      const winnersListener = gameRef.child('winners').on('value', snap => {
        const winners = snap.val() || {};
        for (let i = 1; i <= 10; i++) {
          const winner = winners[`winner${i}`] || {};
          const nameInput = document.getElementById(`${game}Name${i}`);
          const phoneInput = document.getElementById(`${game}Phone${i}`);
          const prizeInput = document.getElementById(`${game}Prize${i}`);
          if (nameInput) nameInput.value = winner.name || '';
          if (phoneInput) phoneInput.value = winner.phone || '';
          if (prizeInput) prizeInput.value = winner.prize || 0;
        }
      });
      listeners[game].winners = winnersListener;

      const claimsListId = `${game}ClaimsList`;
      const claimsList = document.getElementById(claimsListId);
      if (claimsList) {
        const claimsListener = gameRef.child('claims').on('value', snap => {
          const data = snap.val() || {};
          let html = '';
          Object.keys(data).forEach(id => {
            const c = data[id];
            const status = c.status || 'pending';
            html += `<div class="claim-card">
              <div style="flex:1">
                <div><b>User:</b> ${escapeHtml(c.userName || c.userId || 'Unknown')}</div>
                <div class="muted"><b>Prize:</b> ${escapeHtml(c.prize || 'claim')}</div>
                <div class="muted"><b>Game:</b> ${escapeHtml(game)}</div>
                <div class="muted"><b>Time:</b> ${escapeHtml(new Date(c.time).toLocaleString() || '')}</div>
                <div class="muted"><b>Status:</b> ${escapeHtml(status)}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button type="button" onclick="approveClaim('${id}')" ${status !== 'pending' ? 'disabled' : ''}>‚úÖ Approve</button>
                <button type="button" onclick="rejectClaim('${id}')" ${status !== 'pending' ? 'disabled' : ''}>‚ùå Reject</button>
              </div>
            </div>`;
          });
          claimsList.innerHTML = html || '<div class="muted">No claims for this game yet.</div>';
        });
        listeners[game].claims = claimsListener;
      }
      
      // TICKET LISTENER FOR VIEW ALL SOLD TICKETS
      const ticketsListId = `${game}TicketsList`;
      const ticketsList = document.getElementById(ticketsListId);
      if (ticketsList) {
        const ticketsListener = gameRef.child('tickets').on('value', snap => {
          const tickets = snap.val() || {};
          let html = '';
          if (Object.keys(tickets).length > 0) {
            Object.keys(tickets).forEach(userId => {
              const userTickets = tickets[userId];
              const validTickets = Object.values(userTickets || {}).filter(t => t && t.ticketId && Array.isArray(t.numbers));

              if (validTickets.length > 0) {
                  html += `<div style="margin-top:10px;"><b>User ID: ${escapeHtml(userId)} (${validTickets.length} tickets)</b></div>`;
                  validTickets.forEach(ticket => {
                    html += `<div style="border:1px solid #444; padding:8px; margin-top:5px; border-radius:6px;">`;
                    html += `Ticket ID: ${escapeHtml(ticket.ticketId)}<br>`;
                    html += `Numbers: ${escapeHtml(ticket.numbers.join(', '))}`;
                    html += `</div>`;
                  });
              }
            });
          }
          ticketsList.innerHTML = html || '<div class="muted">No tickets purchased for this game yet.</div>';
        });
        listeners[game].tickets = ticketsListener;
      }
      
      const historyListener = gameRef.child('history').on('value', snap => {
        const history = snap.val() || [];
        clearBoardHighlights(game);
        history.forEach(num => highlightNumber(game, num));
      });
      listeners[game].history = historyListener;
    }
    
    // Tab switching function
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("active");
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].classList.remove("active");
        }
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
        
        // Re-render claims/prizes if switching to the tab
        if (tabName === 'ClaimsWithdrawals') {
            renderClaims();
        } else if (tabName === 'GlobalSettings') {
            renderPrizeInputs();
        }
    }
    window.openTab = openTab; // Make it global for button clicks

    window.onload = function() {
      console.log("Window loaded, starting animation...");
      const loadingScreen = document.getElementById('loading-screen');
      const mainContent = document.getElementById('main-content');

      if (!loadingScreen || !mainContent) {
        console.error("Loading screen or main content not found.");
        alert("Error: Page elements missing. Check HTML structure.");
        if(mainContent) mainContent.style.display = 'block';
        document.body.style.overflow = 'auto';
        return;
      }

      // Show loading animation for 3.5 seconds, then transition to main content
      setTimeout(() => {
        console.log("Animation complete, transitioning to main content...");
        loadingScreen.classList.add('hidden');
        mainContent.classList.add('visible');
        document.body.style.overflow = 'auto';
        // Remove loading screen after transition
        setTimeout(() => {
          loadingScreen.style.display = 'none';
          console.log("Loading screen removed.");
        }, 500); // Match transition duration
      }, 3500); // Animation duration

      // Initialize app features
      try {
        ['current', 'next', 'friends'].forEach(g => {
          generateBoard(g);
          loadWinnersForm(g);
          loadGameData(g);
        });
        fillRooms();
        renderPrizeInputs();
        renderClaims();
        bindGlobalListeners();
        
        // Load the default winners form
        loadWinnersForm('current');
        
        console.log("App initialization completed.");
      } catch (e) {
        console.error("Error during app initialization:", e);
        // Note: The alert about Firebase initialization issue is already handled inside the try-catch block for Firebase setup.
      }
    };
    </script>
</body>
</html>
t>
</body>
</html>
