<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tambola 69 - Admin Panel</title>
<style>
  body { 
    font-family: Arial, Helvetica, sans-serif; 
    background: #111; 
    color: #fff; 
    text-align: center; 
    padding: 18px; 
    margin: 0; 
    overflow: hidden;
  }
  h1,h2,h3 { color: orange; margin: 10px 0; }
  .section { background: #222; padding: 14px; margin: 12px auto; max-width: 1000px; border-radius: 10px; text-align:left; }
  input, button, select, textarea { font-size: 15px; padding: 8px; margin: 6px 4px; border-radius: 6px; border: none; }
  button { background: orange; color: #000; cursor: pointer; font-weight: 700; }
  button:hover { background:#ff8800; }
  .action-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .live-box { background:#000; padding:8px 10px; border-radius:8px; display:inline-block; margin-left:8px; }
  .tambola-board, .ticket-board { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
  .board-cell, .ticket-cell { width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:#333; border-radius:6px; font-weight:bold; color:#fff; cursor:pointer; }
  .board-cell.drawn { background:#000; color:#ff0; }
  .winner-card { background:#000; padding:10px; margin:8px 0; border-radius:8px; }
  .claim-card { background:#1a1a1a; padding:10px; margin:8px 0; border-radius:8px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .room-select { background:#111; padding:8px; border-radius:8px; display:flex; gap:8px; align-items:center; }
  .small { font-size:13px; padding:6px; }
  textarea { width:100%; min-height:60px; border-radius:6px; }
  .muted { color:#bbb; font-size:13px; }
  .table-wrap{ overflow:auto; border-radius:8px; border:1px solid #333; }
  table { width:100%; border-collapse: collapse; }
  th, td { padding:8px; border-bottom:1px solid #333; vertical-align: top; text-align:left; }
  th { position: sticky; top:0; background:#1b1b1b; }
  .row-actions button{ margin:0 4px; padding:6px 8px; }
  .w-120{ width:120px; }
  .w-160{ width:160px; }
  .w-220{ width:220px; }
  .w-60{ width:60px; }
  .table-small{ width:100%; border-collapse:collapse; margin-top:8px }
  .table-small th, .table-small td { padding:8px; border-bottom:1px solid #333; font-size:14px; text-align:left }
  .btn-ghost{ background:transparent; border:1px solid #333; color:#fff; padding:6px 8px; border-radius:6px; cursor:pointer }
  .btn-danger{ background:#ff4d4f; color:#fff; padding:6px 8px; border-radius:6px; cursor:pointer; border:none }
  .btn-reset-claims { background: #337ab7; color: #fff; }
  .btn-reset-claims:hover { background: #286090; }
  .btn-clear-old { background: #8e44ad; color: #fff; }
  .btn-view-tickets { background: #27ae60; color: #fff; }
  .btn-game-over { background: #c0392b; color: #fff; }

  /* Loading Animation */
  #loading-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at center, #2a1a5e 0%, #0a0a2d 50%, #000 100%);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
    opacity: 1; transition: opacity 0.5s ease-out; overflow: hidden;
  }
  #loading-screen.hidden { opacity: 0; pointer-events: none; }
  #loading-screen::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: 
      radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 5px),
      radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 3px),
      radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 2px);
    background-size: 400px 400px, 200px 200px, 150px 150px;
    background-position: 0 0, 50px 50px, 100px 100px;
    animation: twinkle 4s infinite ease-in-out;
  }
  @keyframes twinkle { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  .welcome-text {
    font-size: 2.5rem; font-weight: bold; color: #fff;
    text-shadow: 0 0 15px #ff8800, 0 0 25px #ff8800, 0 0 35px #ff8800;
    animation: glow 2s ease-in-out infinite alternate, fadeIn 1.5s ease-in;
    text-align: center; padding: 0 20px; max-width: 90%;
  }
  #main-content { display: none; }
  #main-content.visible { display: block; }
  @keyframes glow {
    from { text-shadow: 0 0 15px #ff8800, 0 0 25px #ff8800, 0 0 35px #ff8800; }
    to { text-shadow: 0 0 25px #ff4500, 0 0 35px #ff4500, 0 0 45px #ff4500; }
  }
  @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
  @media (max-width: 600px) { .welcome-text { font-size: 1.6rem; } }
</style>
</head>
<body>
  <div id="loading-screen">
    <div class="welcome-text">Welcome to Your Own World Manas</div>
  </div>

  <div id="main-content">
    <h1>Tambola 69 - Admin Panel</h1>

    <!-- SLIDER CONTROL -->
    <div class="section">
      <h2>Slider Control</h2>
      <div class="action-row">
        <button onclick="toggleSliderPlay()" id="toggleSliderBtn">Play</button>
        <button onclick="prevSlide()">Previous</button>
        <button onclick="nextSlide()">Next</button>
        <button onclick="addSlideRow()">+ Add Slide</button>
      </div>
      <div class="action-row" style="margin-top:8px">
        <input type="number" id="gotoIndexInput" min="0" placeholder="Go to index">
        <button onclick="goToSlide()">Go</button>
        <div class="live-box">Current Index: <span id="currentIndexDisplay">0</span></div>
      </div>
      <div class="action-row" style="margin-top:8px">
        <input type="number" id="speedInput" min="500" placeholder="Speed (ms)">
        <button onclick="setSpeed()">Set Speed</button>
        <div class="live-box">Speed: <span id="speedDisplay">0 ms</span></div>
      </div>
      <div class="table-wrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Action</th>
              <th>Image URL</th>
              <th>Link URL</th>
              <th>Title</th>
              <th>Button</th>
              <th>Size (Optional)</th>
            </tr>
          </thead>
          <tbody id="slidesTbody"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
        <div class="muted">Total Slides: <span id="slidesCount">0</span></div>
        <button onclick="saveSlidesAdvanced()">Save All Slides to DB</button>
      </div>
    </div>

    <!-- MUSIC CONTROL -->
    <div class="section">
      <h2>Music Control</h2>
      <input type="text" id="musicUrlInput" placeholder="Enter music stream URL" style="width:70%">
      <button onclick="saveMusicUrl()">Save URL</button>
      <button id="toggleMusicBtn" onclick="toggleMusic()">Play</button>
      <div class="muted" style="margin-top:6px">Clients will auto-play if their local mute is off.</div>
    </div>

    <!-- VIDEO CONTROL -->
    <div class="section">
      <h2>वीडियो कंट्रोल</h2>
      <input type="text" id="videoUrlInput" placeholder="वीडियो स्ट्रीम URL डालें" style="width:70%">
      <button onclick="saveVideoUrl()">URL सेव करें</button>
      <button id="toggleVideoBtn" onclick="toggleVideo()">प्ले</button>
      <div class="muted" style="margin-top:6px">क्लाइंट्स वीडियो ऑटो-प्ले करेंगे अगर उनका म्यूट ऑफ है।</div>
    </div>

    <!-- NOTIFICATIONS -->
    <div class="section">
      <h2>Notifications</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="notifyTo" type="text" placeholder="User ID (leave empty for broadcast)" style="width:40%">
        <label style="display:flex;align-items:center;gap:6px;"><input id="notifyBroadcast" type="checkbox"> Broadcast to all</label>
      </div>
      <textarea id="notifyMessage" placeholder="Enter message for users..."></textarea>
      <div style="display:flex;gap:8px;">
        <button onclick="sendNotification()">Send Notification</button>
      </div>
    </div>

    <!-- PRIZE MANAGEMENT -->
    <div class="section">
      <h2>Prize Management</h2>
      <div id="prizeManagementContainer"></div>
      <button onclick="savePrizes()">Save Prizes</button>
      <div id="prizeUpdateMessage" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- CURRENT GAME -->
    <div class="section">
      <h2>Current Game</h2>
      <div class="action-row">
        <button onclick="startGame('current')">Start Game</button>
        <button onclick="stopGame('current')">Stop Game</button>
        <button onclick="resetGame('current')">Reset Game</button>
        <div class="live-box">Status: <span id="currentStatusDisplay">idle</span></div>
        <div class="live-box">Live Users: <span id="liveUserCountDisplay">0</span></div>
      </div>

      <!-- NEW BUTTONS -->
      <div class="action-row" style="margin-top:10px;">
        <button onclick="clearOldData('current')" class="btn-clear-old">
          Clear Old Data
        </button>
        <button onclick="viewAllSoldTickets()" class="btn-view-tickets">
          View All Sold Tickets
        </button>
        <button onclick="endGameWithFullHouse('current')" class="btn-game-over">
          Game Over (Full House)
        </button>
      </div>

      <!-- PRIZE, TICKETS, SPOTS, COUNTDOWN -->
      <div style="margin-top:8px">
        <input id="currentPrizeInput" type="number" min="1" max="100" placeholder="Prize %"><button onclick="updatePrize('current')">Update Prize</button>
        <div class="live-box">Prize: <span id="currentPrizeDisplay">0%</span></div>
      </div>
      <div style="margin-top:8px">
        <input id="currentTicketsInput" type="number" min="0" placeholder="Tickets Left"><button onclick="updateTickets('current')">Update Tickets</button>
        <div class="live-box">Tickets Left: <span id="currentTicketsDisplay">0</span></div>
      </div>
      <div style="margin-top:8px">
        <input id="currentSpotsInput" type="number" min="0" placeholder="Total Spots"><button onclick="updateSpots('current')">Update Spots</button>
        <div class="live-box">Total Spots: <span id="currentSpotsDisplay">0</span></div>
      </div>
      <div style="margin-top:8px">
        <label>Countdown (HH:MM:SS):</label>
        <input id="currentCountdownInput_h" type="number" min="0" placeholder="HH" class="small w-60">
        <input id="currentCountdownInput_m" type="number" min="0" max="59" placeholder="MM" class="small w-60">
        <input id="currentCountdownInput_s" type="number" min="0" max="59" placeholder="SS" class="small w-60">
        <button onclick="updateCountdown('current')">Update Countdown</button>
        <div class="live-box">Countdown: <span id="currentCountdownDisplay">00:00:00</span></div>
      </div>

      <!-- DRAW NUMBER -->
      <div class="action-row" style="margin-top:8px">
        <input id="currentNumberInput" type="number" min="1" max="90" placeholder="Draw Number">
        <button onclick="broadcastNumber('current')">Broadcast Number</button>
        <button onclick="autoDrawNumber('current')">Auto Draw Every 30s</button>
      </div>

      <h3>Tambola Board</h3>
      <div id="currentTambolaBoard" class="tambola-board"></div>

      <h3>Winners (Newest First)</h3>
      <div id="currentWinnersForm"></div>
      <button onclick="saveAllWinners('current')">Update All Winners</button>

      <h3>Claims</h3>
      <div id="currentClaimsList"></div>

      <h3>User Tickets</h3>
      <div id="currentTicketsList"></div>
    </div>

    <!-- NEXT GAME (COPY CURRENT) -->
    <div class="section">
      <h2>Next Game</h2>
      <div class="action-row">
        <button onclick="startGame('next')">Start Game</button>
        <button onclick="stopGame('next')">Stop Game</button>
        <button onclick="resetGame('next')">Reset Game</button>
        <div class="live-box">Status: <span id="nextStatusDisplay">idle</span></div>
      </div>
      <div class="action-row" style="margin-top:10px;">
        <button onclick="clearOldData('next')" class="btn-clear-old">Clear Old Data</button>
        <button onclick="viewAllSoldTickets()" class="btn-view-tickets">View All Sold Tickets</button>
        <button onclick="endGameWithFullHouse('next')" class="btn-game-over">Game Over</button>
      </div>
      <!-- Prize, Tickets, etc. (same as current) -->
      <div style="margin-top:8px">
        <input id="nextPrizeInput" type="number" min="1" max="100" placeholder="Prize %"><button onclick="updatePrize('next')">Update Prize</button>
        <div class="live-box">Prize: <span id="nextPrizeDisplay">0%</span></div>
      </div>
      <!-- ... rest same ... -->
      <div class="action-row" style="margin-top:8px">
        <input id="nextNumberInput" type="number" min="1" max="90" placeholder="Draw Number">
        <button onclick="broadcastNumber('next')">Broadcast Number</button>
        <button onclick="autoDrawNumber('next')">Auto Draw Every 30s</button>
      </div>
      <h3>Tambola Board</h3>
      <div id="nextTambolaBoard" class="tambola-board"></div>
      <h3>Winners (Newest First)</h3>
      <div id="nextWinnersForm"></div>
      <button onclick="saveAllWinners('next')">Update All Winners</button>
      <h3>Claims</h3>
      <div id="nextClaimsList"></div>
      <h3>User Tickets</h3>
      <div id="nextTicketsList"></div>
    </div>

    <!-- FRIENDS GAME (COPY) -->
    <div class="section">
      <h2>Play With Friends</h2>
      <div class="action-row">
        <button onclick="startGame('friends')">Start Game</button>
        <button onclick="stopGame('friends')">Stop Game</button>
        <button onclick="resetGame('friends')">Reset Game</button>
        <div class="live-box">Status: <span id="friendsStatusDisplay">idle</span></div>
      </div>
      <div class="action-row" style="margin-top:10px;">
        <button onclick="clearOldData('friends')" class="btn-clear-old">Clear Old Data</button>
        <button onclick="viewAllSoldTickets()" class="btn-view-tickets">View All Sold Tickets</button>
        <button onclick="endGameWithFullHouse('friends')" class="btn-game-over">Game Over</button>
      </div>
      <div class="room-select" style="margin-top:10px">
        <input type="text" id="roomSearch" onkeyup="filterRooms()" placeholder="Search Room...">
        <select id="roomDropdown" onchange="changeRoom()"></select>
      </div>
      <!-- ... rest same ... -->
      <div class="action-row" style="margin-top:8px">
        <input id="friendsNumberInput" type="number" min="1" max="90" placeholder="Draw Number">
        <button onclick="broadcastNumber('friends')">Broadcast Number</button>
        <button onclick="autoDrawNumber('friends')">Auto Draw Every 30s</button>
      </div>
      <h3>Tambola Board</h3>
      <div id="friendsTambolaBoard" class="tambola-board"></div>
      <h3>Winners (Newest First)</h3>
      <div id="friendsWinnersForm"></div>
      <button onclick="saveAllWinners('friends')">Update All Winners</button>
      <h3>Claims</h3>
      <div id="friendsClaimsList"></div>
      <h3>User Tickets</h3>
      <div id="friendsTicketsList"></div>
    </div>

    <!-- WITHDRAWALS, USERS, CLAIMS, QUICK ADMIN -->
    <div class="section">
      <h2>Withdrawal Requests</h2>
      <div class="table-wrap"><div id="withdrawalsList" class="muted">Loading withdrawals...</div></div>
    </div>

    <div class="section">
      <h2>Users & Balance</h2>
      <div id="usersTicketsList" class="muted">Loading users & tickets...</div>
    </div>

    <div class="section">
      <h2>Claims</h2>
      <button id="toggleClaimsButton" onclick="toggleClaimsView()">View All Claims</button>
      <div id="claimsList" class="muted">Loading claims...</div>
    </div>

    <div class="section">
      <h2>Quick Admin</h2>
      <div class="action-row">
        <div class="live-box">Total Tickets Sold: <span id="totalTicketsSoldDisplay">0</span></div>
        <button onclick="endAllGamesAndResetTickets()" style="background:#ff4d4f;">Game Over & Reset Tickets</button>
        <button onclick="startNewGameForAll()" style="background:#32CD32;">Start New Game</button>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// === YOUR FIREBASE CONFIG ===
const firebaseConfig = {
apiKey: "AIzaSyAphHTM4faH7_FVXdnootp4NipZd3vtEck",
  authDomain: "tambola69-9dc8f.firebaseapp.com",
  databaseURL: "https://tambola69-9dc8f-default-rtdb.firebaseio.com",
  projectId: "tambola69-9dc8f",
  storageBucket: "tambola69-9dc8f.firebasestorage.app",
  messagingSenderId: "413290158586",
  appId: "1:413290158586:web:c4c6d6d224c96a7487ec43",
  measurementId: "G-TM68JPXH18"
};

let db;
try {
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch (e) { console.error(e); alert("Firebase failed."); }

const currentGameRef = db?.ref('currentGame');
const nextGameRef = db?.ref('nextGame');
const presenceRef = db?.ref('presence');
const roomsRef = db?.ref('rooms');
let selectedRoom = "Room1";
let friendsGameRef = roomsRef?.child(selectedRoom);
const musicRef = db?.ref("music");
const videoRef = db?.ref("video");
const sliderRef = db?.ref('slider');
const prizesRef = db?.ref('prizes');
const userTicketsRef = db?.ref('userTickets');
const globalClaimsRef = db?.ref('claims');
let localSlides = [];
const autoTimers = { current: null, next: null, friends: null };
let countdownIntervals = { current: null, next: null, friends: null };
const listeners = { current: {}, next: {}, friends: {}, globalClaims: null, globalWithdrawals: null, globalUsers: null };
let showAllClaims = false;

function refFor(key) {
  if (key === 'current') return currentGameRef;
  if (key === 'next') return nextGameRef;
  if (key === 'friends') return friendsGameRef;
  return null;
}

// === 1. CLEAR OLD DATA ===
function clearOldData(game) {
  if (!confirm(`Clear ALL old data for ${game.toUpperCase()}?`)) return;
  const gameRef = refFor(game);
  Promise.all([
    gameRef.update({ claims: null, tickets: null, winners: null, history: null, liveNumber: null }),
    globalClaimsRef.remove(),
    db.ref('notifications').push({ message: `New ${game} round! Book fresh tickets!`, time: firebase.database.ServerValue.TIMESTAMP })
  ]).then(() => {
    alert(`${game} cleared! New tickets = fresh claims.`);
    generateBoard(game);
  });
}

// === 2. VIEW ALL SOLD TICKETS ===
function viewAllSoldTickets() {
  userTicketsRef.once('value').then(snap => {
    const data = snap.val() || {};
    let html = '<table style="width:100%;border-collapse:collapse;"><tr><th>User</th><th>Game</th><th>Ticket ID</th><th>Numbers</th></tr>';
    Object.keys(data).forEach(u => Object.keys(data[u]).forEach(g => Object.values(data[u][g]).forEach(t => {
      html += `<tr><td>${escapeHtml(u)}</td><td>${escapeHtml(g)}</td><td>${escapeHtml(t.ticketId)}</td><td>${escapeHtml(t.numbers.join(', '))}</td></tr>`;
    })));
    html += '</table>';
    const win = window.open('', '_blank');
    win.document.write(`<pre style="font-family:monospace;background:#000;color:#0f0;padding:20px;">${html}</pre>`);
  });
}

// === 3. WINNERS: NEWEST ON TOP ===
function saveAllWinners(game) {
  const ref = refFor(game).child('winners');
  let payload = {};
  for (let i = 1; i <= 10; i++) {
    const name = document.getElementById(game + 'Name' + i).value.trim();
    const phone = document.getElementById(game + 'Phone' + i).value.trim();
    const prize = parseInt(document.getElementById(game + 'Prize' + i).value) || 0;
    if (name && phone) payload['winner' + i] = { name, phone, prize, time: firebase.database.ServerValue.TIMESTAMP };
  }
  ref.set(payload).then(() => alert('Winners saved!'));
}

// === 4. GAME OVER AFTER FULL HOUSE ===
function endGameWithFullHouse(game) {
  if (!confirm(`End ${game} with Full House?`)) return;
  const r = refFor(game);
  r.update({ status: 'gameOver', liveNumber: null }).then(() => {
    clearInterval(autoTimers[game]);
    alert("Full House! Game Over.");
  });
}

// === ALL OTHER FUNCTIONS (startGame, stopGame, etc.) ===
// ... (your full existing functions from previous code) ...

window.onload = function() {
  setTimeout(() => {
    document.getElementById('loading-screen').classList.add('hidden');
    document.getElementById('main-content').classList.add('visible');
    document.body.style.overflow = 'auto';
    setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);
  }, 3500);

  ['current', 'next', 'friends'].forEach(g => {
    generateBoard(g);
    loadWinnersForm(g);
    loadGameData(g);
  });
  fillRooms();
  renderPrizeInputs();
  renderClaims();
  bindGlobalListeners();
};
</script>
</body>
</html>
