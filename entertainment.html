<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola 69</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111111"/>
    <script>
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/service-worker.js')
            .then(() => console.log('Service Worker Registered'))
            .catch(error => console.log('Service Worker registration failed:', error));
        }
    </script>
    <style>
        /* ==================== Initial Loading/Login Page Styles ==================== */
        .initial-bg {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            margin: 0;
            color: #ffffff;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
        }
        .initial-container {
            width: 90vw;
            max-width: 650px;
            height: 450px;
            position: relative;
            perspective: 1200px;
        }
        .ticket {
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            padding: 30px;
            box-sizing: border-box;
            border: 3px dashed #3498db;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            transform-style: preserve-3d;
            transition: transform 0.6s ease, box-shadow 0.6s ease;
        }
        .ticket:hover {
            transform: translate(-50%, -50%) rotateY(20deg) rotateX(15deg) scale(1.08);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        .header {
            width: 100%;
            text-align: center;
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: linear-gradient(to right, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .spinner-container {
            position: relative;
            z-index: 10;
            width: 140px;
            height: 140px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 6px solid #3498db;
            border-top-color: #e74c3c;
            border-bottom-color: #f1c40f;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner-number {
            position: absolute;
            font-size: 2.5em;
            font-weight: 800;
            color: #e74c3c;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .final-number-spot {
            width: 170px;
            height: 170px;
            border: 5px dashed #2ecc71;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
        }
        .final-number {
            font-size: 5em;
            color: #2ecc71;
            font-weight: 900;
            opacity: 0;
            transform: translateY(-30px) scale(0);
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        }
        .footer {
            color: #34495e;
            font-size: 1.2em;
            font-weight: 500;
            text-align: center;
        }
        .login-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            padding: 40px;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            text-align: center;
            opacity: 0;
            display: none;
            backdrop-filter: blur(10px);
        }
        .login-box h2 {
            margin-bottom: 30px;
            color: #ecf0f1;
            font-size: 1.8em;
            font-weight: 600;
        }
        .login-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .google-btn {
            background: linear-gradient(to right, #db4437, #e57373);
            color: white;
        }
        .facebook-btn {
            background: linear-gradient(to right, #4267B2, #597ac7);
            color: white;
        }
        .login-button img {
            width: 24px;
            height: 24px;
            margin-right: 12px;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: hsl(0, 100%, 50%);
            z-index: 100;
        }
        @media (max-width: 500px) {
            .ticket { height: 350px; }
            .header { font-size: 1.5em; }
            .spinner-container { width: 100px; height: 100px; }
            .spinner { width: 80px; height: 80px; }
            .spinner-number { font-size: 2em; }
            .final-number-spot { width: 120px; height: 120px; }
            .final-number { font-size: 3.5em; }
            .login-box { width: 300px; padding: 20px; }
        }
        
        /* ==================== Main App UI Styles ==================== */
        body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; color:#222; text-align:center; }
        .main-app-ui { display: none; }
        header { padding:20px; font-size:3em; font-weight:900; color:#ff5722; text-shadow:2px 2px 3px #000; }
        h2 { font-size:2em; color:#2196f3; margin:10px 0; text-shadow:1px 1px 2px #555; }
        .live-number{font-size:32px; color:green; font-weight:800; margin:10px;}
        .viewer-count{font-size:18px; margin:5px;}
        .prize-box{max-width:680px;margin:10px auto;padding:15px;border-radius:12px;background:linear-gradient(135deg,#2b86c5,#784ba0,#ff3cac);color:#fff;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.3);text-align:left;}
        .prize-box span{display:block;margin:4px 0;font-size:16px;}
        .user-ticket{max-width:680px;margin:10px auto;display:none;}
        .ticket-shell{border:3px solid #111;border-radius:12px;display:inline-block;padding:10px;position:relative;background:#fff;}
        .ticket-serial{position:absolute;top:-16px;left:50%;transform:translateX(-50%);background:#fff;padding:4px 8px;border-radius:999px;border:1px solid #111;font-weight:800;}
        .ticket{display:grid;grid-template-columns:repeat(9,1fr);gap:6px;}
        .ticket-cell{padding:10px;border-radius:6px;font-weight:700;cursor:pointer;user-select:none;border:1px solid #333;position:relative;transition:0.2s;background:#fff;}
        .ticket-cell.empty{background:transparent;border-style:dashed;cursor:default;color:transparent;}
        .ticket-cell.ticked::after{content:"‚úì";position:absolute;top:2px;right:2px;background:green;color:#fff;padding:1px 3px;border-radius:50%;font-weight:900;font-size:10px;pointer-events:none;box-shadow:0 0 2px rgba(0,0,0,0.4);}
        .ticket-cell.buggy{box-shadow:inset 0 0 0 3px rgba(255,0,0,0.12); background:linear-gradient(90deg, rgba(255,200,200,0.4), rgba(255,230,230,0.2));}
        .claim-buttons{margin:10px;}
        .claim-button{background:green;color:#fff;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;margin:4px;font-weight:700;}
        .claimed-box, .winners-box, .next-game-box, .play-friends-box, .history-box{max-width:500px;margin:8px auto;padding:12px;border-radius:12px;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
        .claimed-line{color:red;font-weight:700;}
        .book-ticket, .join-game-button{background:#ff6600;color:#fff;padding:10px 20px;border:none;border-radius:8px;margin:10px;cursor:pointer;font-weight:700;}
        .book-ticket:hover, .join-game-button:hover{background:#e55b00;}
        .next-game-box h3, .play-friends-box h3, .claimed-box h3, .winners-box h3, .history-box h3{margin-bottom:8px;}
        .next-game-info, .friends-info{display:flex;justify-content:space-around;font-weight:700;flex-wrap:wrap;gap:8px;}
        .board{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;max-width:600px;margin:10px auto;}
        .board-cell{padding:8px;border-radius:6px;font-weight:700;background:#ddd;transition:0.3s;}
        .board-cell.black{background:#000;color:#fff;}
        .board-cell.highlight{background:orange !important;}
        .menu{position:fixed;top:12px;right:12px;z-index:9999;}
        .hamburger{width:42px;height:34px;border-radius:10px;border:2px solid #111;background:#fff;display:flex;flex-direction:column;justify-content:space-around;padding:6px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);}
        .hamburger span{height:3px;border-radius:2px;background:#111;}
        .menu-panel{position:fixed;top:56px;right:12px;width:320px;background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px;box-shadow:0 8px 16px rgba(0,0,0,0.15);display:none;text-align:left;}
        .menu-panel.show{display:block;}
        .menu-panel h4{margin:4px 0 8px;font-size:18px;}
        .menu-row{margin:8px 0;padding:8px;border:1px dashed #ccc;border-radius:10px;}
        .menu-row strong{font-size:16px;}
        .menu-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
        .menu-btn{background:#111;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700;}
        .menu-btn.secondary{background:#444;}
        .menu-note{font-size:12px;color:#555;margin-top:6px;}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff;color:#000;font-weight:700;font-size:12px;margin-left:6px;}
        .muted{opacity:0.85;font-weight:600;}
        .row{display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center;}
        input[type="text"], input[type="tel"], input[type="email"], input[type="number"]{ padding:8px 10px;border:1px solid #ccc;border-radius:8px;min-width:180px;}
        .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:10000;}
        .modal{background:#fff; width:92%; max-width:420px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.3); padding:16px; text-align:left;}
        .modal h3{margin:0 0 8px;}
        .modal label{font-size:14px;font-weight:700;display:block;margin-top:8px;}
        .modal input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-top:6px;}
        .modal .row{display:flex;gap:8px;margin-top:10px;}
        .modal .btn{background:#ff6600;color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;}
        .modal .btn.secondary{background:#555;}
        .modal .note{font-size:12px;color:#666;margin-top:6px;}
        .waiting-wrapper{max-width:720px;margin:18px auto;position:relative;}
        .waiting-box{
            background: linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
            border-radius:16px;
            padding:18px 18px 36px 18px;
            box-shadow: 0 12px 30px rgba(20,30,60,0.12);
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(6px) saturate(120%);
            -webkit-backdrop-filter: blur(6px) saturate(120%);
            text-align:center;
            position:relative;
        }
        .waiting-title{font-size:20px;font-weight:900;color:#222;margin:0;}
        .waiting-desc{margin-top:6px;color:#444;font-weight:700;}
        .waiting-latest{margin-top:12px;font-size:28px;font-weight:900;color:#1b5e20;}
        .waiting-live-pill{
            position:absolute;
            left:14px;
            bottom:12px;
            background:linear-gradient(90deg,#0d47a1,#1976d2);
            color:#fff;
            padding:8px 12px;
            border-radius:10px;
            font-weight:900;
            box-shadow:0 6px 18px rgba(25,118,210,0.18);
            display:flex;
            gap:8px;
            align-items:center;
        }
        .waiting-live-pill .dot{width:10px;height:10px;border-radius:50%;background:#00e676;box-shadow:0 0 6px rgba(0,230,118,0.6)}
        @media(max-width:700px){
            .waiting-wrapper{padding:0 12px;}
            .waiting-latest{font-size:20px;}
        }
        .winner-x { color:#ffeb3b; font-weight:900; margin-right:6px; }
        .winner-row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:6px 0; }
        .horiz-prizes {
            max-width: 680px;
            margin: 10px auto;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, #1b5e20, #388e3c, #4caf50);
            color: #fff;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .horiz-prizes h3 {
            margin: 0 0 10px;
        }
        .prize-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        .prize-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .prize-item .prize-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .prize-item .prize-amount {
            font-size: 16px;
            font-weight: 900;
            color: #ffeb3b;
        }
        .view-all-button {
            margin-top: 15px;
            padding: 8px 15px;
            background: #ffc107;
            color: #111;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .game-details-box {
            background-color: #212121;
            color: white;
            padding: 15px;
            margin: 10px auto;
            max-width: 680px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            text-align: left;
        }
        .game-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .game-info-item {
            background-color: #424242;
            padding: 8px;
            border-radius: 6px;
        }
        .claimed-button-text {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            text-decoration: line-through;
        }
        /* Updated Tambola Board Styling */
        .tambola-board-container {
            max-width: 500px;
            margin: 10px auto;
            padding: 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, #1b5e20, #388e3c, #4caf50);
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .tambola-board-container h3 {
            text-align: center;
            margin-bottom: 10px;
        }
        .tambola-board-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 6px;
        }
        .tambola-board-cell {
            padding: 12px 0;
            font-weight: 900;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .tambola-board-cell.drawn {
            background: #000;
            color: #fff;
            border-color: #000;
            box-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div class="initial-bg" id="initialScreen">
        <div class="initial-container">
            <div class="ticket">
                <div class="header">Tambola Extravaganza</div>
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <div class="spinner-number">0</div>
                </div>
                <div class="final-number-spot">
                    <div class="final-number">69</div>
                </div>
                <div class="footer">Join the Fun!</div>
            </div>
        </div>
    
        <div class="login-box" id="socialLoginBox">
            <h2>Login to Play</h2>
            <button class="login-button google-btn">
                <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Google">
                Sign in with Google
            </button>
            <button class="login-button facebook-btn">
                <img src="https://img.icons8.com/color/48/000000/facebook-new.png" alt="Facebook">
                Sign in with Facebook
            </button>
        </div>
    </div>

    <div class="main-app-ui" id="mainAppUI">
        <button id="musicBtn" style="position:fixed; top:12px; left:12px; font-size:22px; z-index:10000; background:#fff; color:#111; border:2px solid #111; border-radius:10px; padding:6px 10px; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.15);">üéµ</button>
        <audio id="liveMusic" autoplay loop></audio>
        
        <header>Tambola 69</header>
        <h2>Step Into The Excitement!</h2>
        <h4>‚ÄúWe hope luck is always on your side!‚Äù üéâ</h4>
        
        <div class="menu">
            <div class="hamburger" id="menuToggle" aria-label="Options"><span></span><span></span><span></span></div>
        </div>
        <div class="menu-panel" id="menuPanel">
            <h4>Options</h4>
            <div class="menu-row">
                <strong>üèÜ Your Winnings: ‚Çπ<span id="myWinnings">0</span></strong>
                <div class="menu-note">If you haven't won yet, this shows ‚Çπ0.</div>
            </div>
            <div class="menu-row">
                <strong>üí∏ Cash Withdrawal</strong>
                <div class="menu-actions">
                    <button class="menu-btn" id="withdrawBtn">Withdraw Now</button>
                    <button class="menu-btn secondary" id="sendUPIBtn">Send UPI/Phone</button>
                </div>
                <div class="menu-note">Enter amount and your UPI or phone. We‚Äôll receive your request instantly.</div>
            </div>
            <div class="menu-row">
                <strong>üì£ Share App</strong>
                <div class="menu-actions">
                    <button class="menu-btn" id="shareNative">Share</button>
                    <button class="menu-btn secondary" id="shareWhatsApp">WhatsApp</button>
                    <button class="menu-btn secondary" id="shareFacebook">Facebook</button>
                    <button class="menu-btn secondary" id="shareInstagram">Instagram</button>
                </div>
                <div class="menu-note">Invite friends via your favourite app.</div>
            </div>
            <div class="menu-row">
                <strong>üë§ User Profile</strong>
                <div class="menu-actions">
                    <button class="menu-btn" id="viewProfileBtn">View Profile</button>
                </div>
                <div class="menu-note">See your User ID, Name, Contact & Email.</div>
            </div>
            <div class="menu-row">
                <strong>‚öôÔ∏è Auto Options</strong>
                <div class="menu-actions">
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="autoTickToggle" /> Auto-Tick
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;">
                        <input type="checkbox" id="autoClaimToggle" /> Auto-Claim
                    </label>
                </div>
                <div class="menu-note">Auto-Tick marks numbers on your ticket as they are drawn. Auto-Claim will submit valid claims automatically.</div>
            </div>
            <div class="menu-row">
                <strong>üìú My History</strong>
                <div class="menu-actions">
                    <button class="menu-btn" id="viewHistoryBtn">Game & Payment</button>
                </div>
                <div class="menu-note">View your past game and withdrawal history.</div>
            </div>
            <div class="menu-row">
                <strong>‚ÑπÔ∏è Information</strong>
                <div class="menu-actions">
                    <button class="menu-btn" onclick="showStaticPage('about')">About Us</button>
                    <button class="menu-btn secondary" onclick="showStaticPage('terms')">Terms & Conditions</button>
                    <button class="menu-btn secondary" onclick="showStaticPage('privacy')">Privacy Policy</button>
                </div>
                <div class="menu-note">Read about the app, its terms, and privacy policies.</div>
            </div>
        </div>
        
        <div class="prize-box">
            <h2> Mega contest <h2/>
            <span>Prize list :-</span>
            <span>* Early Five Prize: ‚Çπ 500</span>
            <span>* Ticket Corner Prize: ‚Çπ 500</span>
            <span>* Each Line Prize: ‚Çπ 500</span>
            <span>* Full House Prize: ‚Çπ 3000</span>
            <span># 2nd Full House Prize ‚Çπ 1000</span>
            <span># Try Your Luck !</span>
        </div>
        
        <div class="claimed-box" id="watchLiveBox" style="max-width:600px;margin:10px auto;padding:12px;border-radius:12px;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.1); background: #222;">
            <h3 style="margin-bottom:8px;">üé• Watch Live</h3>
            <div style="text-align:center;">
                <button id="watchLiveBtn" style="padding:10px 20px; font-size:16px; background:#ff4444; color:#fff; border:none; border-radius:8px; cursor:pointer;">
                    ‚ñ∂Ô∏è Watch Live
                </button>
                <div id="liveVideoBox" style="margin-top:15px; display:none;">
                    <iframe id="liveFrame" width="100%" height="300" src="" title="Tambola 69 Live" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
            <div style="margin-top:8px; font-size:12px; opacity:0.9;">Tip: Tap "Watch Live" to start the stream inside the app.</div>
        </div>
        
        <div class="waiting-wrapper">
            <div class="waiting-box" id="waitingBox">
                <div class="waiting-title" id="waitingTitle">Waiting for Draw...</div>
                <div class="waiting-desc" id="waitingDesc">No active room ‚Ä¢ Global draw idle</div>
                <div class="waiting-latest" id="latestNumber">‚Äî</div>
                <div class="waiting-live-pill" id="waitingLive">
                    <div class="dot" id="liveDot"></div>
                    <div id="waitingLiveText">Live Users: 0</div>
                </div>
            </div>
        </div>
        
        <div class="next-game-box" id="nextGameBoxTop">
            <h3>Game Starts In ‚è≥</h3>
            <div class="next-game-info">
                <div><span id="nextCountdownTop">00:00:00</span><br>Timer</div>
                <div><span id="ticketsLeftTop">0</span><br>Tickets Left</div>
                <div><span id="prizePercentageTop">0%</span><br>Prize %</div>
                <div><span id="TotalSpotTop">100</span><br>Total Spot</div>
            </div>
            <button class="book-ticket" id="buyTicketBtnTop">Buy ‚Çπ 100 üí≥</button>
        </div>
        
        <div class="user-ticket" id="userTicketContainer">
            <div class="ticket-shell" id="ticketShell">
                <div id="ticketSerial" class="ticket-serial">#000</div>
                <div id="ticket" class="ticket"></div>
            </div>
        </div>
        
        <div class="claimed-box" id="claimBox">
            <h3>Claim Your Prize üéÅ</h3>
            <div class="claim-buttons">
                <button class="claim-button" data-prize="Early Five">Early Five ‚Çπ500</button>
                <button class="claim-button" data-prize="Top Line">Top Line ‚Çπ500</button>
                <button class="claim-button" data-prize="Middle Line">Middle Line ‚Çπ500</button>
                <button class="claim-button" data-prize="Bottom Line">Bottom Line ‚Çπ500</button>
                <button class="claim-button" data-prize="Ticket Corner">Ticket Corner ‚Çπ500</button>
                <button class="claim-button" data-prize="Full House">Full House ‚Çπ3000</button>
                <button class="claim-button" data-prize="2nd Full House">2nd Full House ‚Çπ1000</button>
            </div>
        </div>
        <div class="tambola-board-container">
            <h3>Tambola Board</h3>
            <div class="tambola-board-grid" id="tambola-board"></div>
        </div>
        
        <div class="history-box" id="historyBox">
            <h3>Drawn Numbers History</h3>
            <div id="history">None</div>
        </div>
        
        <div class="next-game-box" id="nextGameBoxBottom">
            <h3>Next Game Starts In ‚è≥</h3>
            <div class="next-game-info">
                <div><span id="nextCountdownBottom">00:00:00</span><br>Timer</div>
                <div><span id="ticketsLeftBottom">0</span><br>Tickets Left</div>
                <div><span id="prizePercentageBottom">0%</span><br>Prize %</div>
                <div><span id="TotalSpotBottum">100</span><br>Total Spot</div>
            </div>
            <button class="book-ticket" id="buyTicketBtnBottom">Buy ‚Çπ 100 üí≥</button>
        </div>
        
        <div class="play-friends-box" id="playFriendsBox">
            <h3>Play With Friends üéÆ <span class="pill" id="roomStatusPill">No Room</span></h3>
            <div class="friends-info">
                <span id="friendsPrizePercentage">Prize %: 0</span>
            </div>
            <div class="row" style="margin-top:8px;">
                <button class="book-ticket" id="createRoomBtn">Create Room</button>
                <button class="join-game-button" id="joinRoomBtn">Join Room</button>
                <input type="text" id="joinRoomIdInput" placeholder="Enter Room ID" />
            </div>
            <div id="roomInfo" style="margin-top:10px;color:#fff;"></div>
            <div class="row" style="margin-top:10px;">
                <button class="book-ticket" id="roomBuyTicketBtn" style="display:none;">Buy Ticket ‚Çπ 100</button>
                <button class="join-game-button" id="startRoomGameBtn" style="display:none;" disabled>Start Game</button>
            </div>
            <div id="playersList" class="muted" style="margin-top:10px;"></div>
        </div>
        
        <div class="winners-box" id="winnersBox">
            <h3>Top Winners üèÜ</h3>
            <div id="winnerList">Loading winners...</div>
        </div>
        
        <div class="game-details-box" id="userGamesContainer">
            <h3>My Booked Tickets</h3>
            <button id="viewTicketsBtn" class="view-all-button" style="margin-top:8px;">View All Booked Tickets</button>
            <div id="userGamesList" style="display:none;">
                No booked tickets yet.
            </div>
        </div>
        
        <div class="modal-backdrop" id="withdrawModal" style="display:none;">
            <div class="modal">
                <h3>Request Withdrawal</h3>
                <label>Amount (‚Çπ)</label>
                <input id="withdrawAmount" type="number" placeholder="Enter amount" />
                <label>UPI ID or Phone</label>
                <input id="withdrawDest" type="text" placeholder="example@upi or +91XXXXXXXXXX" />
                <div class="row" style="justify-content:flex-end;">
                    <button class="btn secondary" id="cancelWithdrawBtn">Cancel</button>
                    <button class="btn" id="submitWithdrawBtn">Submit Request</button>
                </div>
                <div class="note">Withdrawal requests will be recorded and admin will be notified (email/SMS) via your server/cloud-function.</div>
            </div>
        </div>
        
        <div class="modal-backdrop" id="loginModal">
            <div class="modal">
                <h3>Login with Phone OTP</h3>
                <label>Phone Number (include +91)</label>
                <input id="phoneInput" type="tel" placeholder="+91XXXXXXXXXX" />
                <div id="recaptcha-container" style="margin-top:10px;"></div>
                <div class="row">
                    <button class="btn" id="sendOtpBtn">Send OTP</button>
                    <button class="btn secondary" id="closeLoginBtn" type="button">Close</button>
                </div>
                <label>Enter OTP</label>
                <input id="otpInput" type="text" placeholder="6-digit code" />
                <button class="btn" id="verifyOtpBtn" style="margin-top:8px;">Verify OTP</button>
                <div id="detailsStep" style="display:none; margin-top:10px;">
                    <h3 style="margin-top:12px;">Your Details</h3>
                    <label>Name</label>
                    <input id="nameInput" type="text" placeholder="Your name" />
                    <label>Email</label>
                    <input id="emailInput" type="email" placeholder="you@example.com" />
                    <button class="btn" id="saveDetailsBtn" style="margin-top:8px;">Save</button>
                </div>
                <div class="note">Note: OTP works on HTTPS or localhost.</div>
            </div>
        </div>
        
        <div class="modal-backdrop" id="profileModal" style="display:none;">
            <div class="modal">
                <h3>User Profile</h3>
                <div style="text-align:center; margin-bottom:12px;">
                    <img id="profileImagePreview" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:2px solid #ccc;">
                    <label for="profileImageInput" style="display:block; margin-top:8px; cursor:pointer; font-weight:700; color:#2196f3;">
                        Change Picture
                    </label>
                    <input type="file" id="profileImageInput" accept="image/*" style="display:none;">
                </div>
                <label>Name</label>
                <input id="profileNameInput" type="text" placeholder="Your name" />
                <label>Contact</label>
                <input id="profileContactInput" type="tel" placeholder="+91XXXXXXXXXX" disabled />
                <label>Email</label>
                <input id="profileEmailInput" type="email" placeholder="you@example.com" />
                <div class="row" style="justify-content:flex-end;">
                    <button class="btn secondary" id="closeProfileBtn">Cancel</button>
                    <button class="btn" id="saveProfileBtn">Save</button>
                </div>
                <div class="note">Your contact number cannot be changed here.</div>
            </div>
        </div>
        
        <div class="modal-backdrop" id="staticPageModal" style="display:none;">
            <div class="modal">
                <div class="row" style="justify-content:space-between; align-items:center;">
                    <h3 id="staticPageTitle"></h3>
                    <button class="btn secondary" onclick="document.getElementById('staticPageModal').style.display='none';">Close</button>
                </div>
                <div id="staticPageContent" style="margin-top:12px; font-size:14px; color:#444;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        /* ====================================================== */
        /* üî•üî•üî• PASTE YOUR FIREBASE CONFIG HERE üî•üî•üî•        */
        /* ====================================================== */
         var firebaseConfig = {
   apiKey: "AIzaSyAphHTM4faH7_FVXdnootp4NipZd3vtEck",
   authDomain: "tambola69-9dc8f.firebaseapp.com",
   projectId: "tambola69-9dc8f",
   storageBucket: "tambola69-9dc8f.firebasestorage.app",
   messagingSenderId: "413290158586",
   appId: "1:413290158586:web:70fff2d94b29206487ec43",
};

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase connection successful!");
        } else {
            console.log("Firebase app already running.");
        }
        
        const db = firebase.database();
        const storage = firebase.storage();
        const storageRef = storage.ref();

        /* ==================== Initial Screen Logic ==================== */
        const initialScreen = document.getElementById('initialScreen');
        const mainAppUI = document.getElementById('mainAppUI');
        const initialTicket = document.querySelector('.ticket');
        const socialLoginBox = document.getElementById('socialLoginBox');
        const spinnerContainer = document.querySelector('.spinner-container');
        const spinnerNumber = document.querySelector('.spinner-number');
        const finalNumber = document.querySelector('.final-number');
        
        function confetti() {
            for (let i = 0; i < 150; i++) {
                let div = document.createElement('div');
                div.className = 'confetti';
                div.style.width = div.style.height = `${Math.random() * 12 + 6}px`;
                div.style.background = `hsl(${Math.random() * 360}, 100%, 60%)`;
                div.style.top = '50%';
                div.style.left = '50%';
                document.body.appendChild(div);
                gsap.to(div, {
                    x: (Math.random() - 0.5) * 600,
                    y: (Math.random() - 0.5) * 600,
                    rotation: Math.random() * 360,
                    duration: 2.5,
                    opacity: 0,
                    ease: "power2.out",
                    onComplete: () => div.remove()
                });
            }
        }
        
        gsap.set(initialTicket, { scale: 0, opacity: 0 });
        gsap.set(finalNumber, { scale: 0, opacity: 0 });
        
        const tl = gsap.timeline({ defaults: { duration: 1, ease: "power3.inOut" } });
        tl.to(initialTicket, { scale: 1, opacity: 1, duration: 1.8, ease: "back.out(1.7)" })
          .to(spinnerContainer, { autoAlpha: 1, scale: 1, duration: 0.8 }, "-=0.5");
        
        tl.to({}, {
            duration: 4,
            onUpdate: () => {
                spinnerNumber.textContent = Math.floor(Math.random() * 90) + 1;
            }
        });
        
        tl.to({}, {
            duration: 0.5,
            onComplete: () => {
                spinnerNumber.textContent = "69";
            }
        })
        .to(finalNumber, { opacity: 1, scale: 1, y: 0, duration: 0.7, ease: "back.out(2)" })
        .to(finalNumber, { scale: 1.2, duration: 0.4, ease: "elastic.out(1,0.3)", onComplete: confetti })
        .to(spinnerContainer, { autoAlpha: 0, scale: 0.5, duration: 1 }, "-=1.5");
        
        tl.add(() => {
            gsap.to(initialScreen, {
                autoAlpha: 0,
                scale: 0.9,
                duration: 1,
                onComplete: () => {
                    initialScreen.style.display = 'none';
                    mainAppUI.style.display = 'block';
                    // This is where the app UI is shown
                }
            });
        }, "+=1");

        /* ==================== Main App UI Logic ==================== */
        
        const boardEl = document.getElementById('board');
        const tambolaBoardEl = document.getElementById('tambola-board');
        const ticketEl = document.getElementById('ticket');
        const ticketSerialEl = document.getElementById('ticketSerial');
        const historyEl = document.getElementById('history');
        const winnerListEl = document.getElementById('winnerList');
        const userTicketContainer = document.getElementById('userTicketContainer');
        const ticketShellEl = document.getElementById('ticketShell');

        const waitingTitle = document.getElementById('waitingTitle');
        const waitingDesc = document.getElementById('waitingDesc');
        const latestNumber = document.getElementById('latestNumber');
        const waitingLiveText = document.getElementById('waitingLiveText');
        const liveDot = document.getElementById('liveDot');

        const buyTicketBtnTop = document.getElementById('buyTicketBtnTop');
        const buyTicketBtnBottom = document.getElementById('buyTicketBtnBottom');
        const menuToggle = document.getElementById('menuToggle');
        const menuPanel = document.getElementById('menuPanel');
        const viewProfileBtn = document.getElementById('viewProfileBtn');
        const viewHistoryBtn = document.getElementById('viewHistoryBtn');
        const viewTicketsBtn = document.getElementById('viewTicketsBtn');

        const withdrawBtn = document.getElementById('withdrawBtn');
        const withdrawModal = document.getElementById('withdrawModal');
        const cancelWithdrawBtn = document.getElementById('cancelWithdrawBtn');
        const submitWithdrawBtn = document.getElementById('submitWithdrawBtn');
        const withdrawAmount = document.getElementById('withdrawAmount');
        const withdrawDest = document.getElementById('withdrawDest');

        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const joinRoomIdInput = document.getElementById('joinRoomIdInput');
        const roomBuyTicketBtn = document.getElementById('roomBuyTicketBtn');
        const startRoomGameBtn = document.getElementById('startRoomGameBtn');
        const roomInfoEl = document.getElementById('roomInfo');
        const playersListEl = document.getElementById('playersList');
        const roomStatusPill = document.getElementById('roomStatusPill');

        const watchLiveBtn = document.getElementById('watchLiveBtn');
        const liveVideoBox = document.getElementById('liveVideoBox');
        const liveFrame = document.getElementById('liveFrame');

        const autoTickToggle = document.getElementById('autoTickToggle');
        const autoClaimToggle = document.getElementById('autoClaimToggle');

        const musicRef = db.ref("music");
        const player = document.getElementById("liveMusic");
        const musicBtn = document.getElementById("musicBtn");
        const currentGameRef = db.ref('currentGame');
        const nextGameRef = db.ref('nextGame');
        const videoRef = db.ref('video');
        const userGamesRef = db.ref('userTickets');
        const claimsRef=db.ref('claims');
        const winnersRef=db.ref('winners');
        
        const profileModal = document.getElementById('profileModal');
        const closeProfileBtn = document.getElementById('closeProfileBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const profileImageInput = document.getElementById('profileImageInput');
        const profileImagePreview = document.getElementById('profileImagePreview');
        const profileNameInput = document.getElementById('profileNameInput');
        const profileContactInput = document.getElementById('profileContactInput');
        const profileEmailInput = document.getElementById('profileEmailInput');

        document.querySelectorAll('.claim-button').forEach(button => {
            button.addEventListener('click', () => {
                const prizeName = button.getAttribute('data-prize');
                if (prizeName) {
                    claimPrize(prizeName);
                }
            });
        });

        const boxes = [
            document.getElementById('claimBox'), document.getElementById('historyBox'), document.getElementById('winnersBox'),
            document.getElementById('nextGameBoxTop'), document.getElementById('nextGameBoxBottom'), document.getElementById('playFriendsBox')
        ];
        boxes.forEach(el=>{
            if(!el) return;
            const h=Math.floor(Math.random()*360);
            const s=60+Math.random()*20;
            const l=45+Math.random()*15;
            el.style.background=`hsl(${h},${s}%,${l}%)`;
        });
        
        let userId = null;
        let myName = null;
        let myContact = null;
        let myEmail = null;
        let currentTicketSerial = null;
        let currentTicketGameId = null;
        
        const LS_UID='tambola_user_v2', LS_NAME='tambola_name_v2', LS_CONTACT='tambola_contact_v2', LS_EMAIL='tambola_email_v2';
        const LS_AUTOTICK='tambola_auto_tick_v2', LS_AUTOCLAIM='tambola_auto_claim_v2';
        const LS_TICKET_TICKS_PREFIX = 'tambola_ticket_ticks_v2_';

        function setLocalProfile(id,name,phone,email){
            if(id) localStorage.setItem(LS_UID,id);
            if(name) localStorage.setItem(LS_NAME,name);
            if(phone) localStorage.setItem(LS_CONTACT,phone);
            if(email) localStorage.setItem(LS_EMAIL,email);
        }
        function loadProfileFromLocal(){
            userId = localStorage.getItem(LS_UID);
            myName = localStorage.getItem(LS_NAME);
            myContact = localStorage.getItem(LS_CONTACT);
            myEmail = localStorage.getItem(LS_EMAIL);
        }
        function ensureGuest(){
            if(!localStorage.getItem(LS_UID)){
                const gen='u_'+Math.random().toString(36).slice(2,9);
                setLocalProfile(gen,'Guest',null,null);
            }
            loadProfileFromLocal();
        }
        autoTickToggle.checked = localStorage.getItem(LS_AUTOTICK) === '1';
        autoClaimToggle.checked = localStorage.getItem(LS_AUTOCLAIM) === '1';
        autoTickToggle.addEventListener('change', ()=> localStorage.setItem(LS_AUTOTICK, autoTickToggle.checked ? '1':'0'));
        autoClaimToggle.addEventListener('change', ()=> localStorage.setItem(LS_AUTOCLAIM, autoClaimToggle.checked ? '1':'0'));

        const loginModal = document.getElementById('loginModal');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const closeLoginBtn = document.getElementById('closeLoginBtn');
        const detailsStep = document.getElementById('detailsStep');
        const nameInput = document.getElementById('nameInput');
        const emailInput = document.getElementById('emailInput');
        const phoneInput = document.getElementById('phoneInput');
        const otpInput = document.getElementById('otpInput');
        let recaptchaVerifier=null, confirmationResult=null;
        
        function showLoginModal(){ 
            loginModal.style.display='flex'; 
            ensureRecaptcha(); 
        }
        
        function hideLoginModal(){ 
            loginModal.style.display='none'; 
        }
        
        closeLoginBtn.addEventListener('click', hideLoginModal);

        function applyAuthUser(u){
            if(!u) return;
            userId = u.uid;
            myContact = u.phoneNumber || myContact;
            setLocalProfile(userId, myName, myContact, myEmail);
            loadUserTicket();
        }

        for(let i=1;i<=90;i++){
            const cell=document.createElement('div');
            cell.className='tambola-board-cell';
            cell.id='b_'+i;
            cell.textContent=i;
            tambolaBoardEl.appendChild(cell);
        }
        for(let i=1;i<=90;i++){
            const cell=document.createElement('div');
            cell.className='board-cell';
            cell.id='b_'+i;
            cell.textContent=i;
            if (boardEl) boardEl.appendChild(cell);
        }

        function generateTicketMatrix(){
            const cols=[], chosen=[];
            for(let c=0;c<9;c++){
                const min=c===0?1:c*10;
                const max=c===8?90:c*10+9;
                const pool=[]; for(let n=min;n<=max;n++) pool.push(n);
                cols.push(pool);
            }
            while(chosen.length<15){
                const c=Math.floor(Math.random()*9);
                if(chosen.filter(x=>x.col===c).length>=3) continue;
                const pool=cols[c];
                const val=pool[Math.floor(Math.random()*pool.length)];
                if(!chosen.some(x=>x.num===val)) chosen.push({col:c,num:val});
            }
            const byCol=Array.from({length:9},()=>[]);
            chosen.forEach(x=>byCol[x.col].push(x.num));
            byCol.forEach(a=>a.sort((a,b)=>a-b));
            const grid=Array.from({length:3},()=>Array(9).fill(null));
            const rowCounts=[0,0,0];
            for(let c=0;c<9;c++){
                if(byCol[c].length===3){ for(let r=0;r<3;r++){ grid[r][c]=byCol[c][r]; rowCounts[r]++; } }
            }
            for(let c=0;c<9;c++){
                if(byCol[c].length===2){
                    const rows=[0,1,2].sort((a,b)=>rowCounts[a]-rowCounts[b]).slice(0,2);
                    grid[rows[0]][c]=byCol[c][0]; grid[rows[1]][c]=byCol[c][1];
                    rowCounts[rows[0]]++; rowCounts[rows[1]]++;
                }
            }
            for(let c=0;c<9;c++){
                if(byCol[c].length===1){
                    const r=[0,1,2].sort((a,b)=>rowCounts[a]-rowCounts[b])[0];
                    grid[r][c]=byCol[c][0]; rowCounts[r]++;
                }
            }
            return grid;
        }
        let currentGrid=null;
        
        function renderTicket(grid, serialText){
            const g = grid || currentGrid;
            if(!g) return;
            userTicketContainer.style.display='block';
            ticketEl.innerHTML='';
            if(serialText) ticketSerialEl.textContent = serialText;
            const ticks=JSON.parse(localStorage.getItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId) ||'[]');
            for(let r=0;r<3;r++){
                for(let c=0;c<9;c++){
                    const val=g[r][c];
                    const cell=document.createElement('div');
                    if(!val){cell.className='ticket-cell empty'; cell.innerHTML='&nbsp;';}
                    else{
                        cell.className='ticket-cell';
                        cell.textContent=val;
                        if(ticks.includes(val)) cell.classList.add('ticked');
                    }
                    cell.addEventListener('click',()=>{
                        if(!val) return;
                        const ticksNow = JSON.parse(localStorage.getItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId)||'[]');
                        if(cell.classList.contains('ticked')){
                            cell.classList.remove('ticked');
                            const idx=ticksNow.indexOf(val);
                            if(idx>-1) ticksNow.splice(idx,1);
                        } else {
                            cell.classList.add('ticked'); ticksNow.push(val);
                        }
                        localStorage.setItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId, JSON.stringify(ticksNow));
                    });
                    ticketEl.appendChild(cell);
                }
            }
        }
        
        function markTicketBuggy(reason){
            const cells = ticketEl.querySelectorAll('.ticket-cell.ticked');
            cells.forEach(c=> c.classList.add('buggy'));
            const uid = localStorage.getItem(LS_UID) || userId || ('guest_'+Math.random().toString(36).slice(2,6));
            db.ref('buggyClaims').push({ userId:uid, name: localStorage.getItem(LS_NAME)||myName||'Guest', time: firebase.database.ServerValue.TIMESTAMP, reason });
            setTimeout(()=>{ cells.forEach(c=> c.classList.remove('buggy')); },6000);
        }
        
        function ticketNumbersFlat(grid){
            return grid.flat().filter(Boolean);
        }

        function saveTicketToDB(ticketData, gameId) {
            if (!userId) {
                alert("Please log in to book a ticket.");
                return;
            }
            const userTicketRef = userGamesRef.child(userId).child(gameId);
            userTicketRef.set(ticketData).then(() => {
                console.log("Ticket saved to DB successfully.");
            }).catch(error => {
                console.error("Error saving ticket to DB:", error);
                alert("Failed to save ticket. Please try again.");
            });
        }

        function loadUserTicket() {
            if (!userId) return;
            userGamesRef.child(userId).once('value', snapshot => {
                const allTickets = snapshot.val();
                const listEl = document.getElementById('userGamesList');
                if (allTickets) {
                    listEl.innerHTML = renderUserGamesList(allTickets);
                } else {
                    listEl.innerHTML = 'No booked tickets yet.';
                }
            });
        }
        
        function renderUserGamesList(tickets) {
            let html = '';
            Object.keys(tickets).forEach(gameId => {
                const ticketData = tickets[gameId];
                html += `
                    <div class="game-info-item">
                        <div style="font-weight: bold;">Game: ${ticketData.gameName}</div>
                        <div>Ticket ID: ${ticketData.serial}</div>
                        <div>Status: ${ticketData.status}</div>
                        <div><a href="#" onclick="showSpecificTicket('${gameId}')">View Ticket</a></div>
                    </div>
                `;
            });
            return html;
        }

        function showSpecificTicket(gameId) {
            userGamesRef.child(userId).child(gameId).once('value', snapshot => {
                const ticketData = snapshot.val();
                if (ticketData) {
                    currentGrid = ticketData.ticket;
                    currentTicketSerial = ticketData.serial;
                    currentTicketGameId = gameId;
                    localStorage.removeItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId);
                    renderTicket(currentGrid, `#${currentTicketSerial}`);
                    const prizeButtons = document.querySelectorAll('.claim-button');
                    prizeButtons.forEach(button => {
                        button.style.backgroundColor = 'green';
                        button.style.textDecoration = 'none';
                        button.disabled = false;
                    });
                    if (ticketData.claimedPrizes) {
                        ticketData.claimedPrizes.forEach(prize => {
                            prizeButtons.forEach(button => {
                                if (button.getAttribute('data-prize') === prize) {
                                    button.style.backgroundColor = 'gray';
                                    button.disabled = true;
                                    button.innerHTML = `<span class="claimed-button-text">X</span> ${prize}`;
                                }
                            });
                        });
                    }
                }
            });
        }

        [buyTicketBtnTop, buyTicketBtnBottom].forEach(btn=>{
            if(!btn) return;
            btn.addEventListener('click', ()=>{
                if (!userId) {
                    showLoginModal();
                    return;
                }
                alert("Payment Placeholder: Payment Success!");
                const grid = generateTicketMatrix();
                const serial = Math.floor(Math.random()*100000);
                const gameId = 'global-' + Date.now();
                const ticketData = { ticket: grid, serial, gameId, gameName: 'Mega Contest', status: 'booked', claimedPrizes: [] };
                saveTicketToDB(ticketData, gameId);
                currentGrid = grid;
                currentTicketSerial = serial;
                currentTicketGameId = gameId;
                localStorage.removeItem(LS_TICKET_TICKS_PREFIX + gameId);
                renderTicket(currentGrid, `#${serial}`);
                document.querySelectorAll('.claim-button').forEach(button => {
                    button.style.backgroundColor = 'green';
                    button.disabled = false;
                    button.style.textDecoration = 'none';
                    button.innerHTML = button.getAttribute('data-prize') + ' ‚Çπ' + PRIZE_AMOUNTS[button.getAttribute('data-prize')];
                });
            });
        });

        if (viewTicketsBtn) {
            viewTicketsBtn.addEventListener('click', () => {
                const listEl = document.getElementById('userGamesList');
                if (listEl.style.display === 'none') {
                    listEl.style.display = 'block';
                    viewTicketsBtn.textContent = 'Hide Booked Tickets';
                    loadUserTicket();
                } else {
                    listEl.style.display = 'none';
                    viewTicketsBtn.textContent = 'View All Booked Tickets';
                }
            });
        }
        
        const presenceRef=db.ref('presence');
        let myPresence=null;
        let activeRoom = null;
        let isHost=false;
        let drawTimer=null;
        const DRAW_INTERVAL_MS = 4000;
        const ROOM_STATUS = { WAIT:'waiting', START:'started', END:'ended' };

        function highlightBoard(n, hist){
            document.querySelectorAll('.tambola-board-cell').forEach(cell => cell.classList.remove('drawn'));
            hist.forEach(num => {
                const hCell = document.getElementById('b_'+num);
                if(hCell) hCell.classList.add('drawn');
            });
            const latestCell = document.getElementById('b_' + n);
            if (latestCell) {
                latestCell.classList.add('drawn');
            }
        }
        
        let globalCountdownInterval;
        let nextCountdownInterval;

        function updateCountdownDisplay(seconds, elementId) {
            const countdownEl = document.getElementById(elementId);
            if (!countdownEl) return;
            let remaining = seconds;
            
            const intervalId = setInterval(() => {
                remaining--;
                if (remaining >= 0) {
                    const hours = Math.floor(remaining / 3600);
                    const minutes = Math.floor((remaining % 3600) / 60);
                    const secs = remaining % 60;
                    const formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                    countdownEl.textContent = formattedTime;
                } else {
                    countdownEl.textContent = "00:00:00";
                    clearInterval(intervalId);
                }
            }, 1000);
            return intervalId;
        }

        function handleGlobalGameData(data) {
            const status = data.status || 'idle';
            const liveNumber = data.liveNumber;
            const historyArr = data.history || [];
            const countdown = data.countdown;
            
            waitingTitle.textContent = `Game Status: ${status}`;
            waitingDesc.textContent = status === 'started' ? 'Global public draw is live' : 'No active game';
            latestNumber.textContent = liveNumber ? 'Number: ' + liveNumber : '‚Äî';
            historyEl.textContent = historyArr.length ? historyArr.join(', ') : 'None';
            highlightBoard(liveNumber, historyArr);
            
            if (status === 'started' && countdown > 0) {
            }
        }

        function handleNextGameData(data) {
            const countdown = data.countdown;
            const ticketsLeft = data.ticketsLeft || 0;
            const prizePercentage = data.prizePercentage || 0;
            const totalSpots = data.totalSpots || 100;

            document.getElementById('ticketsLeftBottom').textContent = ticketsLeft;
            document.getElementById('prizePercentageBottom').textContent = `${prizePercentage}%`;
            document.getElementById('TotalSpotBottum').textContent = totalSpots;
            document.getElementById('ticketsLeftTop').textContent = ticketsLeft;
            document.getElementById('prizePercentageTop').textContent = `${prizePercentage}%`;
            document.getElementById('TotalSpotTop').textContent = totalSpots;
            
            if (countdown) {
                clearInterval(nextCountdownInterval);
                nextCountdownInterval = updateCountdownDisplay(countdown, 'nextCountdownBottom');
                updateCountdownDisplay(countdown, 'nextCountdownTop');
            }
        }

        currentGameRef.on('value', s => {
            const data = s.val() || {};
            if(!activeRoom) {
                handleGlobalGameData(data);
            }
        });

        nextGameRef.on('value', s => {
            const data = s.val() || {};
            handleNextGameData(data);
        });
        
        videoRef.on('value', snap => {
            const data = snap.val() || {};
            const liveBtn = document.getElementById('watchLiveBtn');
            if (data.url && liveBtn) {
                liveBtn.onclick = function() {
                    liveFrame.src = data.url + '?autoplay=1&rel=0';
                    liveVideoBox.style.display = 'block';
                    liveBtn.style.display = 'none';
                };
            }
        });

        const userHistoryRef = db.ref('userHistory');
        const withdrawalHistoryRef = db.ref('withdrawalHistory');
        const notificationRef = db.ref('notifications');

        const PRIZE_AMOUNTS = {
            'Early Five':500, 'Top Line':500, 'Middle Line':500, 'Bottom Line':500,
            'Full House':3000, 'Ticket Corner':500, 'Ticket Corner Prize':500, 'Each Line':500, '2nd Full House':1000
        };

        winnersRef.on('value',s=>{
            const data=s.val()||{};
            const arr = Object.entries(data||{}).map(([k,w])=>{
                const claimed = w.claimed?'<span class="winner-x">X</span>':'';
                const uname = w.name || w.userName || 'Player';
                return `<div class="winner-row">${claimed}<div>${uname} - ${w.prize||'Winner'}</div><div>‚Çπ${w.amount||0}</div></div>`;
            });
            winnerListEl.innerHTML = arr.length?arr.join(''):'No winners yet...';
        });

        async function ensureUserRecord(uid){
            const userRef=db.ref('users/'+uid);
            const snap=await userRef.once('value');
            if(!snap.exists()){
                await userRef.set({ name: localStorage.getItem(LS_NAME)||myName||'Guest', phone: localStorage.getItem(LS_CONTACT)||myContact||'', email: localStorage.getItem(LS_EMAIL) || myEmail || '', balance:0 });
            }
        }
        async function getUserBalance(uid){
            const snap=await db.ref('users/'+uid).once('value');
            return (snap.val() && snap.val().balance) || 0;
        }
        async function setUserBalance(uid, newBal){
            await db.ref('users/'+uid).update({ balance: newBal });
            document.getElementById('myWinnings').textContent = newBal;
        }

        async function claimPrize(prizeName){
            if(!currentGrid || !currentTicketGameId){
                alert("Please book and view a ticket first!"); 
                return;
            }
        
            const uid = localStorage.getItem(LS_UID) || userId || ('guest_'+Math.random().toString(36).slice(2,6));
            const name = localStorage.getItem(LS_NAME) || myName || 'Guest';
            const amount = PRIZE_AMOUNTS[prizeName] || 0;
            const gameId = currentTicketGameId;
        
            const ticketDataSnap = await userGamesRef.child(uid).child(gameId).once('value');
            const ticketInfo = ticketDataSnap.val();
            if(!ticketInfo) {
                alert("Ticket not found!");
                return;
            }
        
            if(ticketInfo.claimedPrizes && ticketInfo.claimedPrizes.includes(prizeName)) {
                alert("You have already claimed this prize for this ticket!");
                return;
            }
        
            const historyRef = activeRoom ? db.ref(`rooms/${activeRoom}/draw/history`) : currentGameRef.child('history');
            const historyArr = (await historyRef.once('value')).val() || [];
            const H = Array.isArray(historyArr) ? historyArr : Object.values(historyArr||{});
            const tnums = ticketNumbersFlat(currentGrid);
            
            const validators = {
                'Early Five': ()=>{
                    const firstFiveDrawn = H.slice(0,5);
                    return firstFiveDrawn.length === 5 && ticketNumbersFlat(ticketInfo.ticket).filter(n => firstFiveDrawn.includes(n)).length >= 5;
                },
                'Top Line': ()=> {
                    const row = currentGrid[0].filter(Boolean);
                    return row.every(n => H.includes(n));
                },
                'Middle Line': ()=> {
                    const row = currentGrid[1].filter(Boolean);
                    return row.every(n => H.includes(n));
                },
                'Bottom Line': ()=> {
                    const row = currentGrid[2].filter(Boolean);
                    return row.every(n => H.includes(n));
                },
                'Ticket Corner': ()=> {
                    const corners = [];
                    if(currentGrid[0][0]) corners.push(currentGrid[0][0]);
                    if(currentGrid[0][8]) corners.push(currentGrid[0][8]);
                    if(currentGrid[2][0]) corners.push(currentGrid[2][0]);
                    if(currentGrid[2][8]) corners.push(currentGrid[2][8]);
                    return corners.length===4 && corners.every(n => H.includes(n));
                },
                'Full House': ()=> {
                    return tnums.every(n=>H.includes(n));
                },
                '2nd Full House': ()=> {
                    return tnums.every(n=>H.includes(n));
                }
            };
        
            const valid = validators[prizeName] ? validators[prizeName]() : false;
        
            if(!valid){
                markTicketBuggy(`Wrong claim: ${prizeName}`);
                alert('Invalid claim ‚Äî ticket marked buggy. Please review your numbers.');
                await db.ref('claims').push({ userId: uid, userName: name, prize: prizeName, time: firebase.database.ServerValue.TIMESTAMP, valid:false, gameId });
                return;
            }
            
            const claimRef = claimsRef.push();
            await claimRef.set({ userId: uid, userName: name, prize: prizeName, time: firebase.database.ServerValue.TIMESTAMP, valid:true, gameId });
            const wref = winnersRef.push();
            await wref.set({ userId: uid, name, prize: prizeName, amount, claimed: true, time: firebase.database.ServerValue.TIMESTAMP, gameId });
            const userRef = db.ref('users/'+uid);
            const snap = await userRef.once('value');
            const existing = snap.val() || {};
            const newBal = (existing.balance||0) + amount;
            await userRef.update({ balance: newBal, name: name, phone: localStorage.getItem(LS_CONTACT)||myContact||'', email: localStorage.getItem(LS_EMAIL) || myEmail || '' });
            document.getElementById('myWinnings').textContent = newBal;
            alert(`Claim submitted for ${prizeName}. ‚Çπ${amount} added to your balance.`);
        
            const userTicketRef = db.ref(`userTickets/${uid}/${currentTicketGameId}`);
            const claimedPrizes = ticketInfo.claimedPrizes || [];
            claimedPrizes.push(prizeName);
            userTicketRef.update({ claimedPrizes });
            userTicketRef.update({ status: 'claimed', claimedPrize: prizeName });
        
            userHistoryRef.child(uid).push({
                type: 'claim',
                prize: prizeName,
                amount,
                gameId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        
            const prizeButtons = document.querySelectorAll('.claim-button');
            prizeButtons.forEach(button => {
                if (button.getAttribute('data-prize') === prizeName) {
                    button.innerHTML = `<span class="claimed-button-text">X</span> ${prizeName} ‚Çπ${amount}`;
                    button.disabled = true;
                    button.style.backgroundColor = 'gray';
                }
            });
        }

        async function tryAutoClaims(){
            if(!autoClaimToggle.checked) return;
            const possible = ['Early Five','Top Line','Middle Line','Bottom Line','Ticket Corner','Full House','2nd Full House'];
            for(const p of possible){
                try{
                    await claimPrize(p);
                }catch(e){}
            }
        }

        (function setupHamburger(){
            const menuToggleEl = document.getElementById('menuToggle');
            const menuPanelEl = document.getElementById('menuPanel');
            menuToggleEl.addEventListener('click', ()=> menuPanelEl.classList.toggle('show'));
            document.addEventListener('click', (e)=>{
                if(!menuPanelEl.contains(e.target) && e.target !== menuToggleEl){
                    menuPanelEl.classList.remove('show');
                }
            });
        })();

        if(viewProfileBtn){
            viewProfileBtn.addEventListener('click', async ()=>{
                if(!firebase.auth().currentUser){
                    alert('Please log in to view your profile.');
                    showLoginModal();
                    return;
                }
                await loadAndShowProfile();
            });
        }

        async function loadAndShowProfile() {
            const u = firebase.auth().currentUser;
            if (!u) return;

            const snap = await db.ref('users/' + u.uid).once('value');
            const data = snap.val() || {};

            profileNameInput.value = data.name || '';
            profileContactInput.value = u.phoneNumber || data.phone || '';
            profileEmailInput.value = data.email || '';
            profileImagePreview.src = data.profilePictureUrl || 'https://via.placeholder.com/100';

            profileModal.style.display = 'flex';
        }

        if(closeProfileBtn){
            closeProfileBtn.addEventListener('click', ()=> profileModal.style.display='none');
        }

        if(profileImageInput){
            profileImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        profileImagePreview.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        if(saveProfileBtn){
            saveProfileBtn.addEventListener('click', async () => {
                const u = firebase.auth().currentUser;
                if (!u) {
                    alert('Please log in to save your profile.');
                    return;
                }

                const name = profileNameInput.value.trim();
                const email = profileEmailInput.value.trim();
                const profileImageFile = profileImageInput.files[0];
                let profilePictureUrl = profileImagePreview.src;

                try {
                    if (profileImageFile) {
                        const imageRef = storageRef.child(`profile-pictures/${u.uid}/${profileImageFile.name}`);
                        await imageRef.put(profileImageFile);
                        profilePictureUrl = await imageRef.getDownloadURL();
                    }

                    await db.ref('users/' + u.uid).update({
                        name: name,
                        email: email,
                        phone: u.phoneNumber,
                        profilePictureUrl: profilePictureUrl
                    });
                    
                    setLocalProfile(u.uid, name, u.phoneNumber, email);
                    myName = name;
                    myEmail = email;
                    
                    alert('Profile updated successfully!');
                    profileModal.style.display = 'none';

                } catch (error) {
                    console.error('Error saving profile:', error);
                    alert('Failed to save profile. Please try again.');
                }
            });
        }

        if(viewHistoryBtn){
            viewHistoryBtn.addEventListener('click', async () => {
                if (!userId) {
                    alert('Please log in to view history.');
                    showLoginModal();
                    return;
                }

                const gameHistorySnap = await userHistoryRef.child(userId).once('value');
                const withdrawalHistorySnap = await withdrawalHistoryRef.child(userId).once('value');
                const gameHistory = gameHistorySnap.val() || {};
                const withdrawalHistory = withdrawalHistorySnap.val() || {};

                let gameHtml = '<h4>Game History</h4>';
                if (Object.keys(gameHistory).length === 0) {
                    gameHtml += '<p>No game history found.</p>';
                } else {
                    Object.values(gameHistory).forEach(h => {
                        gameHtml += `<p>‚Ä¢ ${h.type} of ${h.prize} for ‚Çπ${h.amount} in game ${h.gameId} on ${new Date(h.timestamp).toLocaleString()}</p>`;
                    });
                }

                let withdrawalHtml = '<h4>Payment History</h4>';
                if (Object.keys(withdrawalHistory).length === 0) {
                    withdrawalHtml += '<p>No payment history found.</p>';
                } else {
                    Object.values(withdrawalHistory).forEach(h => {
                        withdrawalHtml += `<p>‚Ä¢ ${h.type} of ‚Çπ${h.amount} to ${h.dest} on ${new Date(h.timestamp).toLocaleString()} (Status: ${h.status})</p>`;
                    });
                }

                const modal = document.createElement('div');
                modal.className = 'modal-backdrop';
                modal.innerHTML = `<div class="modal" style="text-align:left;">
                    <div class="row" style="justify-content:space-between; align-items:center;">
                        <h3>History</h3>
                        <button class="btn secondary" onclick="document.body.removeChild(this.closest('.modal-backdrop'));">Close</button>
                    </div>
                    ${gameHtml}
                    ${withdrawalHtml}
                </div>`;
                document.body.appendChild(modal);
                modal.style.display = 'flex';
            });
        }
        
        function showStaticPage(page) {
            const modal = document.getElementById('staticPageModal');
            const titleEl = document.getElementById('staticPageTitle');
            const contentEl = document.getElementById('staticPageContent');
            let title = '';
            let content = '';
            
            switch (page) {
                case 'about':
                    title = 'About Us';
                    content = `<p>Welcome to Tambola 69, your ultimate destination for playing Tambola/Housie online with friends and family! We are dedicated to providing a fun, engaging, and fair gaming experience for everyone.</p><p>Our platform allows you to join public games or create your own private rooms, ensuring a seamless and interactive experience. With features like live number announcements and automatic ticket marking, we bring the classic game of Tambola to your fingertips.</p><p>Happy playing! üéâ</p>`;
                    break;
                case 'terms':
                    title = 'Terms and Conditions';
                    content = `<p>Welcome to Tambola 69. These terms and conditions outline the rules and regulations for the use of Tambola 69's Website and App.</p><p>By accessing this website, we assume you accept these terms and conditions. Do not continue to use Tambola 69 if you do not agree to all of the terms and conditions stated on this page.</p><p><b>License:</b> Unless otherwise stated, Tambola 69 and/or its licensors own the intellectual property rights for all material on Tambola 69. All intellectual property rights are reserved. You may access this from Tambola 69 for your own personal use subjected to restrictions set in these terms and conditions.</p><p><b>User Obligations:</b> You must be of legal age to play this game in your region. You are responsible for maintaining the confidentiality of your account and password and for restricting access to your computer or device.</p><p><b>Disputes:</b> Any dispute related to these terms and conditions will be governed by the laws of India. All disputes will be resolved in the courts of [Your City].</p><p>We reserve the right to amend these terms at any time. Your continued use of the app signifies your acceptance of any new terms.</p>`;
                    break;
                case 'privacy':
                    title = 'Privacy Policy';
                    content = `<p>Your privacy is important to us. It is Tambola 69's policy to respect your privacy regarding any information we may collect from you.</p><p><b>Information We Collect:</b> We only ask for personal information when we truly need it to provide a service to you. We collect it by fair and lawful means, with your knowledge and consent.</p><p><b>How We Use Information:</b> The information we collect is used to process your game tickets, manage your winnings, and communicate with you about your account. We do not share your personally identifying information publicly or with third-parties, except when required by law.</p><p><b>Data Security:</b> We take reasonable precautions to protect the data you provide to us. However, please be aware that no method of electronic storage is 100% secure.</p><p><b>Changes to This Policy:</b> We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page.</p>`;
                    break;
                default:
                    title = 'Page Not Found';
                    content = '<p>The requested page could not be found.</p>';
                    break;
            }
            
            titleEl.textContent = title;
            contentEl.innerHTML = content;
            modal.style.display = 'flex';
        }
        window.showStaticPage = showStaticPage;

        function attachPresence(){
            try{
                if(myPresence){ myPresence.remove(); myPresence=null; }
            }catch(e){}
            const id = localStorage.getItem(LS_UID) || userId || ('guest_'+Math.random().toString(36).slice(2,8));
            myPresence = presenceRef.push({id, time:firebase.database.ServerValue.TIMESTAMP});
            myPresence.onDisconnect().remove();
        }
        
        presenceRef.on('value',snap=>{
            const n = snap.numChildren()||0;
            if(!activeRoom){
                waitingLiveText.textContent = 'Live Users: ' + n;
                liveDot.style.background = (n>0)?'#00e676':'#bdbdbd';
            }
        });
        
        firebase.auth().onAuthStateChanged(async (u)=>{
            if(u){
                applyAuthUser(u); attachPresence();
                try{
                    const snap = await db.ref('users/'+u.uid).once('value');
                    const data = snap.val();
                    if(data){
                        myName = data.name || myName; myEmail = data.email || myEmail; myContact = u.phoneNumber || data.phone || myContact;
                        setLocalProfile(u.uid, myName, myContact, myEmail);
                    }else{
                        showLoginModal(); detailsStep.style.display='block';
                    }
                    getUserBalance(u.uid).then(bal => document.getElementById('myWinnings').textContent = bal);
                }catch(e){}
            }else{
                ensureGuest(); attachPresence();
            }
        });
        
        function ensureRecaptcha(){
            if(!recaptchaVerifier){
                recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size:'normal' });
                recaptchaVerifier.render();
            }
        }
        
        if(sendOtpBtn) sendOtpBtn.addEventListener('click', async ()=>{
            try{
                ensureRecaptcha();
                const phone=(phoneInput.value||'').trim();
                if(!phone) return alert('Enter phone (e.g., +91XXXXXXXXXX)');
                confirmationResult = await firebase.auth().signInWithPhoneNumber(phone, recaptchaVerifier);
                alert('OTP sent!');
            }catch(e){ alert(e.message); }
        });
        
        if(verifyOtpBtn) verifyOtpBtn.addEventListener('click', async ()=>{
            try{
                if(!confirmationResult) return alert('Send OTP first.');
                const code=(otpInput.value||'').trim(); if(!code) return alert('Enter OTP');
                const result=await confirmationResult.confirm(code);
                const u=result.user; applyAuthUser(u);
                const snap=await db.ref('users/'+u.uid).once('value');
                if(!snap.exists()){ detailsStep.style.display='block'; }
                else{
                    const data=snap.val(); myName=data.name||'Guest'; myEmail=data.email||''; myContact=u.phoneNumber||data.phone||'';
                    setLocalProfile(u.uid,myName,myContact,myEmail); hideLoginModal(); attachPresence(); alert('Login successful!');
                }
            }catch(e){ alert(e.message); }
        });
        
        if(document.getElementById('saveDetailsBtn')){
            document.getElementById('saveDetailsBtn').addEventListener('click', async ()=>{
                try{
                    const u=firebase.auth().currentUser; if(!u) return alert('Not logged in');
                    const name=(nameInput.value||'').trim()||'Guest'; const email=(emailInput.value||'').trim()||''; const phone=u.phoneNumber||'';
                    await db.ref('users/'+u.uid).set({name,email,phone,userId:u.uid, balance:0});
                    myName=name; myEmail=email; myContact=phone; userId=u.uid;
                    setLocalProfile(userId,myName,myContact,myEmail);
                    detailsStep.style.display='none'; hideLoginModal(); attachPresence(); alert('Details saved!');
                }catch(e){ alert(e.message); }
            });
        }
        
        if(document.getElementById('withdrawBtn')){
            withdrawBtn.addEventListener('click', ()=>{
                if(!(localStorage.getItem(LS_UID) || firebase.auth().currentUser)) { showLoginModal(); return; }
                withdrawModal.style.display='flex';
            });
            cancelWithdrawBtn.addEventListener('click', ()=> withdrawModal.style.display='none');
            submitWithdrawBtn.addEventListener('click', async ()=>{
                const amt = Number(withdrawAmount.value||0);
                const dest = (withdrawDest.value||'').trim();
                if(!amt || !dest) return alert('Enter amount and UPI/Phone');
                const uid = localStorage.getItem(LS_UID) || userId || 'guest';
                const name = localStorage.getItem(LS_NAME) || myName || 'Guest';

                await ensureUserRecord(uid);
                const bal = await getUserBalance(uid);
                if(bal < amt) return alert('Insufficient balance for withdrawal.');
                const newBal = bal - amt;
                await setUserBalance(uid, newBal);

                const wref = db.ref('withdrawals').push();
                await wref.set({
                    userId: uid, name, amount: amt, dest, time: firebase.database.ServerValue.TIMESTAMP, status: 'pending'
                });
                withdrawModal.style.display='none';
                document.getElementById('myWinnings').textContent = newBal;
                alert('Withdrawal request recorded. Admin will be notified.');

                withdrawalHistoryRef.child(uid).push({
                    type: 'withdrawal',
                    amount: amt,
                    dest,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            });
        }
        
        let roomListeners = [];

        function uiSetRoomStatus(text){ roomStatusPill.textContent = text; }
        function refreshPlayers(players){
            const arr = Object.entries(players||{}).map(([uid,p])=> `${p.name||'Player'} ${p.paid?'‚úÖ':'‚ùå'}`);
            playersListEl.innerHTML = arr.length ? ('Players: '+arr.join(' | ')) : 'Players: (none)';
        }

        async function createRoom(){
            if(!(localStorage.getItem(LS_UID) || firebase.auth().currentUser)) { showLoginModal(); return; }
            isHost=true;
            activeRoom = 'room_'+Math.random().toString(36).slice(2,8);
            await db.ref('rooms/'+activeRoom).set({
                host: localStorage.getItem(LS_UID) || ('host_'+Math.random().toString(36).slice(2,6)),
                hostName: localStorage.getItem(LS_NAME) || 'Host',
                status: ROOM_STATUS.WAIT,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            await db.ref(`rooms/${activeRoom}/players/${(localStorage.getItem(LS_UID) || 'guest')}`).set({ name: localStorage.getItem(LS_NAME)||'Host', paid:false });
            roomInfoEl.textContent='Room Created: '+activeRoom+' | Share this ID with friends.';
            joinRoomIdInput.style.display = 'none';
            roomBuyTicketBtn.style.display = 'none';
            startRoomGameBtn.style.display = 'block';
            startRoomGameBtn.disabled = true;
            uiSetRoomStatus('Waiting');
            attachRoomListeners(activeRoom);
        }

        async function joinRoomById(rid){
            if(!rid) return alert('Enter Room ID');
            if(!(localStorage.getItem(LS_UID) || firebase.auth().currentUser)) { showLoginModal(); return; }
            const snap = await db.ref('rooms/'+rid).once('value');
            if(!snap.exists()) return alert('Room not found');
            const data = snap.val();
            if(data.status!==ROOM_STATUS.WAIT) return alert('Room already started/closed');
            activeRoom = rid;
            isHost = (data.host === (localStorage.getItem(LS_UID) || 'guest'));
            await db.ref(`rooms/${rid}/players/${(localStorage.getItem(LS_UID) || 'guest')}`).update({ name: localStorage.getItem(LS_NAME)||'Player', paid:false });
            roomInfoEl.textContent = `Joined Room: ${rid} | Host: ${data.hostName || data.host} `;
            joinRoomIdInput.style.display = 'none';
            roomBuyTicketBtn.style.display = 'inline-block';
            if(isHost){
                startRoomGameBtn.style.display = 'inline-block';
                startRoomGameBtn.disabled = true;
            } else {
                startRoomGameBtn.style.display = 'none';
            }
            uiSetRoomStatus('Waiting');
            attachRoomListeners(rid);
        }

        function attachRoomListeners(rid){
            roomListeners.forEach(ref=>ref.off());
            roomListeners = [];
            const roomRef = db.ref(`rooms/${rid}`);
            const playersRef = db.ref(`rooms/${rid}/players`);
            const statusRef = db.ref(`rooms/${rid}/status`);
            const drawRef = db.ref(`rooms/${rid}/draw`);

            playersRef.on('value', s=>{
                const players = s.val() || {};
                refreshPlayers(players);
                const myUid = localStorage.getItem(LS_UID) || 'guest';
                const amInRoom = !!players[myUid];
                if(amInRoom){
                    roomBuyTicketBtn.style.display = players[myUid].paid ? 'none' : 'inline-block';
                    if(isHost){
                        startRoomGameBtn.style.display = 'inline-block';
                    }
                } else {
                    roomBuyTicketBtn.style.display = 'none';
                    startRoomGameBtn.style.display = 'none';
                }
                const uids = Object.keys(players);
                const allPaid = uids.length>0 && uids.every(uid => players[uid].paid === true);
                if(isHost){
                    startRoomGameBtn.disabled = !allPaid;
                }
                if(players[myUid] && players[myUid].ticket){
                    currentGrid = players[myUid].ticket;
                    renderTicket(currentGrid, '#'+(players[myUid].serial||'ROOM'));
                }
            });
            roomListeners.push(playersRef);

            statusRef.on('value', s=>{
                const st = s.val();
                if(st===ROOM_STATUS.WAIT) uiSetRoomStatus('Waiting');
                else if(st===ROOM_STATUS.START) uiSetRoomStatus('Started');
                else if(st===ROOM_STATUS.END) uiSetRoomStatus('Ended');
            });
            roomListeners.push(statusRef);

            drawRef.on('value', s=>{
                const d = s.val() || {};
                const cur = d.current;
                const hist = d.history || [];
                if(cur){ latestNumber.textContent = 'Number: ' + cur; highlightBoard(cur, hist); }
                historyEl.textContent = hist.length ? hist.join(', ') : 'None';
                waitingTitle.textContent = (d && d.startedAt) ? 'Room Draw Live' : 'Waiting for Draw...';
                waitingDesc.textContent = (d && d.startedAt) ? `Room ${rid} playing` : 'Room waiting';
            });
            roomListeners.push(drawRef);
        }

        async function roomBuyTicket(){
            if(!activeRoom) return alert('Create or Join a room first');
            alert('Payment Successful!');
            const grid = generateTicketMatrix();
            const serial = Math.floor(Math.random()*100000);
            const uid = localStorage.getItem(LS_UID) || 'guest';
            await db.ref(`rooms/${activeRoom}/players/${uid}`).update({ paid:true, ticket: grid, serial });
            currentGrid = grid;
            currentTicketGameId = activeRoom;
            localStorage.removeItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId);
            renderTicket(currentGrid, '#'+serial);
            saveTicketToDB({ ticket: grid, serial, gameId: activeRoom, gameName: `Room ${activeRoom}` }, activeRoom);
        }

        async function startRoomGame(){
            if(!isHost) return alert('Only host can start.');
            const plySnap = await db.ref(`rooms/${activeRoom}/players`).once('value');
            const players = plySnap.val()||{};
            const uids = Object.keys(players);
            const allPaid = uids.length>0 && uids.every(uid => players[uid].paid === true);
            if(!allPaid) return alert('All players must buy ticket first.');
            const nums = shuffle(Array.from({length:90},(_,i)=>i+1));
            await db.ref(`rooms/${activeRoom}`).update({ status: ROOM_STATUS.START });
            await db.ref(`rooms/${activeRoom}/draw`).set({ current:null, history:[], startedAt:Date.now(), intervalMs:DRAW_INTERVAL_MS, host: localStorage.getItem(LS_UID)||'host' });
            let idx=0;
            clearInterval(drawTimer);
            drawTimer = setInterval(async ()=>{
                if(idx>=nums.length){
                    clearInterval(drawTimer);
                    await db.ref(`rooms/${activeRoom}`).update({ status: ROOM_STATUS.END });
                    return;
                }
                const n = nums[idx++];
                const ref = db.ref(`rooms/${activeRoom}/draw`);
                const snap = await ref.once('value');
                const d = snap.val()||{history:[]};
                const hist = d.history || [];
                hist.push(n);
                await ref.update({ current:n, history:hist });
                applyAutoTickForNumber(n, hist);
                await tryAutoClaims();
            }, DRAW_INTERVAL_MS);
        }

        function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
        function applyAutoTickForNumber(n, hist){
            const doAuto = autoTickToggle.checked;
            if(!doAuto || !currentGrid || !currentTicketGameId) return;
            const ticksNow = JSON.parse(localStorage.getItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId)||'[]');
            const cells = ticketEl.querySelectorAll('.ticket-cell');
            cells.forEach(c=>{
                const val = Number(c.textContent);
                if(!isNaN(val) && val === n){
                    if(!c.classList.contains('ticked')) c.classList.add('ticked');
                    if(!ticksNow.includes(n)) { ticksNow.push(n); }
                }
            });
            localStorage.setItem(LS_TICKET_TICKS_PREFIX + currentTicketGameId, JSON.stringify(ticksNow));
        }

        if(createRoomBtn) createRoomBtn.addEventListener('click', createRoom);
        if(joinRoomBtn) joinRoomBtn.addEventListener('click', ()=> {
            joinRoomIdInput.style.display = 'block';
            joinRoomBtn.textContent = 'Join Room';
            joinRoomBtn.onclick = () => joinRoomById(joinRoomIdInput.value.trim());
        });
        if(roomBuyTicketBtn) roomBuyTicketBtn.addEventListener('click', roomBuyTicket);
        if(startRoomGameBtn) startRoomGameBtn.addEventListener('click', startRoomGame);

        ensureGuest();
        attachPresence();
        uiSetRoomStatus('No Room');
        userTicketContainer.style.display='none';
        latestNumber.textContent='‚Äî';
        historyEl.textContent='None';
        
        window.addEventListener('beforeunload', ()=>{
            try{
                if(myPresence) myPresence.remove();
                if(activeRoom) db.ref(`rooms/${activeRoom}/players/${(localStorage.getItem(LS_UID)||'guest')}`).remove();
            }catch(e){}
        });
        
        (function(){
            let VOICE_ENABLED = true;
            let lastSpoken = null;
            let _primed = false;
        
            function primeVoice(){
                if (_primed) return;
                try {
                    const dummy = new SpeechSynthesisUtterance('');
                    window.speechSynthesis.speak(dummy);
                    _primed = true;
                } catch(e){}
            }
            window.addEventListener('click', primeVoice, { once:true, passive:true });
            window.addEventListener('touchstart', primeVoice, { once:true, passive:true });
        
            const tambolaDialog = {
                1: "single number, one, top of the house", 3: "single number, three, ‡§∏‡§¨ ‡§ó‡•ã‡§≤‡§Æ‡§æ‡§≤ ‡§π‡•à", 4: "single number, four, ‡§Æ‡•Å‡§∞‡•ç‡§ó‡•Ä ‡§ö‡•ã‡§∞", 5: "single number, five, ‡§Ø‡•á ‡§®‡§Ç‡§¨‡§∞ ‡§Æ‡•Å‡§ù‡•á ‡§¶‡•á ‡§¶‡•á ‡§†‡§æ‡§ï‡•Å‡§∞",
                7: "single number seven, lucky for all, ‡§∏‡§æ‡§§ ‡§´‡•á‡§∞‡•á", 10: "Badmash", 19: "one nine, nineteen, Last of the teen", 21: "two one, twenty one, marriageable age",
                24: "‡§¶‡§ø‡§≤ ‡§ï‡§æ ‡§ö‡•ã‡§∞, two and four, twenty four", 25: "silver jubilee", 26: "republic day", 28: "pull the gate", 29: "rise and shine",
                36: "flirty wife", 41: "Alli Baba, ‡§ö‡§æ‡§≤‡•Ä‡§∏ ‡§ö‡•ã‡§∞", 46: "choke chhke", 47: "four and seven, forty seven, Aajadi", 48: "door and gate, forty eight",
                50: "Golden Jubilee", 53: "smile is free, five and three, fifty three", 65: "‡§≤‡§æ‡§ñ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§π‡•à ‡§Æ‡•á‡§∞‡•Ä wife", 66: "all the sixes, six and six, all the six",
                69: "six and nine, sixty nine, Maje Maro yaro", 74: "open the door", 75: "shuru karo deive", 79: "old wine", 82: "down with flu",
                85: "I still live", 90: "last number of the house"
            };
        
            window.speakTambolaNumber = function(number) {
                if (!VOICE_ENABLED || !window.speechSynthesis) return;
                const msg = new SpeechSynthesisUtterance();
                msg.text = tambolaDialog[number] || `Number ${number}`;
                msg.lang = 'en-IN';
                msg.rate = 1 + Math.random() * 0.2;
                msg.pitch = 1 + Math.random() * 0.3;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(msg);
            };
        
            window.speakTambolaSentence = function(sentence){
                if (!VOICE_ENABLED || !window.speechSynthesis) return;
                const msg = new SpeechSynthesisUtterance(sentence);
                msg.lang='en-IN';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(msg);
            };
        
            const target = document.getElementById('latestNumber');
            if (target) {
                const obs = new MutationObserver(async () => {
                    const text = target.textContent || '';
                    const match = text.match(/(\d+)/);
                    if (!match) return;
                    const num = parseInt(match[1], 10);
                    if (!num) return;
                    speakTambolaNumber(num);
                    const currentHistoryRef = activeRoom ? db.ref(`rooms/${activeRoom}/draw/history`) : currentGameRef.child('history');
                    const histSnapshot = await currentHistoryRef.once('value');
                    applyAutoTickForNumber(num, histSnapshot.val() || []);
                    await tryAutoClaims();
                });
                obs.observe(target, { childList:true, characterData:true, subtree:true });
            }
        })();
        
        (function(){
            watchLiveBtn.addEventListener('click', function(){
                const VIDEO_ID = "YOUR_YOUTUBE_LIVE_VIDEO_ID";
                if(!VIDEO_ID || VIDEO_ID === "YOUR_YOUTUBE_LIVE_VIDEO_ID"){
                    alert("Please set your YouTube Live Video ID in the code (replace YOUR_YOUTUBE_LIVE_VIDEO_ID).");
                    return;
                }
                liveFrame.src = "https://www.youtube.com/embed/" + VIDEO_ID + "?autoplay=1&rel=0";
                liveVideoBox.style.display = "block";
                watchLiveBtn.style.display = "none";
            });
        })();
        
        let isUserMuted = false;
        
        musicRef.on("value", snap=>{
            const data = snap.val()||{};
            if(!data.url) return;
            if(player.src !== data.url) player.src = data.url;
            if(data.isPlaying && !isUserMuted){
                player.play().catch(()=>{});
            } else {
                player.pause();
            }
        });
        
        musicBtn.addEventListener("click", ()=>{
            if(player.paused){
                isUserMuted = false;
                player.play().catch(()=>{});
                musicBtn.style.opacity="1";
            } else {
                isUserMuted = true;
                player.pause();
                musicBtn.style.opacity="0.5";
            }
        });
        
        // Final logic to check login status and show the correct UI
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // User is already logged in, skip the animation
                document.getElementById('initialScreen').style.display = 'none';
                document.getElementById('mainAppUI').style.display = 'block';
                applyAuthUser(user);
            } else {
                // User is not logged in, show the animation and login box
                // The animation's onComplete handles showing the login box
                // and then the main app UI after successful login.
            }
        });
    </script>
</body>
</html>
